class Wt{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,s,i,r,n,h,l){const o=this.engine;if(o.supportsUniformBuffers)for(const f in t)e.bindUniformBlock(f,t[f]);this.engine.getUniforms(this,s).forEach((f,_)=>{i[s[_]]=f}),this._uniforms=i;let u;for(u=0;u<r.length;u++)e.getUniform(r[u])==null&&(r.splice(u,1),u--);r.forEach((f,_)=>{n[f]=_});for(const f of o.getAttributes(this,h))l.push(f)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const s=this._valueCache[e],i=t.updateFlag;return s!==void 0&&s===i?!1:(this._valueCache[e]=i,!0)}_cacheFloat2(e,t,s){let i=this._valueCache[e];if(!i||i.length!==2)return i=[t,s],this._valueCache[e]=i,!0;let r=!1;return i[0]!==t&&(i[0]=t,r=!0),i[1]!==s&&(i[1]=s,r=!0),r}_cacheFloat3(e,t,s,i){let r=this._valueCache[e];if(!r||r.length!==3)return r=[t,s,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==s&&(r[1]=s,n=!0),r[2]!==i&&(r[2]=i,n=!0),n}_cacheFloat4(e,t,s,i,r){let n=this._valueCache[e];if(!n||n.length!==4)return n=[t,s,i,r],this._valueCache[e]=n,!0;let h=!1;return n[0]!==t&&(n[0]=t,h=!0),n[1]!==s&&(n[1]=s,h=!0),n[2]!==i&&(n[2]=i,h=!0),n[3]!==r&&(n[3]=r,h=!0),h}setInt(e,t){const s=this._valueCache[e];s!==void 0&&s===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,s){this._cacheFloat2(e,t,s)&&(this.engine.setInt2(this._uniforms[e],t,s)||(this._valueCache[e]=null))}setInt3(e,t,s,i){this._cacheFloat3(e,t,s,i)&&(this.engine.setInt3(this._uniforms[e],t,s,i)||(this._valueCache[e]=null))}setInt4(e,t,s,i,r){this._cacheFloat4(e,t,s,i,r)&&(this.engine.setInt4(this._uniforms[e],t,s,i,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const s=this._valueCache[e];s!==void 0&&s===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,s){this._cacheFloat2(e,t,s)&&(this.engine.setUInt2(this._uniforms[e],t,s)||(this._valueCache[e]=null))}setUInt3(e,t,s,i){this._cacheFloat3(e,t,s,i)&&(this.engine.setUInt3(this._uniforms[e],t,s,i)||(this._valueCache[e]=null))}setUInt4(e,t,s,i,r){this._cacheFloat4(e,t,s,i,r)&&(this.engine.setUInt4(this._uniforms[e],t,s,i,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const s=this._valueCache[e];s!==void 0&&s===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,s){this._cacheFloat2(e,t,s)&&(this.engine.setFloat2(this._uniforms[e],t,s)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,s,i){this._cacheFloat3(e,t,s,i)&&(this.engine.setFloat3(this._uniforms[e],t,s,i)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,s,i,r){this._cacheFloat4(e,t,s,i,r)&&(this.engine.setFloat4(this._uniforms[e],t,s,i,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,s){this._cacheFloat4(e,t.r,t.g,t.b,s)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,s)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}const je={};function Z(a,e=!1){if(!(e&&je[a]))return je[a]=!0,`${a} needs to be imported before as it contains a side-effect required by your code.`}function X(){return typeof window<"u"}function Xt(){return typeof navigator<"u"}function we(){return typeof document<"u"}function Kt(a){let e="",t=a.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const Le={};function mt(a,e,t=""){return t+(e?e+`
`:"")+a}function bt(a,e,t,s,i,r,n){const h=n||Le.loadFile;if(h)return h(a,e,t,s,i,r);throw Z("FileTools")}function xt(a,e,t,s){if(a){e?a.IS_NDC_HALF_ZRANGE="":delete a.IS_NDC_HALF_ZRANGE,t?a.USE_REVERSE_DEPTHBUFFER="":delete a.USE_REVERSE_DEPTHBUFFER,s?a.USE_EXACT_SRGB_CONVERSIONS="":delete a.USE_EXACT_SRGB_CONVERSIONS;return}else{let i="";return e&&(i+="#define IS_NDC_HALF_ZRANGE"),t&&(i&&(i+=`
`),i+="#define USE_REVERSE_DEPTHBUFFER"),s&&(i&&(i+=`
`),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}function Ei(a,e,t=!1,s){switch(a){case 3:return e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);case 0:return e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);case 4:return e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);case 5:case 8:case 9:case 10:case 2:return e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);case 6:return e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);case 7:case 11:case 12:case 13:case 14:case 15:return e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);case 1:return e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e)}return e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e)}const Oe=new WeakMap,zt={_webGLVersion:2,cachedPipelines:{}};function H(a){let e=Oe.get(a);if(!e){if(!a)return zt;e={_webGLVersion:a.TEXTURE_BINDING_3D?2:1,_context:a,parallelShaderCompile:a.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},Oe.set(a,e)}return e}function ve(a){Oe.delete(a)}function Et(a,e,t,s,i,r){const n=H(s);r||(r=n._createShaderProgramInjection??We);const h=Ue(e,"vertex",s,n._contextWasLost),l=Ue(t,"fragment",s,n._contextWasLost);return r(a,h,l,s,i,n.validateShaderPrograms)}function Tt(a,e,t,s,i,r=null,n){const h=H(i);n||(n=h._createShaderProgramInjection??We);const l=h._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",o=qe(e,"vertex",s,l,i,h._contextWasLost),c=qe(t,"fragment",s,l,i,h._contextWasLost);return n(a,o,c,i,r,h.validateShaderPrograms)}function Yt(a,e){const t=new Wt,s=H(a);return s.parallelShaderCompile&&!s.disableParallelShaderCompile&&(t.isParallelCompiled=!0),t.context=s._context,t}function We(a,e,t,s,i=null,r){const n=s.createProgram();if(a.program=n,!n)throw new Error("Unable to create program");return s.attachShader(n,e),s.attachShader(n,t),s.linkProgram(n),a.context=s,a.vertexShader=e,a.fragmentShader=t,a.isParallelCompiled||Xe(a,s,r),n}function $t(a,e,t){const s=a;if(s._isDisposed)return!1;const i=H(e);return i&&i.parallelShaderCompile&&i.parallelShaderCompile.COMPLETION_STATUS_KHR&&s.program&&e.getProgramParameter(s.program,i.parallelShaderCompile.COMPLETION_STATUS_KHR)?(Xe(s,e,t),!0):!1}function Xe(a,e,t){const s=a.context,i=a.vertexShader,r=a.fragmentShader,n=a.program;if(!s.getProgramParameter(n,s.LINK_STATUS)){if(!e.getShaderParameter(i,e.COMPILE_STATUS)){const o=e.getShaderInfoLog(i);if(o)throw a.vertexCompilationError=o,new Error("VERTEX SHADER "+o)}if(!e.getShaderParameter(r,e.COMPILE_STATUS)){const o=e.getShaderInfoLog(r);if(o)throw a.fragmentCompilationError=o,new Error("FRAGMENT SHADER "+o)}const l=s.getProgramInfoLog(n);if(l)throw a.programLinkError=l,new Error(l)}if(t&&(s.validateProgram(n),!s.getProgramParameter(n,s.VALIDATE_STATUS))){const o=s.getProgramInfoLog(n);if(o)throw a.programValidationError=o,new Error(o)}s.deleteShader(i),s.deleteShader(r),a.vertexShader=void 0,a.fragmentShader=void 0,a.onCompiled&&(a.onCompiled(),a.onCompiled=void 0)}function jt(a,e,t,s,i,r,n,h,l,o="",c,u,f){const _=H(a.context);u||(u=_.createRawShaderProgramInjection??Et),f||(f=_.createShaderProgramInjection??Tt);const g=a;s?g.program=u(g,e,t,g.context,l):g.program=f(g,e,t,h,g.context,l),g.program.__SPECTOR_rebuildProgram=n,c()}function qe(a,e,t,s,i,r){return Ue(mt(a,t,s),e,i,r)}function Ue(a,e,t,s){const i=t.createShader(e==="vertex"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(!i){let r=t.NO_ERROR,n=t.NO_ERROR;for(;(n=t.getError())!==t.NO_ERROR;)r=n;throw new Error(`Something went wrong while creating a gl ${e} shader object. gl error=${r}, gl isContextLost=${t.isContextLost()}, _contextWasLost=${s}`)}return t.shaderSource(i,a),t.compileShader(i),i}function qt(a,e){e.useProgram(a)}function Zt(a,e){const t=a;if(!t.isParallelCompiled){e(a);return}const s=t.onCompiled;t.onCompiled=()=>{s?.(),e(a)}}function Qt(a){return a.getPipelineContext===void 0}class m{static _CheckLimit(e,t){let s=m._LogLimitOutputs[e];return s?s.current++:(s={limit:t,current:1},m._LogLimitOutputs[e]=s),s.current<=s.limit}static _GenerateLimitMessage(e,t=1){const s=m._LogLimitOutputs[e];if(!s||!m.MessageLimitReached)return;const i=this._Levels[t];s.current===s.limit&&m[i.name](m.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,i.name??""))}static _AddLogEntry(e){m._LogCache=e+m._LogCache,m.OnNewCacheEntry&&m.OnNewCacheEntry(e)}static _FormatMessage(e){const t=i=>i<10?"0"+i:""+i,s=new Date;return"["+t(s.getHours())+":"+t(s.getMinutes())+":"+t(s.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,s){const i=Array.isArray(t)?t[0]:t;if(s!==void 0&&!m._CheckLimit(i,s))return;const r=m._FormatMessage(i),n=this._Levels[e],h=Array.isArray(t)?t.slice(1):[];n.logFunc&&n.logFunc("BJS - "+r,...h);const l=`<div style='color:${n.color}'>${r}</div><br>`;m._AddLogEntry(l),m._GenerateLimitMessage(i,e)}static get LogCache(){return m._LogCache}static ClearLogCache(){m._LogCache="",m._LogLimitOutputs={},m.errorsCount=0}static set LogLevels(e){m.Log=m._LogDisabled,m.Warn=m._LogDisabled,m.Error=m._LogDisabled;const t=[m.MessageLogLevel,m.WarningLogLevel,m.ErrorLogLevel];for(const s of t)if((e&s)===s){const i=this._Levels[s];m[i.name]=m._LogEnabled.bind(m,s)}}}m.NoneLogLevel=0;m.MessageLogLevel=1;m.WarningLogLevel=2;m.ErrorLogLevel=4;m.AllLogLevel=7;m.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";m._LogCache="";m._LogLimitOutputs={};m._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];m.errorsCount=0;m.Log=m._LogEnabled.bind(m,m.MessageLogLevel);m.Warn=m._LogEnabled.bind(m,m.WarningLogLevel);m.Error=m._LogEnabled.bind(m,m.ErrorLogLevel);class Jt{constructor(){this.shaderLanguage=0}postProcessor(e,t,s,i,r){if(r.drawBuffersExtensionDisabled){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}const es=/(flat\s)?\s*varying\s*.*/;class ts{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return es.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,s){const i=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,r=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(r,""),e=e.replace(/texture2D\s*\(/g,"texture("),s){const n=e.search(/layout *\(location *= *0\) *out/g)!==-1,h=t.indexOf("#define DUAL_SOURCE_BLENDING")!==-1,l=h?`layout(location = 0, index = 0) out vec4 glFragColor;
layout(location = 0, index = 1) out vec4 glFragColor2;
`:`layout(location = 0) out vec4 glFragColor;
`;h&&(e=`#extension GL_EXT_blend_func_extended : require
`+e),e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(i||n?"":l)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class de{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=de._Counter++}}de._Counter=0;class Ze extends de{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}function Ti(a){let e=1;do e*=2;while(e<a);return e===a}function Si(a,e,t){return a*(1-t)+e*t}function ss(a){const e=St(a),t=yt(a);return e-a>a-t?t:e}function St(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}function yt(a){return a=a|a>>1,a=a|a>>2,a=a|a>>4,a=a|a>>8,a=a|a>>16,a-(a>>1)}function Ee(a,e,t=2){let s;switch(t){case 1:s=yt(a);break;case 2:s=ss(a);break;case 3:default:s=St(a);break}return Math.min(s,e)}const is=typeof WeakRef<"u";class rs{constructor(e,t=!1,s,i){this.initialize(e,t,s,i)}initialize(e,t=!1,s,i){return this.mask=e,this.skipNextObservers=t,this.target=s,this.currentTarget=i,this}}class ns{constructor(e,t,s=null){this.callback=e,this.mask=t,this.scope=s,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(e=!1){this._remove&&this._remove(e)}}class B{static FromPromise(e,t){const s=new B;return e.then(i=>{s.notifyObservers(i)}).catch(i=>{if(t)t.notifyObservers(i);else throw i}),s}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new rs(0),e&&(this._onObserverAdded=e)}add(e,t=-1,s=!1,i=null,r=!1){if(!e)return null;const n=new ns(e,t,i);n.unregisterOnNextCall=r,s?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(n,this._lastNotifiedValue);const h=is?new WeakRef(this):{deref:()=>this};return n._remove=(l=!1)=>{const o=h.deref();o&&(l?o.remove(n):o._remove(n))},n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let s=0;s<this._observers.length;s++){const i=this._observers[s];if(!i._willBeUnregistered&&i.callback===e&&(!t||t===i.scope))return this._deferUnregister(i),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const s=this._observers.indexOf(e);return s!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(s,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,s,i,r){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=s,n.currentTarget=i,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=r;for(const h of this._observers)if(!h._willBeUnregistered&&(h.mask&t&&(h.unregisterOnNextCall&&this._deferUnregister(h),h.scope?n.lastReturnValue=h.callback.apply(h.scope,[e,n]):n.lastReturnValue=h.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,s=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const i=this._eventState;i.mask=s,i.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,i)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new B;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class G{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}G.Instances=[];G.OnEnginesDisposedObservable=new B;G._LastCreatedScene=null;G.UseFallbackTexture=!0;G.FallbackTexture="";class y{static GetShadersRepository(e=0){return e===0?y.ShadersRepository:y.ShadersRepositoryWGSL}static GetShadersStore(e=0){return e===0?y.ShadersStore:y.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return e===0?y.IncludesShadersStore:y.IncludesShadersStoreWGSL}}y.ShadersRepository="src/Shaders/";y.ShadersStore={};y.IncludesShadersStore={};y.ShadersRepositoryWGSL="src/ShadersWGSL/";y.ShadersStoreWGSL={};y.IncludesShadersStoreWGSL={};const as="attribute",hs="varying";class ge{constructor(){this.children=[]}isValid(e){return!0}process(e,t,s){let i="";if(this.line){let r=this.line;const n=t.processor;if(n){n.lineProcessor&&(r=n.lineProcessor(r,t.isFragment,t.processingContext));const h=t.processor?.attributeKeywordName??as,l=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:hs;!t.isFragment&&n.attributeProcessor&&this.line.startsWith(h)?r=n.attributeProcessor(this.line,e,t.processingContext):n.varyingProcessor&&(n.varyingCheck?.(this.line,t.isFragment)||!n.varyingCheck&&this.line.startsWith(l))?r=n.varyingProcessor(this.line,t.isFragment,e,t.processingContext):n.uniformProcessor&&n.uniformRegexp&&n.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(r=n.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):n.uniformBufferProcessor&&n.uniformBufferRegexp&&n.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(r=n.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):n.textureProcessor&&n.textureRegexp&&n.textureRegexp.test(this.line)?r=n.textureProcessor(this.line,t.isFragment,e,t.processingContext):(n.uniformProcessor||n.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?n.uniformProcessor&&(r=n.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):n.uniformBufferProcessor&&(r=n.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,n.endOfUniformBufferProcessor&&(r=n.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=r+`
`}for(const r of this.children)i+=r.process(e,t,s);return this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true",s[this.additionalDefineKey]=e[this.additionalDefineKey]),i}}class ls{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}const s=t.trim();if(!s)continue;if(s.startsWith("//")){this._lines.push(t);continue}const i=s.indexOf(";");if(i===-1)this._lines.push(s);else if(i===s.length-1)s.length>1&&this._lines.push(s);else{const r=t.split(";");for(let n=0;n<r.length;n++){let h=r[n];h&&(h=h.trim(),h&&this._lines.push(h+(n!==r.length-1?";":"")))}}}}}class Ie extends ge{process(e,t,s){for(let i=0;i<this.children.length;i++){const r=this.children[i];if(r.isValid(e))return r.process(e,t,s)}return""}}class os extends ge{isValid(e){return this.testExpression.isTrue(e)}}class F{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const s of e)if(F._OperatorPriority[s]===void 0)t.push(s);else{const i=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${s}${i})`)}return t[t.length-1]}static infixToPostfix(e){const t=F._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const s=[];let i=-1;const r=()=>{c=c.trim(),c!==""&&(s.push(c),c="")},n=u=>{i<F._Stack.length-1&&(F._Stack[++i]=u)},h=()=>F._Stack[i],l=()=>i===-1?"!!INVALID EXPRESSION!!":F._Stack[i--];let o=0,c="";for(;o<e.length;){const u=e.charAt(o),f=o<e.length-1?e.substring(o,2+o):"";if(u==="(")c="",n(u);else if(u===")"){for(r();i!==-1&&h()!=="(";)s.push(l());l()}else if(F._OperatorPriority[f]>1){for(r();i!==-1&&F._OperatorPriority[h()]>=F._OperatorPriority[f];)s.push(l());n(f),o++}else c+=u;o++}for(r();i!==-1;)h()==="("?l():s.push(l());return F._InfixToPostfixCache.size>=F.InfixToPostfixCacheLimitSize&&F.ClearCache(),F._InfixToPostfixCache.set(e,{result:s,accessTime:Date.now()}),s}static ClearCache(){const e=Array.from(F._InfixToPostfixCache.entries()).sort((t,s)=>t[1].accessTime-s[1].accessTime);for(let t=0;t<F.InfixToPostfixCacheCleanupSize;t++)F._InfixToPostfixCache.delete(e[t][0])}}F.InfixToPostfixCacheLimitSize=5e4;F.InfixToPostfixCacheCleanupSize=25e3;F._InfixToPostfixCache=new Map;F._OperatorPriority={")":0,"(":1,"||":2,"&&":3};F._Stack=["","","","","","","","","","","","","","","","","","","",""];class Te extends F{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class cs extends F{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class us extends F{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class _s extends F{constructor(e,t,s){super(),this.define=e,this.operand=t,this.testValue=s}toString(){return`${this.define} ${this.operand} ${this.testValue}`}isTrue(e){let t=!1;const s=parseInt(e[this.define]!=null?e[this.define]:this.define),i=parseInt(e[this.testValue]!=null?e[this.testValue]:this.testValue);if(isNaN(s)||isNaN(i))return!1;switch(this.operand){case">":t=s>i;break;case"<":t=s<i;break;case"<=":t=s<=i;break;case">=":t=s>=i;break;case"==":t=s===i;break;case"!=":t=s!==i;break}return t}}const fs=/defined\s*?\((.+?)\)/g,Pe=/defined\s*?\[(.+?)\]/g,ds=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,gs=/__decl__/,Qe=/light\{X\}.(\w*)/g,Je=/\{X\}/g,pe=[],ps=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function ms(a){a.processor&&a.processor.initializeShaders&&a.processor.initializeShaders(a.processingContext)}function et(a,e,t,s){e.processor?.preProcessShaderCode&&(a=e.processor.preProcessShaderCode(a,e.isFragment)),ke(a,e,i=>{e.processCodeAfterIncludes&&(i=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",i,e.defines));const r=ys(i,e,s);t(r,i)})}function bs(a,e,t){return!t.processor||!t.processor.finalizeShaders?{vertexCode:a,fragmentCode:e}:t.processor.finalizeShaders(a,e,t.processingContext)}function xs(a,e){if(e.processor?.noPrecision)return a;const t=e.shouldUseHighPrecisionShader;return a.indexOf("precision highp float")===-1?t?a=`precision highp float;
`+a:a=`precision mediump float;
`+a:t||(a=a.replace("precision highp float","precision mediump float")),a}function De(a){const t=/defined\((.+)\)/.exec(a);if(t&&t.length)return new Te(t[1].trim(),a[0]==="!");const s=["==","!=",">=","<=","<",">"];let i="",r=0;for(i of s)if(r=a.indexOf(i),r>-1)break;if(r===-1)return new Te(a);const n=a.substring(0,r).trim(),h=a.substring(r+i.length).trim();return new _s(n,i,h)}function Es(a){a=a.replace(fs,"defined[$1]");const e=F.infixToPostfix(a),t=[];for(const i of e)if(i!=="||"&&i!=="&&")t.push(i);else if(t.length>=2){let r=t[t.length-1],n=t[t.length-2];t.length-=2;const h=i=="&&"?new us:new cs;typeof r=="string"&&(r=r.replace(Pe,"defined($1)")),typeof n=="string"&&(n=n.replace(Pe,"defined($1)")),h.leftOperand=typeof n=="string"?De(n):n,h.rightOperand=typeof r=="string"?De(r):r,t.push(h)}let s=t[t.length-1];return typeof s=="string"&&(s=s.replace(Pe,"defined($1)")),typeof s=="string"?De(s):s}function xe(a,e){const t=new os,s=a.substring(0,e);let i=a.substring(e);return i=i.substring(0,(i.indexOf("//")+1||i.length+1)-1).trim(),s==="#ifdef"?t.testExpression=new Te(i):s==="#ifndef"?t.testExpression=new Te(i,!0):t.testExpression=Es(i),t}function Be(a,e,t,s){let i=a.currentLine;for(;Ge(a,t);){i=a.currentLine;const r=i.substring(0,5).toLowerCase();if(r==="#else"){const n=new ge;e.children.push(n),Ge(a,n);return}else if(r==="#elif"){const n=xe(i,5);e.children.push(n),t=n}}}function Ge(a,e,t){for(;a.canRead;){a.lineIndex++;const s=a.currentLine;if(s.indexOf("#")>=0){const r=ps.exec(s);if(r&&r.length){switch(r[0]){case"#ifdef":{const h=new Ie;e.children.push(h);const l=xe(s,6);h.children.push(l),Be(a,h,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const h=new Ie;e.children.push(h);const l=xe(s,7);h.children.push(l),Be(a,h,l);break}case"#if":{const h=new Ie,l=xe(s,3);e.children.push(h),h.children.push(l),Be(a,h,l);break}}continue}}const i=new ge;if(i.line=s,e.children.push(i),s[0]==="#"&&s[1]==="d"){const r=s.replace(";","").split(" ");i.additionalDefineKey=r[1],r.length===3&&(i.additionalDefineValue=r[2])}}return!1}function Ts(a,e,t,s){const i=new ge,r=new ls;return r.lineIndex=-1,r.lines=a.split(`
`),Ge(r,i),i.process(e,t,s)}function Ss(a,e){const t=a.defines,s={};for(const i of t){const n=i.replace("#define","").replace(";","").trim().split(" ");s[n[0]]=n.length>1?n[1]:""}return a.processor?.shaderLanguage===0&&(s.GL_ES="true"),s.__VERSION__=a.version,s[a.platformName]="true",xt(s,e?.isNDCHalfZRange,e?.useReverseDepthBuffer,e?.useExactSrgbConversions),s}function ys(a,e,t){let s=xs(a,e);if(!e.processor||e.processor.shaderLanguage===0&&s.indexOf("#version 3")!==-1&&(s=s.replace("#version 300 es",""),!e.processor.parseGLES3))return s;const i=e.defines,r=Ss(e,t);e.processor.preProcessor&&(s=e.processor.preProcessor(s,i,r,e.isFragment,e.processingContext));const n={};return s=Ts(s,r,e,n),e.processor.postProcessor&&(s=e.processor.postProcessor(s,i,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{},r,n)),t?._features.needShaderCodeInlining&&(s=t.inlineShaderCode(s)),s}function ke(a,e,t){pe.length=0;let s;for(;(s=ds.exec(a))!==null;)pe.push(s);let i=String(a),r=[a],n=!1;for(const h of pe){let l=h[1];if(l.indexOf("__decl__")!==-1&&(l=l.replace(gs,""),e.supportsUniformBuffers&&(l=l.replace("Vertex","Ubo").replace("Fragment","Ubo")),l=l+"Declaration"),e.includesShadersStore[l]){let o=e.includesShadersStore[l];if(h[2]){const u=h[3].split(",");for(let f=0;f<u.length;f+=2){const _=new RegExp(u[f],"g"),g=u[f+1];o=o.replace(_,g)}}if(h[4]){const u=h[5];if(u.indexOf("..")!==-1){const f=u.split(".."),_=parseInt(f[0]);let g=parseInt(f[1]),T=o.slice(0);o="",isNaN(g)&&(g=e.indexParameters[f[1]]);for(let b=_;b<g;b++)e.supportsUniformBuffers||(T=T.replace(Qe,(d,p)=>p+"{X}")),o+=T.replace(Je,b.toString())+`
`}else e.supportsUniformBuffers||(o=o.replace(Qe,(f,_)=>_+"{X}")),o=o.replace(Je,u)}const c=[];for(const u of r){const f=u.split(h[0]);for(let _=0;_<f.length-1;_++)c.push(f[_]),c.push(o);c.push(f[f.length-1])}r=c,n=n||o.indexOf("#include<")>=0||o.indexOf("#include <")>=0}else{const o=e.shadersRepository+"ShadersInclude/"+l+".fx";Rs.loadFile(o,c=>{e.includesShadersStore[l]=c,ke(r.join(""),e,t)});return}}pe.length=0,i=r.join(""),n?ke(i.toString(),e,t):t(i)}const Rs={loadFile:(a,e,t,s,i,r)=>{throw Z("FileTools")}};function As(a,e){return H(e).cachedPipelines[a]}function Rt(a){const e=a._name,t=a.context;if(e&&t){const s=H(t);s.cachedPipelines[e]?.dispose(),delete s.cachedPipelines[e]}}function Cs(a,e,t,s,i,r,n){let h,l;const o=X()?r?.getHostDocument():null;typeof e=="string"?h=e:e.vertexSource?h="source:"+e.vertexSource:e.vertexElement?h=o?.getElementById(e.vertexElement)||e.vertexElement:h=e.vertex||e,typeof e=="string"?l=e:e.fragmentSource?l="source:"+e.fragmentSource:e.fragmentElement?l=o?.getElementById(e.fragmentElement)||e.fragmentElement:l=e.fragment||e;const c=[void 0,void 0],u=()=>{if(c[0]&&c[1]){a.isFragment=!0;const[f,_]=c;et(_,a,(g,T)=>{n&&(n._fragmentSourceCodeBeforeMigration=T),t&&(g=t("fragment",g));const b=bs(f,g,a);a=null;const d=Fs(b.vertexCode,b.fragmentCode,e,i);s?.(d.vertexSourceCode,d.fragmentSourceCode)},r)}};tt(h,"Vertex","",f=>{ms(a),et(f,a,(_,g)=>{n&&(n._rawVertexSourceCode=f,n._vertexSourceCodeBeforeMigration=g),t&&(_=t("vertex",_)),c[0]=_,u()},r)},i),tt(l,"Fragment","Pixel",f=>{n&&(n._rawFragmentSourceCode=f),c[1]=f,u()},i)}function tt(a,e,t,s,i,r){if(typeof HTMLElement<"u"&&a instanceof HTMLElement){const l=Kt(a);s(l);return}if(a.substring(0,7)==="source:"){s(a.substring(7));return}if(a.substring(0,7)==="base64:"){const l=window.atob(a.substring(7));s(l);return}const n=y.GetShadersStore(i);if(n[a+e+"Shader"]){s(n[a+e+"Shader"]);return}if(t&&n[a+t+"Shader"]){s(n[a+t+"Shader"]);return}let h;if(a[0]==="."||a[0]==="/"||a.indexOf("http")>-1?h=a:h=y.GetShadersRepository(i)+a,r=r||bt,!r)throw new Error("loadFileInjection is not defined");r(h+"."+e.toLowerCase()+".fx",s)}function Fs(a,e,t,s){if(t){const i=t.vertexElement||t.vertex||t.spectorName||t,r=t.fragmentElement||t.fragment||t.spectorName||t;return{vertexSourceCode:(s===1?"//":"")+"#define SHADER_NAME vertex:"+i+`
`+a,fragmentSourceCode:(s===1?"//":"")+"#define SHADER_NAME fragment:"+r+`
`+e}}else return{vertexSourceCode:a,fragmentSourceCode:e}}const ws=(a,e,t,s)=>{try{const i=a.context?H(a.context):null;i&&(i.disableParallelShaderCompile=a.disableParallelCompilation);const r=a.existingPipelineContext||e(a.shaderProcessingContext);return r._name=a.name,a.name&&i&&(i.cachedPipelines[a.name]=r),t(r,a.vertex,a.fragment,!!a.createAsRaw,"","",a.rebuildRebind,a.defines,a.transformFeedbackVaryings,"",()=>{s(r,()=>{a.onRenderingStateCompiled?.(r)})}),r}catch(i){throw m.Error("Error compiling effect"),i}};let me=[];class vs{static SetImmediate(e){me.length===0&&setTimeout(()=>{const t=me;me=[];for(const s of t)s()},1),me.push(e)}}function st(a,e,t){try{if(a())return e(),!0}catch(s){return t?.(s),!0}return!1}const Is=(a,e,t,s=16,i=3e4,r=!0,n)=>{if(r&&st(a,e,t))return null;const h=setInterval(()=>{st(a,e,t)?clearInterval(h):(i-=s,i<0&&(clearInterval(h),t?.(new Error("Operation timed out after maximum retries. "+(n||"")),!0)))},s);return()=>clearInterval(h)};class L{static get ShadersRepository(){return y.ShadersRepository}static set ShadersRepository(e){y.ShadersRepository=e}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new B),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,s,i=null,r,n=null,h=null,l=null,o=null,c,u="",f=0,_){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new B,this.onErrorObservable=new B,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=!1,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=u;const g=this._key.replace(/\r/g,"").replace(/\n/g,"|");let T;if(t.attributes){const b=t;if(this._engine=s,this._attributesNames=b.attributes,this._uniformsNames=b.uniformsNames.concat(b.samplers),this._samplerList=b.samplers.slice(),this.defines=b.defines,this.onError=b.onError,this.onCompiled=b.onCompiled,this._fallbacks=b.fallbacks,this._indexParameters=b.indexParameters,this._transformFeedbackVaryings=b.transformFeedbackVaryings||null,this._multiTarget=!!b.multiTarget,this._shaderLanguage=b.shaderLanguage??0,this._disableParallelShaderCompilation=!!b.disableParallelShaderCompilation,b.uniformBuffersNames){this._uniformBuffersNamesList=b.uniformBuffersNames.slice();for(let d=0;d<b.uniformBuffersNames.length;d++)this._uniformBuffersNames[b.uniformBuffersNames[d]]=d}this._processFinalCode=b.processFinalCode??null,this._processCodeAfterIncludes=b.processCodeAfterIncludes??void 0,_=b.extraInitializationsAsync,T=b.existingPipelineContext}else this._engine=r,this.defines=n??"",this._uniformsNames=s.concat(i),this._samplerList=i?i.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=f,this.onError=o,this.onCompiled=l,this._indexParameters=c,this._fallbacks=h;this._engine.shaderPlatformName==="WEBGL2"&&(T=As(g,this._engine._gl)??T),this._attributeLocationByName={},this.uniqueId=L._UniqueIdSeed++,T?(this._pipelineContext=T,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,_),this._engine.onReleaseEffectsObservable.addOnce(()=>{this.isDisposed||this.dispose(!0)})}async _processShaderCodeAsync(e=null,t=!1,s=null,i){i&&await i(),this._processingContext=s||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);const r={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:y.GetShadersRepository(this._shaderLanguage),includesShadersStore:y.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};Cs(r,this.name,this._processFinalCode,(n,h)=>{this._vertexSourceCode=n,this._fragmentSourceCode=h,this._prepareEffect(t)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._engine.isDisposed||this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}async whenCompiledAsync(){return await new Promise(e=>{this.executeWhenCompiled(e)})}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&this._checkIsReady(null)}_checkIsReady(e){Is(()=>this._isReadyInternal()||this._isDisposed,()=>{},t=>{this._processCompilationErrors(t,e)},16,12e4,!0,` - Effect: ${typeof this.name=="string"?this.name:this.key}`)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,s,i){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(r,n)=>{i&&i(n)},this.onCompiled=()=>{const r=this.getEngine().scenes;if(r)for(let n=0;n<r.length;n++)r[n].markAllMaterialsAsDirty(127);this._pipelineContext._handlesSpectorRebuildCallback?.(s)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let t=0;t<this._attributesNames.length;t++){const s=this._attributesNames[t];this._attributeLocationByName[s]=this._attributes[t]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),L.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(e=!1){const t=this._pipelineContext;this._isReady=!1;try{const s=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),i=s?null:this.defines,r=s?this._vertexSourceCodeOverride:this._vertexSourceCode,n=s?this._fragmentSourceCodeOverride:this._fragmentSourceCode,h=this._engine;this._pipelineContext=ws({existingPipelineContext:e?t:null,vertex:r,fragment:n,context:h.shaderPlatformName==="WEBGL2"||h.shaderPlatformName==="WEBGL1"?h._gl:void 0,rebuildRebind:(l,o,c,u)=>this._rebuildProgram(l,o,c,u),defines:i,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:s,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:l=>{t&&!e&&this._engine._deletePipelineContext(t),l&&this._onRenderingStateCompiled(l)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContextAsync.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(s){this._processCompilationErrors(s,t)}}_getShaderCodeAndErrorLine(e,t,s){const i=s?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(i);if(n&&n.length===2){const h=parseInt(n[1]),l=e.split(`
`,-1);l.length>=h&&(r=`Offending line [${h}] in ${s?"fragment":"vertex"} code: ${l[h-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){this._compilationError=e.message;const s=this._attributesNames,i=this._fallbacks;if(m.Error("Unable to compile effect:"),m.Error(`Uniforms: ${this._uniformsNames.join(" ")}`),m.Error(`Attributes: ${s.join(" ")}`),m.Error(`Defines:
`+this.defines),L.LogShaderCodeOnCompilationError){let n=null,h=null,l=null;this._pipelineContext?._getVertexShaderCode()&&([l,n]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),l&&(m.Error("Vertex code:"),m.Error(l))),this._pipelineContext?._getFragmentShaderCode()&&([l,h]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),l&&(m.Error("Fragment code:"),m.Error(l))),n&&m.Error(n),h&&m.Error(h)}m.Error("Error: "+this._compilationError);const r=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError})};t&&(this._pipelineContext=t,this._isReady=!0,r()),i?(this._pipelineContext=null,i.hasMoreFallbacks?(this._allFallbacksProcessed=!1,m.Error("Trying next fallback."),this.defines=i.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,r(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||r())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const s=e+"Ex";if(this._samplerList.indexOf(s+"0")===-1){const i=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const h=s+(n-1).toString();this._samplerList.splice(i+n,0,h)}let r=0;for(const n of this._samplerList)this._samplers[n]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){const s=this._uniformBuffersNames[t];s===void 0||L._BaseCache[s]===e&&this._engine._features.useUBOBindingCache||(L._BaseCache[s]=e,this._engine.bindUniformBufferBase(e,s,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,s){return this._pipelineContext.setInt2(e,t,s),this}setInt3(e,t,s,i){return this._pipelineContext.setInt3(e,t,s,i),this}setInt4(e,t,s,i,r){return this._pipelineContext.setInt4(e,t,s,i,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,s){return this._pipelineContext.setUInt2(e,t,s),this}setUInt3(e,t,s,i){return this._pipelineContext.setUInt3(e,t,s,i),this}setUInt4(e,t,s,i,r){return this._pipelineContext.setUInt4(e,t,s,i,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,s){return this._pipelineContext.setFloat2(e,t,s),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,s,i){return this._pipelineContext.setFloat3(e,t,s,i),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,s,i,r){return this._pipelineContext.setFloat4(e,t,s,i,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,s){return this._pipelineContext.setColor4(e,t,s),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(e=!1){if(e)this._refCount=0;else{if(L.PersistentMode)return;this._refCount--}this._refCount>0||this._isDisposed||(this._pipelineContext&&Rt(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(e,t,s,i=0){t&&(y.GetShadersStore(i)[`${e}PixelShader`]=t),s&&(y.GetShadersStore(i)[`${e}VertexShader`]=s)}static ResetCache(){L._BaseCache={}}}L.LogShaderCodeOnCompilationError=!0;L.PersistentMode=!1;L.AutomaticallyClearCodeCache=!1;L._UniqueIdSeed=0;L._BaseCache={};L.ShadersStore=y.ShadersStore;L.IncludesShadersStore=y.IncludesShadersStore;class V{static SetMatrixPrecision(e){if(V.MatrixTrackPrecisionChange=!1,e&&!V.MatrixUse64Bits&&V.MatrixTrackedMatrices)for(let t=0;t<V.MatrixTrackedMatrices.length;++t){const s=V.MatrixTrackedMatrices[t],i=s._m;s._m=new Array(16);for(let r=0;r<16;++r)s._m[r]=i[r]}V.MatrixUse64Bits=e,V.MatrixCurrentType=V.MatrixUse64Bits?Array:Float32Array,V.MatrixTrackedMatrices=null}}V.MatrixUse64Bits=!1;V.MatrixTrackPrecisionChange=!0;V.MatrixCurrentType=Float32Array;V.MatrixTrackedMatrices=[];class Ps{static get Now(){return X()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class Ds{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class Bs{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get backFunc(){return this._func}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._isStencilOpDirty=!0)}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._isStencilOpDirty=!0)}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){if(!e)return;const t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.backFunc=t?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backOpStencilFail=t?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=t?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=t?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFuncSeparate(e.FRONT,this.func,this.funcRef,this.funcMask),e.stencilFuncSeparate(e.BACK,this.backFunc,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOpSeparate(e.FRONT,this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),e.stencilOpSeparate(e.BACK,this.backOpStencilFail,this.backOpDepthFail,this.backOpStencilDepthPass),this._isStencilOpDirty=!1))}}class W{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.funcRef=1,this.funcMask=255,this.func=W.ALWAYS,this.opStencilFail=W.KEEP,this.opDepthFail=W.KEEP,this.opStencilDepthPass=W.REPLACE,this.backFunc=W.ALWAYS,this.backOpStencilFail=W.KEEP,this.backOpDepthFail=W.KEEP,this.backOpStencilDepthPass=W.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilBackFunc(){return this.backFunc}set stencilBackFunc(e){this.backFunc=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilBackOpStencilFail(){return this.backOpStencilFail}set stencilBackOpStencilFail(e){this.backOpStencilFail=e}get stencilBackOpDepthFail(){return this.backOpDepthFail}set stencilBackOpDepthFail(e){this.backOpDepthFail=e}get stencilBackOpStencilDepthPass(){return this.backOpStencilDepthPass}set stencilBackOpStencilDepthPass(e){this.backOpStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}W.ALWAYS=519;W.KEEP=7680;W.REPLACE=7681;class Ms{constructor(){this._blendFunctionParameters=new Array(4*8),this._blendEquationParameters=new Array(2*8),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=Array(8).fill(!1),this._numTargetEnabled=0,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._numTargetEnabled>0}setAlphaBlend(e,t=0){this._alphaBlend[t]!==e&&(e?this._numTargetEnabled++:this._numTargetEnabled--,this._alphaBlend[t]=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,s,i){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===s&&this._blendConstants[3]===i||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=s,this._blendConstants[3]=i,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,s,i,r=0){const n=r*4;this._blendFunctionParameters[n+0]===e&&this._blendFunctionParameters[n+1]===t&&this._blendFunctionParameters[n+2]===s&&this._blendFunctionParameters[n+3]===i||(this._blendFunctionParameters[n+0]=e,this._blendFunctionParameters[n+1]=t,this._blendFunctionParameters[n+2]=s,this._blendFunctionParameters[n+3]=i,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t,s=0){const i=s*2;this._blendEquationParameters[i+0]===e&&this._blendEquationParameters[i+1]===t||(this._blendEquationParameters[i+0]=e,this._blendEquationParameters[i+1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend.fill(!1),this._numTargetEnabled=0,this._blendFunctionParameters.fill(null),this._blendEquationParameters.fill(null),this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e,t=1){if(this.isDirty){if(this._isAlphaBlendDirty){if(t===1)this._alphaBlend[0]?e.enable(e.BLEND):e.disable(e.BLEND);else{const s=e;for(let i=0;i<t;i++){const r=i<this._numTargetEnabled?i:0;this._alphaBlend[r]?s.enableIndexed(e.BLEND,i):s.disableIndexed(e.BLEND,i)}}this._isAlphaBlendDirty=!1}if(this._isBlendFunctionParametersDirty){if(t===1)e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]);else{const s=e;for(let i=0;i<t;i++){const r=i<this._numTargetEnabled?i*4:0;s.blendFuncSeparateIndexed(i,this._blendFunctionParameters[r+0],this._blendFunctionParameters[r+1],this._blendFunctionParameters[r+2],this._blendFunctionParameters[r+3])}}this._isBlendFunctionParametersDirty=!1}if(this._isBlendEquationParametersDirty){if(t===1)e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]);else{const s=e;for(let i=0;i<t;i++){const r=i<this._numTargetEnabled?i*2:0;s.blendEquationSeparateIndexed(i,this._blendEquationParameters[r+0],this._blendEquationParameters[r+1])}}this._isBlendEquationParametersDirty=!1}this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1)}}setAlphaMode(e,t){let s=32774;switch(e){case 0:break;case 7:this.setAlphaBlendFunctionParameters(1,771,1,1,t);break;case 8:this.setAlphaBlendFunctionParameters(1,771,1,771,t);break;case 2:this.setAlphaBlendFunctionParameters(770,771,1,1,t);break;case 6:this.setAlphaBlendFunctionParameters(1,1,0,1,t);break;case 1:this.setAlphaBlendFunctionParameters(770,1,0,1,t);break;case 3:this.setAlphaBlendFunctionParameters(0,769,1,1,t),s=32778;break;case 4:this.setAlphaBlendFunctionParameters(774,0,1,1,t);break;case 5:this.setAlphaBlendFunctionParameters(770,769,1,1,t);break;case 9:this.setAlphaBlendFunctionParameters(32769,32770,32771,32772,t);break;case 10:this.setAlphaBlendFunctionParameters(1,769,1,771,t);break;case 11:this.setAlphaBlendFunctionParameters(1,1,1,1,t);break;case 12:this.setAlphaBlendFunctionParameters(772,1,0,0,t);break;case 13:this.setAlphaBlendFunctionParameters(775,769,773,771,t);break;case 14:this.setAlphaBlendFunctionParameters(1,771,1,771,t);break;case 15:this.setAlphaBlendFunctionParameters(1,1,1,0,t);break;case 16:this.setAlphaBlendFunctionParameters(775,769,0,1,t);break;case 17:this.setAlphaBlendFunctionParameters(770,771,1,771,t);break;case 18:this.setAlphaBlendFunctionParameters(1,1,1,1,t),s=32775;break;case 19:this.setAlphaBlendFunctionParameters(1,1,1,1,t),s=32776;break;case 20:this.setAlphaBlendFunctionParameters(1,35065,0,1,t);break}this.setAlphaEquationParameters(s,s,t)}}class Ls{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,s=1,i=1,r=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=s,this._cachedAnisotropicFilteringLevel=i,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var it;(function(a){a[a.Unknown=0]="Unknown",a[a.Url=1]="Url",a[a.Temp=2]="Temp",a[a.Raw=3]="Raw",a[a.Dynamic=4]="Dynamic",a[a.RenderTarget=5]="RenderTarget",a[a.MultiRenderTarget=6]="MultiRenderTarget",a[a.Cube=7]="Cube",a[a.CubeRaw=8]="CubeRaw",a[a.CubePrefiltered=9]="CubePrefiltered",a[a.Raw3D=10]="Raw3D",a[a.Raw2DArray=11]="Raw2DArray",a[a.DepthStencil=12]="DepthStencil",a[a.CubeRawRGBD=13]="CubeRawRGBD",a[a.Depth=14]="Depth"})(it||(it={}));class ae extends Ls{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,s=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new B,this.onErrorObservable=new B,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._autoMSAAManagement=!1,this._engine=e,this._source=t,this._uniqueId=ae._Counter++,s||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,s=1){this._engine.updateTextureDimensions(this,e,t,s),this.width=e,this.height=t,this.depth=s,this.baseWidth=e,this.baseHeight=t,this.baseDepth=s,this._size=e*t*s}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const t=this.onRebuildCallback(this),s=i=>{i._swapAndDie(this,!1),this.isReady=t.isReady};t.isAsync?t.proxy.then(s):s(t.proxy);return}let e;switch(this.source){case 2:break;case 1:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,t=>{t._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,t=>{t&&t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const s=this._engine.getLoadedTexturesCache();let i=s.indexOf(this);i!==-1&&s.splice(i,1),i=s.indexOf(e),i===-1&&s.push(e)}dispose(){this._references--,this._references===0&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}ae._Counter=0;const Se=new Map;function j(a,e){Os(a)&&m.Warn(`Extension with the name '${a}' already exists`),Se.set(a,e)}function Os(a){return Se.delete(a)}function Us(a,e){(e==="image/ktx"||e==="image/ktx2")&&(a=".ktx"),Se.has(a)||(a.endsWith(".ies")&&j(".ies",async()=>await import("./iesTextureLoader-D5qmfxdr.js").then(s=>new s._IESTextureLoader)),a.endsWith(".dds")&&j(".dds",async()=>await import("./ddsTextureLoader-DtfinBFW.js").then(s=>new s._DDSTextureLoader)),a.endsWith(".basis")&&j(".basis",async()=>await import("./basisTextureLoader-qpYhOe1a.js").then(s=>new s._BasisTextureLoader)),a.endsWith(".env")&&j(".env",async()=>await import("./envTextureLoader-DSB4fgS7.js").then(s=>new s._ENVTextureLoader)),a.endsWith(".hdr")&&j(".hdr",async()=>await import("./hdrTextureLoader-DwqFIKZc.js").then(s=>new s._HDRTextureLoader)),(a.endsWith(".ktx")||a.endsWith(".ktx2"))&&(j(".ktx",async()=>await import("./ktxTextureLoader-8L2svVP6.js").then(s=>new s._KTXTextureLoader)),j(".ktx2",async()=>await import("./ktxTextureLoader-8L2svVP6.js").then(s=>new s._KTXTextureLoader))),a.endsWith(".tga")&&j(".tga",async()=>await import("./tgaTextureLoader-CHmaV7sr.js").then(s=>new s._TGATextureLoader)),a.endsWith(".exr")&&j(".exr",async()=>await import("./exrTextureLoader-CX7iDDw5.js").then(s=>new s._ExrTextureLoader)));const t=Se.get(a);return t?Promise.resolve(t(e)):null}function At(a,e){if(X()){const{requestAnimationFrame:t}=e||window;if(typeof t=="function")return t(a)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(a);return setTimeout(a,16)}class K{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}_resetAlphaMode(){this._alphaMode.fill(-1),this._alphaEquation.fill(-1)}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}L.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){m.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout(()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,s=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=s,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=r,this._flagContextRestored()},0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){const e=this._frameHandler;if(this._frameHandler=0,X()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if(typeof t=="function")return t(e)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}get maxFPS(){return this._maxFPS}set maxFPS(e){if(this._maxFPS=e,e!==void 0){if(e<=0){this._minFrameTime=Number.MAX_VALUE;return}this._minFrameTime=1e3/e}}_isOverFrameTime(e){if(!e||this._maxFPS===void 0)return!1;const t=e-this._lastFrameTime;return this._lastFrameTime=e,this._renderAccumulator+=t,this._renderAccumulator<this._minFrameTime?!0:(this._renderAccumulator-=this._minFrameTime,this._renderAccumulator>this._minFrameTime&&(this._renderAccumulator=this._minFrameTime),!1)}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),!this.skipFrameRender&&!this._renderViews()&&this._renderFrame(),this.endFrame())}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderViews(){return!1}_queueNewFrame(e,t){return At(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return X()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,s){const i=t||this.getRenderWidth(),r=s||this.getRenderHeight(),n=e.x||0,h=e.y||0;this._cachedViewport=e,this._viewport(n*i,h*r,i*e.width,r*e.height)}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,s,i,r=3,n=null,h=null,l,o,c=null,u=null,f=null,_=null,g,T,b){e=e||"";const d=e.substring(0,5)==="data:",p=e.substring(0,5)==="blob:",R=d&&e.indexOf(";base64,")!==-1,x=u||new ae(this,1);x!==u&&(x.label=e.substring(0,60));const w=e;this._transformTextureUrl&&!R&&!u&&!c&&(e=this._transformTextureUrl(e)),w!==e&&(x._originalUrl=w);const C=e.lastIndexOf(".");let v=_||(C>-1?e.substring(C).toLowerCase():"");v.indexOf("?")>-1&&(v=v.split("?")[0]);const O=Us(v,g);i&&i.addPendingData(x),x.url=e,x.generateMipMaps=!t,x.samplingMode=r,x.invertY=s,x._useSRGBBuffer=this._getUseSRGBBuffer(!!b,t),this._doNotHandleContextLost||(x._buffer=c);let U=null;n&&!u&&(U=x.onLoadedObservable.add(n)),u||this._internalTexturesCache.push(x);const N=(P,M)=>{i&&i.removePendingData(x),e===w?(U&&x.onLoadedObservable.remove(U),G.UseFallbackTexture&&e!==G.FallbackTexture&&this._createTextureBase(G.FallbackTexture,t,x.invertY,i,r,null,h,l,o,c,x),P=(P||"Unknown error")+(G.UseFallbackTexture?" - Fallback texture was used":""),x.onErrorObservable.notifyObservers({message:P,exception:M}),h&&h(P,M)):(m.Warn(`Failed to load ${e}, falling back to ${w}`),this._createTextureBase(w,t,x.invertY,i,r,n,h,l,o,c,x,f,_,g,T,b))};if(O){const P=async M=>{(await O).loadData(M,x,(Q,J,ee,te,se,_e)=>{_e?N("TextureLoader failed to load data"):l(x,v,i,{width:Q,height:J},x.invertY,!ee,te,()=>(se(),!1),r)},T)};c?c instanceof ArrayBuffer?P(new Uint8Array(c)):ArrayBuffer.isView(c)?P(c):h&&h("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,M=>{P(new Uint8Array(M))},void 0,i?i.offlineProvider:void 0,!0,(M,$)=>{N("Unable to load "+(M&&M.responseURL,$))})}else{const P=M=>{p&&!this._doNotHandleContextLost&&(x._buffer=M),l(x,v,i,M,x.invertY,t,!1,o,r)};!d||R?c&&(typeof c.decoding=="string"||c.close)?P(c):K._FileToolsLoadImage(e||"",P,N,i?i.offlineProvider:null,g,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):typeof c=="string"||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?K._FileToolsLoadImage(c,P,N,i?i.offlineProvider:null,g,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):c&&P(c)}return x}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:we()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@8.16.0"}static get Version(){return"8.16.0"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,s){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Ds,this._stencilStateComposer=new Bs,this._stencilState=new W,this._alphaState=new Ms,this._alphaMode=Array(8).fill(-1),this._alphaEquation=Array(8).fill(-1),this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new B,this.onCanvasFocusObservable=new B,this.onNewSceneAddedObservable=new B,this.onResizeObservable=new B,this.onCanvasPointerOutObservable=new B,this.onEffectErrorObservable=new B,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new B,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=n=>this._renderLoop(n),this._lastFrameTime=0,this._renderAccumulator=0,this.skipFrameRender=!1,this.onBeforeShaderCompilationObservable=new B,this.onAfterShaderCompilationObservable=new B,this.onBeginFrameObservable=new B,this.onEndFrameObservable=new B,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new B,this.onContextRestoredObservable=new B,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new B,this.onReleaseEffectsObservable=new B,G.Instances.push(this),this.startTime=Ps.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,V.SetMatrixPrecision(!!t.useHighPrecisionMatrix),Xt()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=s??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.stencil=t.stencil??!0,this._audioContext=t.audioEngineOptions?.audioContext??null,this._audioDestination=t.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;const i=X()&&window.devicePixelRatio||1,r=t.limitDeviceRatio||i;s=s||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=s?1/Math.min(r,i):1,this._lastDevicePixelRatio=i,this._creationOptions=t}resize(e=!1){let t,s;if(this.adaptToDeviceRatio){const i=X()&&window.devicePixelRatio||1,r=this._lastDevicePixelRatio/i;this._lastDevicePixelRatio=i,this._hardwareScalingLevel*=r}if(X()&&we())if(this._renderingCanvas){const i=this._renderingCanvas.getBoundingClientRect?.();t=this._renderingCanvas.clientWidth||i?.width||this._renderingCanvas.width*this._hardwareScalingLevel||100,s=this._renderingCanvas.clientHeight||i?.height||this._renderingCanvas.height*this._hardwareScalingLevel||100}else t=window.innerWidth,s=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,s=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,s/this._hardwareScalingLevel,e)}setSize(e,t,s=!1){if(!this._renderingCanvas||(e=e|0,t=t|0,!s&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t))return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let i=0;i<this.scenes.length;i++){const r=this.scenes[i];for(let n=0;n<r.cameras.length;n++){const h=r.cameras[n];h._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,s,i,r,n,h,l,o,c,u){throw Z("engine.rawTexture")}createRawCubeTexture(e,t,s,i,r,n,h,l){throw Z("engine.rawTexture")}createRawTexture3D(e,t,s,i,r,n,h,l,o,c,u){throw Z("engine.rawTexture")}createRawTexture2DArray(e,t,s,i,r,n,h,l,o,c,u){throw Z("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&we()&&"ontouchend"in document},this._checkForMobile(),X()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,s){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const s=document.createElement("canvas");return s.width=e,s.height=t,s}createCanvas(e,t){return K._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,s,i,r,n,h){throw Z("FileTools")}_loadFile(e,t,s,i,r,n){const h=bt(e,t,s,i,r,n);return this._activeRequests.push(h),h.onCompleteObservable.add(()=>{const l=this._activeRequests.indexOf(h);l!==-1&&this._activeRequests.splice(l,1)}),h}static _FileToolsLoadFile(e,t,s,i,r,n){if(Le.loadFile)return Le.loadFile(e,t,s,i,r,n);throw Z("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),L.ResetCache();for(const t of this._activeRequests)t.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),X()&&window.removeEventListener("resize",this._checkForMobile);const e=G.Instances.indexOf(this);e>=0&&G.Instances.splice(e,1),G.Instances.length||(G.OnEnginesDisposedObservable.notifyObservers(this),G.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw Z("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let s=0;s<G.Instances.length;s++){const i=G.Instances[s];for(let r=0;r<i.scenes.length;r++)i.scenes[r].markAllMaterialsAsDirty(e,t)}}}K._RenderPassIdCounter=0;K._RescalePostProcessFactory=null;K.CollisionsEpsilon=.001;K.QueueNewFrame=At;class Gs{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}function rt(a){return a===13||a===14||a===15||a===16||a===17||a===18||a===19}function nt(a){return a===13||a===17||a===18||a===19}class ks{}class I extends K{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return L.ShadersRepository}static set ShadersRepository(e){L.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,s,i){if(s=s||{},super(t??s.antialias,s,i),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let r=null;if(e.getContext){if(r=e,s.preserveDrawingBuffer===void 0&&(s.preserveDrawingBuffer=!1),s.xrCompatible===void 0&&(s.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const l=navigator.userAgent;for(const o of I.ExceptionList){const c=o.key,u=o.targets;if(new RegExp(c).test(l)){if(o.capture&&o.captureConstraint){const _=o.capture,g=o.captureConstraint,b=new RegExp(_).exec(l);if(b&&b.length>0&&parseInt(b[b.length-1])>=g)continue}for(const _ of u)switch(_){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":s.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{ve(this._gl)}:(this._onContextLost=l=>{l.preventDefault(),this._contextWasLost=!0,ve(this._gl),m.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},r.addEventListener("webglcontextrestored",this._onContextRestored,!1),s.powerPreference=s.powerPreference||"high-performance"),r.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(s.xrCompatible=!1),!s.disableWebGL2Support)try{this._gl=r.getContext("webgl2",s)||r.getContext("experimental-webgl2",s),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!r)throw new Error("The provided canvas is null or undefined.");try{this._gl=r.getContext("webgl",s)||r.getContext("experimental-webgl",s)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,r=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const l=this._gl.getContextAttributes();l&&(s.stencil=l.stencil)}this._sharedInit(r),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),s.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=s.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let l=0;l<this._caps.maxVertexAttribs;l++)this._currentBufferPointers[l]=new ks;this._shaderProcessor=this.webGLVersion>1?new ts:new Jt;const n=`Babylon.js v${I.Version}`;m.Log(n+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",n);const h=H(this._gl);h.validateShaderPrograms=this.validateShaderPrograms,h.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16"),blendParametersPerTarget:!1,dualSourceBlending:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763);const t=this._gl.getExtension("OES_draw_buffers_indexed");if(this._caps.blendParametersPerTarget=!!t,t&&(this._gl.blendEquationSeparateIndexed=t.blendEquationSeparateiOES.bind(t),this._gl.blendEquationIndexed=t.blendEquationiOES.bind(t),this._gl.blendFuncSeparateIndexed=t.blendFuncSeparateiOES.bind(t),this._gl.blendFuncIndexed=t.blendFunciOES.bind(t),this._gl.colorMaskIndexed=t.colorMaskiOES.bind(t),this._gl.disableIndexed=t.disableiOES.bind(t),this._gl.enableIndexed=t.enableiOES.bind(t)),this._caps.dualSourceBlending=!!this._gl.getExtension("WEBGL_blend_func_extended"),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const s=this._gl.getExtension("WEBGL_draw_buffers");if(s!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=s.drawBuffersWEBGL.bind(s),this._caps.maxDrawBuffers=this._gl.getParameter(s.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let i=0;i<16;i++)this._gl["COLOR_ATTACHMENT"+i+"_WEBGL"]=s["COLOR_ATTACHMENT"+i+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const s=this._gl.getExtension("WEBGL_depth_texture");s!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=s.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const s=this._gl.getExtension("OES_vertex_array_object");s!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=s.createVertexArrayOES.bind(s),this._gl.bindVertexArray=s.bindVertexArrayOES.bind(s),this._gl.deleteVertexArray=s.deleteVertexArrayOES.bind(s))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const s=this._gl.getExtension("ANGLE_instanced_arrays");s!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const s=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),i=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);s&&i&&(this._caps.highPrecisionShaderSupported=s.precision!==0&&i.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const s=this._gl.getExtension("EXT_blend_minmax");s!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=s.MAX_EXT,this._gl.MIN=s.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const s=this._gl.getExtension("EXT_sRGB");s!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:s.SRGB_EXT,SRGB8:s.SRGB_ALPHA_EXT,SRGB8_ALPHA8:s.SRGB_ALPHA_EXT})}if(this._creationOptions){const s=this._creationOptions.forceSRGBBufferSupportState;s!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&s)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let s=0;s<this._maxSimultaneousTextures;s++)this._nextFreeTextureSlots.push(s);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,s,i=!1){const r=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=r;let n=0;if(t&&e){let h=!0;if(this._currentRenderTarget){const l=this._currentRenderTarget.texture?.format;if(l===8||l===9||l===10||l===11){const o=this._currentRenderTarget.texture?.type;o===7||o===5?(I._TempClearColorUint32[0]=e.r*255,I._TempClearColorUint32[1]=e.g*255,I._TempClearColorUint32[2]=e.b*255,I._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,I._TempClearColorUint32),h=!1):(I._TempClearColorInt32[0]=e.r*255,I._TempClearColorInt32[1]=e.g*255,I._TempClearColorInt32[2]=e.b*255,I._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,I._TempClearColorInt32),h=!1)}}h&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),n|=this._gl.COLOR_BUFFER_BIT)}s&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),i&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,s,i){(e!==this._viewportCached.x||t!==this._viewportCached.y||s!==this._viewportCached.z||i!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=s,this._viewportCached.w=i,this._gl.viewport(e,t,s,i))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,s,i,r,n=0,h=0){const l=e;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);const o=this._gl;e.isMulti||(e.is2DArray||e.is3D?(o.framebufferTextureLayer(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,n,h),l._currentLOD=n):e.isCube?o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,n):l._currentLOD!==n&&(o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,n),l._currentLOD=n));const c=e._depthStencilTexture;if(c){e.is3D&&(e.texture.width!==c.width||e.texture.height!==c.height||e.texture.depth!==c.depth)&&m.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");const u=e._depthStencilTextureWithStencil?o.DEPTH_STENCIL_ATTACHMENT:o.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?o.framebufferTextureLayer(o.FRAMEBUFFER,u,c._hardwareTexture?.underlyingResource,n,h):e.isCube?o.framebufferTexture2D(o.FRAMEBUFFER,u,o.TEXTURE_CUBE_MAP_POSITIVE_X+t,c._hardwareTexture?.underlyingResource,n):o.framebufferTexture2D(o.FRAMEBUFFER,u,o.TEXTURE_2D,c._hardwareTexture?.underlyingResource,n)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,s,i):(s||(s=e.width,n&&(s=s/Math.pow(2,n))),i||(i=e.height,n&&(i=i/Math.pow(2,n))),this._viewport(0,0,s,i)),this.wipeCaches()}setStateCullFaceType(e,t){const s=this.cullBackFaces??e??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==s||t)&&(this._depthCullingState.cullFace=s)}setState(e,t=0,s,i=!1,r,n,h=0){(this._depthCullingState.cull!==e||s)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(r,s),this.setZOffset(t),this.setZOffsetUnits(h);const l=i?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||s)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=n}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){e.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t,s){const i=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),s&&(i._MSAAFramebuffer&&this._bindUnboundFramebuffer(i._framebuffer),s()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this.generateMipmaps(e.texture)}resolveFramebuffer(e){const t=e,s=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let i=t.resolveMSAAColors?s.COLOR_BUFFER_BIT:0;i|=t._generateDepthBuffer&&t.resolveMSAADepth?s.DEPTH_BUFFER_BIT:0,i|=t._generateStencilBuffer&&t.resolveMSAAStencil?s.STENCIL_BUFFER_BIT:0,s.bindFramebuffer(s.READ_FRAMEBUFFER,t._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,t._framebuffer),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,i,s.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,s){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const s=this._gl.createBuffer();if(!s)throw new Error("Unable to create vertex buffer");const i=new Ze(s);return this.bindArrayBuffer(i),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),i.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),i.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),i.capacity=e),this._resetVertexBufferBinding(),i.references=1,i}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,s){const i=this._gl.createBuffer(),r=new Ze(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=n.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let s=0;s<e.length;s++)if(e[s]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,s){const i=e.program,r=this._gl.getUniformBlockIndex(i,t);this._gl.uniformBlockBinding(i,r,s)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,s,i,r,n,h){const l=this._currentBufferPointers[t];if(!l)return;let o=!1;l.active?(l.buffer!==e&&(l.buffer=e,o=!0),l.size!==s&&(l.size=s,o=!0),l.type!==i&&(l.type=i,o=!0),l.normalized!==r&&(l.normalized=r,o=!0),l.stride!==n&&(l.stride=n,o=!0),l.offset!==h&&(l.offset=h,o=!0)):(o=!0,l.active=!0,l.index=t,l.size=s,l.type=i,l.normalized=r,l.stride=n,l.offset=h,l.buffer=e),(o||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),i===this._gl.UNSIGNED_INT||i===this._gl.INT?this._gl.vertexAttribIPointer(t,s,i,n,h):this._gl.vertexAttribPointer(t,s,i,r,n,h))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,s){const i=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<i.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const h=i[r];let l=null;if(s&&(l=s[h]),l||(l=e[h]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const o=l.getBuffer();o&&(this._vertexAttribPointer(o,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))))}}}recordVertexArrayObject(e,t,s,i){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,s,i),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,s,i,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const n=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let h=0;for(let l=0;l<n;l++)if(l<s.length){const o=r.getAttributeLocation(l);o>=0&&(this._gl.enableVertexAttribArray(o),this._vertexAttribArraysEnabled[o]=!0,this._vertexAttribPointer(e,o,s[l],this._gl.FLOAT,!1,i,h)),h+=s[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,s,i){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s,this._bindVertexBuffersAttributes(e,s,i)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,s=this._currentInstanceLocations.length;t<s;t++){const i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));const r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,s){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),s[0].index!==void 0)this.bindInstancesBuffer(e,s,!0);else for(let i=0;i<4;i++){const r=s[i];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,i*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,s=!0){this.bindArrayBuffer(e);let i=0;if(s)for(let r=0;r<t.length;r++){const n=t[r];i+=n.attributeSize*4}for(let r=0;r<t.length;r++){const n=t[r];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,i,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,s;for(;(s=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(s,1),this._currentInstanceBuffers.splice(s,1),t=!0,s=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,s,i){this.drawElementsType(e?0:1,t,s,i)}drawPointClouds(e,t,s){this.drawArraysType(2,e,t,s)}drawUnIndexed(e,t,s,i){this.drawArraysType(e?0:1,t,s,i)}drawElementsType(e,t,s,i){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,h=this._uintIndicesCurrentlySet?4:2;i?this._gl.drawElementsInstanced(r,s,n,t*h,i):this._gl.drawElements(r,s,n,t*h)}drawArraysType(e,t,s,i){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);i?this._gl.drawArraysInstanced(r,t,s,i):this._gl.drawArrays(r,t,s)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,Rt(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)))}_getGlobalDefines(e){return xt(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,s,i,r,n,h,l,o,c=0,u){const f=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,_=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,g=this._getGlobalDefines(),T=t.attributes!==void 0;let b=r??t.defines??"";g&&(b+=g);const d=f+"+"+_+"@"+b;if(this._compiledEffects[d]){const R=this._compiledEffects[d];return h&&R.isReady()&&h(R),R._refCount++,R}this._gl&&H(this._gl);const p=new L(e,t,T?this:s,i,this,r,n,h,l,o,d,t.shaderLanguage??c,t.extraInitializationsAsync??u);return this._compiledEffects[d]=p,p}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,s,i,r=null){const n=H(this._gl);return n._contextWasLost=this._contextWasLost,n.validateShaderPrograms=this.validateShaderPrograms,Et(e,t,s,i||this._gl,r)}createShaderProgram(e,t,s,i,r,n=null){const h=H(this._gl);return h._contextWasLost=this._contextWasLost,h.validateShaderPrograms=this.validateShaderPrograms,Tt(e,t,s,i,r||this._gl,n)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){const s=H(this._gl);s.parallelShaderCompile=this._caps.parallelShaderCompile}const t=Yt(this._gl);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return Xe(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,s,i,r,n,h,l,o,c,u){const f=H(this._gl);return f._contextWasLost=this._contextWasLost,f.validateShaderPrograms=this.validateShaderPrograms,f._createShaderProgramInjection=this._createShaderProgram.bind(this),f.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),f.createShaderProgramInjection=this.createShaderProgram.bind(this),f.loadFileInjection=this._loadFile.bind(this),jt(e,t,s,i,r,n,h,l,o,c,u)}_createShaderProgram(e,t,s,i,r=null){return We(e,t,s,i,r)}_isRenderingStateCompiled(e){return this._isDisposed?!1:$t(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){Zt(e,t)}getUniforms(e,t){const s=new Array,i=e;for(let r=0;r<t.length;r++)s.push(this._gl.getUniformLocation(i.program,t[r]));return s}getAttributes(e,t){const s=[],i=e;for(let r=0;r<t.length;r++)try{s.push(this._gl.getAttribLocation(i.program,t[r]))}catch{s.push(-1)}return s}enableEffect(e){e=e!==null&&Qt(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,s){return e?(this._gl.uniform2i(e,t,s),!0):!1}setInt3(e,t,s,i){return e?(this._gl.uniform3i(e,t,s,i),!0):!1}setInt4(e,t,s,i,r){return e?(this._gl.uniform4i(e,t,s,i,r),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,s){return e?(this._gl.uniform2ui(e,t,s),!0):!1}setUInt3(e,t,s,i){return e?(this._gl.uniform3ui(e,t,s,i),!0):!1}setUInt4(e,t,s,i,r){return e?(this._gl.uniform4ui(e,t,s,i,r),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,s){return e?(this._gl.uniform2f(e,t,s),!0):!1}setFloat3(e,t,s,i){return e?(this._gl.uniform3f(e,t,s,i),!0):!1}setFloat4(e,t,s,i,r){return e?(this._gl.uniform4f(e,t,s,i,r),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl,this._currentRenderTarget&&this._currentRenderTarget.textures?this._currentRenderTarget.textures.length:1),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const s=this._gl;let i=s.NEAREST,r=s.NEAREST,n=!1;switch(e){case 11:i=s.LINEAR,t?r=s.LINEAR_MIPMAP_NEAREST:r=s.LINEAR;break;case 3:i=s.LINEAR,n=!0,t?r=s.LINEAR_MIPMAP_LINEAR:r=s.LINEAR;break;case 8:n=!0,i=s.NEAREST,t?r=s.NEAREST_MIPMAP_LINEAR:r=s.NEAREST;break;case 4:i=s.NEAREST,t?r=s.NEAREST_MIPMAP_NEAREST:r=s.NEAREST;break;case 5:i=s.NEAREST,t?r=s.LINEAR_MIPMAP_NEAREST:r=s.LINEAR;break;case 6:n=!0,i=s.NEAREST,t?r=s.LINEAR_MIPMAP_LINEAR:r=s.LINEAR;break;case 7:i=s.NEAREST,r=s.LINEAR;break;case 1:i=s.NEAREST,r=s.NEAREST;break;case 9:i=s.LINEAR,t?r=s.NEAREST_MIPMAP_NEAREST:r=s.NEAREST;break;case 10:n=!0,i=s.LINEAR,t?r=s.NEAREST_MIPMAP_LINEAR:r=s.NEAREST;break;case 2:i=s.LINEAR,r=s.LINEAR;break;case 12:i=s.LINEAR,r=s.NEAREST;break}return{min:r,mag:i,hasMipMaps:n}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new Gs(this._createTexture(),this._gl)}_createInternalTexture(e,t,s=!0,i=0){let r=!1,n=!1,h=0,l=3,o=5,c=!1,u=1,f,_=!1,g=0;t!==void 0&&typeof t=="object"?(r=!!t.generateMipMaps,n=!!t.createMipMaps,h=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,o=t.format===void 0?5:t.format,c=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=t.samples??1,f=t.label,_=!!t.createMSAATexture,g=t.comparisonFunction||0):r=!!t,c&&(c=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(h===1&&!this._caps.textureFloatLinearFiltering||h===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),h===1&&!this._caps.textureFloat&&(h=0,m.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const T=rt(o),b=nt(o),d=this._gl,p=new ae(this,i),R=e.width||e,x=e.height||e,w=e.depth||0,C=e.layers||0,v=this._getSamplingParameters(l,(r||n)&&!T),A=C!==0?d.TEXTURE_2D_ARRAY:w!==0?d.TEXTURE_3D:d.TEXTURE_2D,O=T?this._getInternalFormatFromDepthTextureFormat(o,!0,b):this._getRGBABufferInternalSizedFormat(h,o,c),U=T?b?d.DEPTH_STENCIL:d.DEPTH_COMPONENT:this._getInternalFormat(o),N=T?this._getWebGLTextureTypeFromDepthTextureFormat(o):this._getWebGLTextureType(h);if(this._bindTextureDirectly(A,p),C!==0?(p.is2DArray=!0,d.texImage3D(A,0,O,R,x,C,0,U,N,null)):w!==0?(p.is3D=!0,d.texImage3D(A,0,O,R,x,w,0,U,N,null)):d.texImage2D(A,0,O,R,x,0,U,N,null),d.texParameteri(A,d.TEXTURE_MAG_FILTER,v.mag),d.texParameteri(A,d.TEXTURE_MIN_FILTER,v.min),d.texParameteri(A,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(A,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),T&&this.webGLVersion>1&&(g===0?(d.texParameteri(A,d.TEXTURE_COMPARE_FUNC,515),d.texParameteri(A,d.TEXTURE_COMPARE_MODE,d.NONE)):(d.texParameteri(A,d.TEXTURE_COMPARE_FUNC,g),d.texParameteri(A,d.TEXTURE_COMPARE_MODE,d.COMPARE_REF_TO_TEXTURE))),(r||n)&&this._gl.generateMipmap(A),this._bindTextureDirectly(A,null),p._useSRGBBuffer=c,p.baseWidth=R,p.baseHeight=x,p.width=R,p.height=x,p.depth=C||w,p.isReady=!0,p.samples=u,p.generateMipMaps=r,p.samplingMode=l,p.type=h,p.format=o,p.label=f,p.comparisonFunction=g,this._internalTexturesCache.push(p),_){let P=null;if(rt(p.format)?P=this._setupFramebufferDepthAttachments(nt(p.format),p.format!==19,p.width,p.height,u,p.format,!0):P=this._createRenderBuffer(p.width,p.height,u,-1,this._getRGBABufferInternalSizedFormat(p.type,p.format,p._useSRGBBuffer),-1),!P)throw new Error("Unable to create render buffer");p._autoMSAAManagement=!0;let M=p._hardwareTexture;M||(M=p._hardwareTexture=this._createHardwareTexture()),M.addMSAARenderBuffer(P)}return p}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,s,i,r=3,n=null,h=null,l=null,o=null,c=null,u=null,f,_,g,T){return this._createTextureBase(e,t,s,i,r,n,h,(...b)=>this._prepareWebGLTexture(...b,c),(b,d,p,R,x,w)=>{const C=this._gl,v=p.width===b&&p.height===d;x._creationFlags=g??0;const A=this._getTexImageParametersForCreateTexture(x.format,x._useSRGBBuffer);if(v)return C.texImage2D(C.TEXTURE_2D,0,A.internalFormat,A.format,A.type,p),!1;const O=this._caps.maxTextureSize;if(p.width>O||p.height>O||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=b,this._workingCanvas.height=d,this._workingContext.drawImage(p,0,0,p.width,p.height,0,0,b,d),C.texImage2D(C.TEXTURE_2D,0,A.internalFormat,A.format,A.type,this._workingCanvas),x.width=b,x.height=d),!1;{const U=new ae(this,2);this._bindTextureDirectly(C.TEXTURE_2D,U,!0),C.texImage2D(C.TEXTURE_2D,0,A.internalFormat,A.format,A.type,p),this._rescaleTexture(U,x,i,A.format,()=>{this._releaseTexture(U),this._bindTextureDirectly(C.TEXTURE_2D,x,!0),w()})}return!0},l,o,c,u,f,_,T)}_getTexImageParametersForCreateTexture(e,t){let s,i;return this.webGLVersion===1?(s=this._getInternalFormat(e,t),i=s):(s=this._getInternalFormat(e,!1),i=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:i,format:s,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,s,i,r){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,s=!1){const i=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||s);this._setTextureParameterInteger(i,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(i,this._gl.TEXTURE_MIN_FILTER,r.min),s&&r.hasMipMaps&&(t.generateMipMaps=!0,this._gl.generateMipmap(i)),this._bindTextureDirectly(i,null),t.samplingMode=e}updateTextureDimensions(e,t,s,i=1){}updateTextureWrappingMode(e,t,s=null,i=null){const r=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),s!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(s),e),e._cachedWrapV=s),(e.is2DArray||e.is3D)&&i!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i),e),e._cachedWrapR=i),this._bindTextureDirectly(r,null)}_uploadCompressedDataToTextureDirectly(e,t,s,i,r,n=0,h=0){const l=this._gl;let o=l.TEXTURE_2D;if(e.isCube&&(o=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(o,h,t,s,i,0,r)}_uploadDataToTextureDirectly(e,t,s=0,i=0,r,n=!1){const h=this._gl,l=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),c=r===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=h.TEXTURE_2D;e.isCube&&(u=h.TEXTURE_CUBE_MAP_POSITIVE_X+s);const f=Math.round(Math.log(e.width)*Math.LOG2E),_=Math.round(Math.log(e.height)*Math.LOG2E),g=n?e.width:Math.pow(2,Math.max(f-i,0)),T=n?e.height:Math.pow(2,Math.max(_-i,0));h.texImage2D(u,i,c,g,T,0,o,l,t)}updateTextureData(e,t,s,i,r,n,h=0,l=0,o=!1){const c=this._gl,u=this._getWebGLTextureType(e.type),f=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let _=c.TEXTURE_2D,g=c.TEXTURE_2D;e.isCube&&(g=c.TEXTURE_CUBE_MAP_POSITIVE_X+h,_=c.TEXTURE_CUBE_MAP),this._bindTextureDirectly(_,e,!0),c.texSubImage2D(g,l,s,i,r,n,f,u,t),o&&this._gl.generateMipmap(g),this._bindTextureDirectly(_,null)}_uploadArrayBufferViewToTexture(e,t,s=0,i=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,s,i),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,s,i,r){const n=this._gl;if(!n)return;const h=this._getSamplingParameters(r,!s);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,h.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,h.min),!s&&!i&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,s,i,r,n,h,l,o,c){const u=this.getCaps().maxTextureSize,f=Math.min(u,this.needPOTTextures?Ee(i.width,u):i.width),_=Math.min(u,this.needPOTTextures?Ee(i.height,u):i.height),g=this._gl;if(g){if(!e._hardwareTexture){s&&s.removePendingData(e);return}this._bindTextureDirectly(g.TEXTURE_2D,e,!0),this._unpackFlipY(r===void 0?!0:!!r),e.baseWidth=i.width,e.baseHeight=i.height,e.width=f,e.height=_,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:c??(t===".jpg"&&!e._useSRGBBuffer?4:5),!l(f,_,i,t,e,()=>{this._prepareWebGLTextureContinuation(e,s,n,h,o)})&&this._prepareWebGLTextureContinuation(e,s,n,h,o)}}_getInternalFormatFromDepthTextureFormat(e,t,s){const i=this._gl;if(!t)return i.STENCIL_INDEX8;let n=s?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;return this.webGLVersion>1?e===15?n=i.DEPTH_COMPONENT16:e===16?n=i.DEPTH_COMPONENT24:e===17||e===13?n=s?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24:e===14?n=i.DEPTH_COMPONENT32F:e===18&&(n=s?i.DEPTH32F_STENCIL8:i.DEPTH_COMPONENT32F):n=i.DEPTH_COMPONENT16,n}_getWebGLTextureTypeFromDepthTextureFormat(e){const t=this._gl;let s=t.UNSIGNED_INT;return e===15?s=t.UNSIGNED_SHORT:e===17||e===13?s=t.UNSIGNED_INT_24_8:e===14?s=t.FLOAT:e===18?s=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===19&&(s=t.UNSIGNED_BYTE),s}_setupFramebufferDepthAttachments(e,t,s,i,r=1,n,h=!1){const l=this._gl;n=n??(e?13:14);const o=this._getInternalFormatFromDepthTextureFormat(n,t,e);return e&&t?this._createRenderBuffer(s,i,r,l.DEPTH_STENCIL,o,h?-1:l.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(s,i,r,o,o,h?-1:l.DEPTH_ATTACHMENT):e?this._createRenderBuffer(s,i,r,o,o,h?-1:l.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,s,i,r,n,h=!0){const o=this._gl.createRenderbuffer();return this._updateRenderBuffer(o,e,t,s,i,r,n,h)}_updateRenderBuffer(e,t,s,i,r,n,h,l=!0){const o=this._gl;return o.bindRenderbuffer(o.RENDERBUFFER,e),i>1&&o.renderbufferStorageMultisample?o.renderbufferStorageMultisample(o.RENDERBUFFER,i,n,t,s):o.renderbufferStorage(o.RENDERBUFFER,r,t,s),h!==-1&&o.framebufferRenderbuffer(o.FRAMEBUFFER,h,o.RENDERBUFFER,e),l&&o.bindRenderbuffer(o.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&(qt(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const s=e.getSamplers();for(let i=0;i<s.length;i++){const r=e.getUniform(s[i]);r&&(this._boundUniforms[i]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,s=!1,i=!1){let r=!1;const n=t&&t._associatedChannel>-1;if(s&&n&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||i){if(this._activateCurrentTexture(),t&&t.isMultiview)throw m.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else s&&(r=!0,this._activateCurrentTexture());return n&&!s&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),r}_bindTexture(e,t,s){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const i=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(i,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,s,i){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,s))}_bindSamplerUniformToChannel(e,t){const s=this._boundUniforms[e];!s||s._currentState===t||(this._gl.uniform1i(s,t),s._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,s=!1,i=!1,r=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const o=t.getInternalTexture();o&&(o._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;i?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!s&&n&&(n._associatedChannel=e);let h=!0;this._boundTexturesCache[e]===n&&(s||this._bindSamplerUniformToChannel(n._associatedChannel,e),h=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(h&&this._bindTextureDirectly(l,n,s),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const o=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=o,t.wrapV=o}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,s,i){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==s.length)&&(this._textureUnits=new Int32Array(s.length));for(let r=0;r<s.length;r++){const n=s[r].getInternalTexture();n?(this._textureUnits[r]=e+r,n._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let r=0;r<s.length;r++)this._setTexture(this._textureUnits[r],s[r],!0)}}_setAnisotropicLevel(e,t,s){const i=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(s=1),i&&t._cachedAnisotropicFilteringLevel!==s&&(this._setTextureParameterFloat(e,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=s)}_setTextureParameterFloat(e,t,s,i){this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameterf(e,t,s)}_setTextureParameterInteger(e,t,s,i){i&&this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameteri(e,t,s)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){X()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),ve(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(s=s&&n===t.FRAMEBUFFER_COMPLETE,s=s&&t.getError()===t.NO_ERROR,s&&(t.clear(t.COLOR_BUFFER_BIT),s=s&&t.getError()===t.NO_ERROR),s){t.bindFramebuffer(t.FRAMEBUFFER,null);const h=t.RGBA,l=t.UNSIGNED_BYTE,o=new Uint8Array(4);t.readPixels(0,0,1,1,h,l,o),s=s&&t.getError()===t.NO_ERROR}for(t.deleteTexture(i),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!s&&t.getError()!==t.NO_ERROR;);return s}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let s=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:s=this._gl.ALPHA;break;case 1:s=this._gl.LUMINANCE;break;case 2:s=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:s=this._gl.RED;break;case 7:case 33324:case 36761:s=this._gl.RG;break;case 4:case 32852:case 36762:s=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:s=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:s=this._gl.RED_INTEGER;break;case 9:s=this._gl.RG_INTEGER;break;case 10:s=this._gl.RGB_INTEGER;break;case 11:s=this._gl.RGBA_INTEGER;break}return s}_getRGBABufferInternalSizedFormat(e,t,s=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return s?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return s?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return s?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return s?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,s,i,r=!0,n=!0,h=null){const l=r?4:3,o=r?this._gl.RGBA:this._gl.RGB,c=s*i*l;if(!h)h=new Uint8Array(c);else if(h.length<c)return m.Error(`Data buffer is too small to store the read pixels (${h.length} should be more than ${c})`),Promise.resolve(h);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,s,i,o,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=K._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=K._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}I._TempClearColorUint32=new Uint32Array(4);I._TempClearColorInt32=new Int32Array(4);I.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];I._ConcatenateShader=mt;I._IsSupported=null;I._HasMajorPerformanceCaveat=null;var yi=Object.freeze({__proto__:null,ThinEngine:I});I.prototype.setAlphaMode=function(a,e=!1,t=0){if(this._alphaMode[t]===a){if(!e){const i=a===0;this.depthCullingState.depthMask!==i&&(this.depthCullingState.depthMask=i)}return}const s=a===0;this._alphaState.setAlphaBlend(!s,t),this._alphaState.setAlphaMode(a,t),e||(this.depthCullingState.depthMask=s),this._alphaMode[t]=a};class ye{constructor(e,t,s,i){this.x=e,this.y=t,this.width=s,this.height=i}toGlobal(e,t){return new ye(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,s){return s.x=this.x*e,s.y=this.y*t,s.width=this.width*e,s.height=this.height*t,this}clone(){return new ye(this.x,this.y,this.width,this.height)}}class fe{static _updateFlagSeed=0;updateFlag=-1;_data;constructor(){this._data=new Float32Array(16)}setValues(e,t,s,i,r,n,h,l,o,c,u,f,_,g,T,b){const d=this._data;return d[0]=e,d[1]=t,d[2]=s,d[3]=i,d[4]=r,d[5]=n,d[6]=h,d[7]=l,d[8]=o,d[9]=c,d[10]=u,d[11]=f,d[12]=_,d[13]=g,d[14]=T,d[15]=b,this.updateFlag=fe._updateFlagSeed++,this}identity(){return this.setValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}orthoOffCenterLH(e,t,s,i,r,n){const h=r,l=n,o=2/(t-e),c=2/(i-s),u=2/(l-h),f=-(l+h)/(l-h),_=(e+t)/(e-t),g=(i+s)/(s-i);return this.setValues(o,0,0,0,0,c,0,0,0,0,u,0,_,g,f,1),this}compose(e,t,s){const i=t*.5,r=0,n=0,h=Math.sin(i),l=Math.cos(i),o=r+r,c=n+n,u=h+h,f=r*o,_=r*c,g=r*u,T=n*c,b=n*u,d=h*u,p=l*o,R=l*c,x=l*u,w=e.x,C=e.y,v=1,A=(1-(T+d))*w,O=(_+x)*w,U=(g-R)*w,N=0,P=(_-x)*C,M=(1-(f+d))*C,$=(b+p)*C,Q=0,J=(g+R)*v,ee=(b-p)*v,te=(1-(f+T))*v,se=0,_e=s.x,Fe=s.y;return this.setValues(A,O,U,N,P,M,$,Q,J,ee,te,se,_e,Fe,0,1),this}multiply(e){const t=this._data,s=e._data,i=t[0],r=t[1],n=t[2],h=t[3],l=t[4],o=t[5],c=t[6],u=t[7],f=t[8],_=t[9],g=t[10],T=t[11],b=t[12],d=t[13],p=t[14],R=t[15],x=s[0],w=s[1],C=s[2],v=s[3],A=s[4],O=s[5],U=s[6],N=s[7],P=s[8],M=s[9],$=s[10],Q=s[11],J=s[12],ee=s[13],te=s[14],se=s[15],_e=i*x+r*A+n*P+h*J,Fe=i*w+r*O+n*M+h*ee,Ye=i*C+r*U+n*$+h*te,$e=i*v+r*N+n*Q+h*se,Pt=l*x+o*A+c*P+u*J,Dt=l*w+o*O+c*M+u*ee,Bt=l*C+o*U+c*$+u*te,Mt=l*v+o*N+c*Q+u*se,Lt=f*x+_*A+g*P+T*J,Ot=f*w+_*O+g*M+T*ee,Ut=f*C+_*U+g*$+T*te,Gt=f*v+_*N+g*Q+T*se,kt=b*x+d*A+p*P+R*J,Nt=b*w+d*O+p*M+R*ee,Vt=b*C+d*U+p*$+R*te,Ht=b*v+d*N+p*Q+R*se;return this.setValues(_e,Fe,Ye,$e,Pt,Dt,Bt,Mt,Lt,Ot,Ut,Gt,kt,Nt,Vt,Ht),this}rotationPerspective(e,t,s){const i=Math.sin(-t),r=Math.cos(-t),n=1-r,h=-1/s,l=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);e.x/=l,e.y/=l,e.z/=l;const o=e.x*e.x*n+r,c=e.x*e.y*n-e.z*i,u=e.x*e.z*n+e.y*i,f=0+u*h,_=e.y*e.x*n+e.z*i,g=e.y*e.y*n+r,T=e.y*e.z*n-e.x*i,b=0+T*h,d=e.z*e.x*n-e.y*i,p=e.z*e.y*n+e.x*i,R=e.z*e.z*n+r,x=0+R*h,w=0,C=0,v=0,A=1+v*h;return this.setValues(o,c,u,f,_,g,T,b,d,p,R,x,w,C,v,A),this}asArray(){return this._data}decompose(e,t){const s=this._data[0],i=this._data[1],r=this._data[4],n=this._data[5];e.x=Math.hypot(s,r),e.y=Math.hypot(i,n);const h=Math.atan2(r,s);return t.x=this._data[12],t.y=this._data[13],h}}class z{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new z(this.width*e,this.height*t)}clone(){return new z(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new z(0,0)}add(e){return new z(this.width+e.width,this.height+e.height)}subtract(e){return new z(this.width-e.width,this.height-e.height)}scale(e){return new z(this.width*e,this.height*e)}static Lerp(e,t,s){const i=e.width+(t.width-e.width)*s,r=e.height+(t.height-e.height)*s;return new z(i,r)}}class Ke{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return e?.shareDepth!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=z.Zero(),this._cachedBaseSize=z.Zero(),this._initialSamplingMode=2,this._texture=Ke._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine(),this.wrapU=this._texture._cachedWrapU??this.wrapU,this.wrapV=this._texture._cachedWrapV??this.wrapV,this.wrapR=this._texture._cachedWrapR??this.wrapR)}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture,this._texture.generateMipMaps)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}I.prototype.createDynamicTexture=function(a,e,t,s){const i=new ae(this,4);return i.baseWidth=a,i.baseHeight=e,t&&(a=this.needPOTTextures?Ee(a,this._caps.maxTextureSize):a,e=this.needPOTTextures?Ee(e,this._caps.maxTextureSize):e),i.width=a,i.height=e,i.isReady=!1,i.generateMipMaps=t,i.samplingMode=s,this.updateTextureSamplingMode(s,i),this._internalTexturesCache.push(i),i};I.prototype.updateDynamicTexture=function(a,e,t,s=!1,i,r=!1,n=!1){if(!a)return;const h=this._gl,l=h.TEXTURE_2D,o=this._bindTextureDirectly(l,a,!0,r);this._unpackFlipY(t===void 0?a.invertY:t),s&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this._getWebGLTextureType(a.type),u=this._getInternalFormat(i||a.format),f=this._getRGBABufferInternalSizedFormat(a.type,u);h.texImage2D(l,0,f,u,c,e),a.generateMipMaps&&h.generateMipmap(l),o||this._bindTextureDirectly(l,null),s&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),i&&(a.format=i),a._dynamicTextureSource=e,a._premulAlpha=s,a.invertY=t||!1,a.isReady=!0};function Ns(a){const e=[];if(a.it!==void 0)for(let t=0;t<a.it.length;t++)a.it[t].ty==="rc"?Vs(e,a.it[t]):a.it[t].ty==="sh"&&Hs(e,a.it[t]);return Xs(e)}function Vs(a,e){const t=e.s.k,s=e.p.k;a.push({x:s[0]-t[0]/2,y:s[1]-t[1]/2}),a.push({x:s[0]+t[0]/2,y:s[1]-t[1]/2}),a.push({x:s[0]+t[0]/2,y:s[1]+t[1]/2}),a.push({x:s[0]-t[0]/2,y:s[1]+t[1]/2})}function Hs(a,e){const t=e.ks.k,s=t.v,i=t.i,r=t.o;for(let n=0;n<s.length;n++)a.push({x:s[n][0],y:s[n][1]});for(let n=0;n<s.length-1;n++){const h=s[n],l=s[n+1],o=r[n],c=i[n+1];a.push(...Ws(h[0],h[1],l[0],l[1],h[0]+o[0],h[1]+o[1],l[0]+c[0],l[1]+c[1]))}}function Ws(a,e,t,s,i,r,n,h){const l=[],o=3*(t-3*n+3*i-a),c=6*(n-2*i+a),u=3*(i-a),f=3*(s-3*h+3*r-e),_=6*(h-2*r+e),g=3*(r-e),T=at(o,c,u),b=at(f,_,g),d=new Set(T.concat(b));for(const p of d)if(p>=0&&p<=1){const R=1-p,x=R*R,w=x*R,C=p*p,v=C*p,A=w*a+3*x*p*i+3*R*C*n+v*t,O=w*e+3*x*p*r+3*R*C*h+v*s;l.push({x:A,y:O})}return l}function at(a,e,t){const s=[];if(Math.abs(a)<1e-10){if(Math.abs(e)>1e-10){const r=-t/e;s.push(r)}return s}const i=e*e-4*a*t;if(i<0)return s;if(Math.abs(i)<1e-10){const r=-e/(2*a);s.push(r)}else{const r=Math.sqrt(i),n=(-e+r)/(2*a),h=(-e-r)/(2*a);s.push(n),s.push(h)}return s}function Xs(a){let e=1/0,t=1/0,s=-1/0,i=-1/0;for(let r=0;r<a.length;r++)e=Math.min(e,a[r].x),t=Math.min(t,a[r].y),s=Math.max(s,a[r].x),i=Math.max(i,a[r].y);return{width:s-e,height:i-t,centerX:(e+s)/2,centerY:(t+i)/2}}const q=2048;class Ks{_engine;_spritesCanvas;_spritesCanvasContext;_spritesInternalTexture;_spritesTexture;_spriteSheetMap;_isDirty;_currentX;_currentY;_maxRowHeight;get texture(){return this._spritesTexture}constructor(e,t){this._engine=e,t?this._spritesCanvas=t:typeof document<"u"?this._spritesCanvas=document.createElement("canvas"):this._spritesCanvas=new OffscreenCanvas(q,q),this._spritesCanvas.width=q,this._spritesCanvas.height=q,this._spritesCanvasContext=this._spritesCanvas.getContext("2d"),this._spritesInternalTexture=this._engine.createDynamicTexture(q,q,!1,2),this._engine.updateDynamicTexture(this._spritesInternalTexture,this._spritesCanvas,!1),this._spritesTexture=new Ke(this._spritesInternalTexture),this._spritesTexture.wrapU=0,this._spritesTexture.wrapV=0,this._spriteSheetMap={},this._isDirty=!1,this._currentX=0,this._currentY=0,this._maxRowHeight=0}addLottieShape(e,t){let s=this._spriteSheetMap[e.nm];if(s)return s;s={xOffset:0,yOffset:0,widthPx:0,heightPx:0};const i=Ns(e);return s.widthPx=Math.ceil(i.width*t.x),s.heightPx=Math.ceil(i.height*t.y),this._currentX+s.widthPx>q&&(this._currentX=0,this._currentY+=this._maxRowHeight+1,this._maxRowHeight=0),s.xOffset=this._currentX/q,s.yOffset=this._currentY/q,this._drawVectorShape(e,i,t),this._currentX+=s.widthPx+1,this._maxRowHeight=Math.max(this._maxRowHeight,s.heightPx),this._spriteSheetMap[e.nm]=s,this._isDirty=!0,s}updateAtlasTexture(){this._isDirty&&(this._engine.updateDynamicTexture(this._spritesInternalTexture,this._spritesCanvas,!1),this._isDirty=!1)}_drawVectorShape(e,t,s){if(this._spritesCanvasContext.save(),this._spritesCanvasContext.translate(this._currentX,this._currentY),this._spritesCanvasContext.scale(s.x,s.y),e.it)for(let i=0;i<e.it.length;i++){const r=e.it[i];switch(r.ty){case"rc":this._drawRectangle(r);break;case"sh":this._drawPath(r,t);break;case"fl":this._drawFill(r);break;case"gf":this._drawGradientFill(r,t);break}}this._spritesCanvasContext.restore()}_drawRectangle(e){const t=e.s.k,s=e.r.k;s<=0?this._spritesCanvasContext.rect(0,0,t[0],t[1]):this._spritesCanvasContext.roundRect(0,0,t[0],t[1],s)}_drawPath(e,t){const s=e.ks.k,i=t.width/2-t.centerX,r=t.height/2-t.centerY,n=s.v,h=s.i,l=s.o;if(this._spritesCanvasContext.beginPath(),n.length>0){this._spritesCanvasContext.moveTo(n[0][0]+i,n[0][1]+r);for(let o=0;o<n.length-1;o++){const c=n[o],u=n[o+1],f=l[o],_=h[o+1];this._spritesCanvasContext.bezierCurveTo(c[0]+i+f[0],c[1]+r+f[1],u[0]+i+_[0],u[1]+r+_[1],u[0]+i,u[1]+r)}if(s.c){const o=n[n.length-1],c=n[0],u=l[n.length-1],f=h[0];this._spritesCanvasContext.bezierCurveTo(o[0]+i+u[0],o[1]+r+u[1],c[0]+i+f[0],c[1]+r+f[1],c[0]+i,c[1]+r),this._spritesCanvasContext.closePath()}}}_drawFill(e){const t=this._lottieColorToCSSColor(e.c.k,e.o.k/100);this._spritesCanvasContext.fillStyle=t,this._spritesCanvasContext.fill()}_drawGradientFill(e,t){switch(e.t){case 1:{this._drawLinearGradientFill(e,t);break}case 2:{this._drawRadialGradientFill(e,t);break}}}_drawLinearGradientFill(e,t){const s=t.width/2-t.centerX,i=t.height/2-t.centerY,r=e.s.k,n=e.e.k,h=this._spritesCanvasContext.createLinearGradient(r[0]+s,r[1]+i,n[0]+s,n[1]+i);this._addColorStops(h,e),this._spritesCanvasContext.fillStyle=h,this._spritesCanvasContext.fill()}_drawRadialGradientFill(e,t){const s=t.width/2-t.centerX,i=t.height/2-t.centerY,r=e.s.k,n=e.e.k,h=this._spritesCanvasContext.createRadialGradient(r[0]+s,r[1]+i,0,n[0]+s,n[1]+i,Math.hypot(n[0]-r[0],n[1]-r[1]));this._addColorStops(h,e),this._spritesCanvasContext.fillStyle=h,this._spritesCanvasContext.fill()}_addColorStops(e,t){const s=t.g.p,i=t.g.k.k;let r;if(i.length/s===4)r=this._gradientColorsToCssColor(i,s,!1);else if(i.length/s===6)r=this._gradientColorsToCssColor(i,s,!0);else return;for(let n=0;n<s;n++)e.addColorStop(r[n].offset,r[n].color)}_gradientColorsToCssColor(e,t,s){const i=s?0:1,r=[];for(let n=0;n<t;n++){const h=n*4;r.push({offset:e[h],color:this._lottieColorToCSSColor(e.slice(h+i,h+4),1)})}return r}_lottieColorToCSSColor(e,t){if(e.length!==3&&e.length!==4)return"rgba(0, 0, 0, 1)";const s=Math.round(e[0]*255),i=Math.round(e[1]*255),r=Math.round(e[2]*255),n=(e[3]||1)*t;return`rgba(${s}, ${i}, ${r}, ${n})`}}class he{x1;y1;x2;y2;constructor(e=0,t=0,s=1,i=1){this.x1=e,this.y1=t,this.x2=s,this.y2=i}interpolate(e){if(e===0)return 0;const t=1-3*this.x2+3*this.x1,s=3*this.x2-6*this.x1,i=3*this.x1;let r=e;for(let n=0;n<5;n++){const h=r*r,l=h*r,o=t*l+s*h+i*r,c=1/(3*t*h+2*s*r+i);r-=(o-e)*c,r=Math.min(1,Math.max(0,r))}return 3*Math.pow(1-r,2)*r*this.y1+3*(1-r)*Math.pow(r,2)*this.y2+Math.pow(r,3)}}class Re{_id;_position;_rotation;_scale;_worldMatrix;_opacity;_parent;_children;_gradient;_easeGradientFactor;_currentVector2Keyframe;_nextVector2Keyframe;_currentScalarKeyframe;_nextScalarKeyframe;_currentFrameIndex;_isVisible=!0;get id(){return this._id}get worldMatrix(){return this._worldMatrix}get opacity(){return this._isVisible?this._opacity.currentValue/100:0}constructor(e,t,s,i,r,n){this._gradient=0,this._easeGradientFactor=0,this._currentFrameIndex=-1,this._id=e,this._position=t||{startValue:{x:0,y:0},currentValue:{x:0,y:0},currentKeyframeIndex:0},this._rotation=s||{startValue:0,currentValue:0,currentKeyframeIndex:0},this._scale=i||{startValue:{x:1,y:1},currentValue:{x:1,y:1},currentKeyframeIndex:0},this._worldMatrix=new fe,this._opacity=r||{startValue:100,currentValue:100,currentKeyframeIndex:0},this._children=[],n&&(this._parent=n,n._children.push(this))}get parent(){return this._parent}set isVisible(e){this._isVisible=e;for(let t=0;t<this._children.length;t++)this._children[t].isVisible=e}reset(){this._position.currentValue=this._position.startValue,this._position.keyframes&&(this._position.currentKeyframeIndex=0),this._rotation.currentValue=this._rotation.startValue,this._rotation.keyframes&&(this._rotation.currentKeyframeIndex=0),this._scale.currentValue=this._scale.startValue,this._scale.keyframes&&(this._scale.currentKeyframeIndex=0),this._opacity.currentValue=this._opacity.startValue,this._opacity.keyframes&&(this._opacity.currentKeyframeIndex=0);for(let e=0;e<this._children.length;e++)this._children[e].reset()}update(e){this._updatePosition(e),this._updateRotation(e),this._updateScale(e),this._updateOpacity(e),this._worldMatrix.compose(this._scale.currentValue,this._rotation.currentValue,this._position.currentValue),this._parent&&this._worldMatrix.multiply(this._parent._worldMatrix);for(let t=0;t<this._children.length;t++)this._children[t].update(e)}_updatePosition(e){if(!(this._position.keyframes===void 0||this._position.keyframes.length===0)&&!(e<this._position.keyframes[0].time)){if(e>this._position.keyframes[this._position.keyframes.length-1].time){this._position.currentValue=this._position.keyframes[this._position.keyframes.length-1].value;return}this._currentFrameIndex=-1;for(let t=this._position.currentKeyframeIndex;t<this._position.keyframes.length-1;t++)if(e>=this._position.keyframes[t].time&&e<this._position.keyframes[t+1].time){this._currentFrameIndex=t;break}this._currentFrameIndex!==-1&&(this._currentVector2Keyframe=this._position.keyframes[this._currentFrameIndex],this._nextVector2Keyframe=this._position.keyframes[this._currentFrameIndex+1],this._gradient=(e-this._currentVector2Keyframe.time)/(this._nextVector2Keyframe.time-this._currentVector2Keyframe.time),this._easeGradientFactor=this._currentVector2Keyframe.easeFunction1.interpolate(this._gradient),this._position.currentValue.x=this._currentVector2Keyframe.value.x+this._easeGradientFactor*(this._nextVector2Keyframe.value.x-this._currentVector2Keyframe.value.x),this._easeGradientFactor=this._currentVector2Keyframe.easeFunction2.interpolate(this._gradient),this._position.currentValue.y=this._currentVector2Keyframe.value.y+this._easeGradientFactor*(this._nextVector2Keyframe.value.y-this._currentVector2Keyframe.value.y))}}_updateRotation(e){if(!(this._rotation.keyframes===void 0||this._rotation.keyframes.length===0)&&!(e<this._rotation.keyframes[0].time)){if(e>this._rotation.keyframes[this._rotation.keyframes.length-1].time){this._rotation.currentValue=this._rotation.keyframes[this._rotation.keyframes.length-1].value;return}this._currentFrameIndex=-1;for(let t=this._rotation.currentKeyframeIndex;t<this._rotation.keyframes.length-1;t++)if(e>=this._rotation.keyframes[t].time&&e<this._rotation.keyframes[t+1].time){this._currentFrameIndex=t;break}this._currentFrameIndex!==-1&&(this._currentScalarKeyframe=this._rotation.keyframes[this._currentFrameIndex],this._nextScalarKeyframe=this._rotation.keyframes[this._currentFrameIndex+1],this._gradient=(e-this._currentScalarKeyframe.time)/(this._nextScalarKeyframe.time-this._currentScalarKeyframe.time),this._easeGradientFactor=this._currentScalarKeyframe.easeFunction.interpolate(this._gradient),this._rotation.currentValue=-((this._currentScalarKeyframe.value+this._easeGradientFactor*(this._nextScalarKeyframe.value-this._currentScalarKeyframe.value))*Math.PI)/180)}}_updateScale(e){if(!(this._scale.keyframes===void 0||this._scale.keyframes.length===0)&&!(e<this._scale.keyframes[0].time)){if(e>this._scale.keyframes[this._scale.keyframes.length-1].time){this._scale.currentValue=this._scale.keyframes[this._scale.keyframes.length-1].value;return}this._currentFrameIndex=-1;for(let t=this._scale.currentKeyframeIndex;t<this._scale.keyframes.length-1;t++)if(e>=this._scale.keyframes[t].time&&e<this._scale.keyframes[t+1].time){this._currentFrameIndex=t;break}this._currentFrameIndex!==-1&&(this._currentVector2Keyframe=this._scale.keyframes[this._currentFrameIndex],this._nextVector2Keyframe=this._scale.keyframes[this._currentFrameIndex+1],this._gradient=(e-this._currentVector2Keyframe.time)/(this._nextVector2Keyframe.time-this._currentVector2Keyframe.time),this._easeGradientFactor=this._currentVector2Keyframe.easeFunction1.interpolate(this._gradient),this._scale.currentValue.x=this._currentVector2Keyframe.value.x+this._easeGradientFactor*(this._nextVector2Keyframe.value.x-this._currentVector2Keyframe.value.x),this._easeGradientFactor=this._currentVector2Keyframe.easeFunction2.interpolate(this._gradient),this._scale.currentValue.y=this._currentVector2Keyframe.value.y+this._easeGradientFactor*(this._nextVector2Keyframe.value.y-this._currentVector2Keyframe.value.y))}}_updateOpacity(e){if(!(this._opacity.keyframes===void 0||this._opacity.keyframes.length===0)&&!(e<this._opacity.keyframes[0].time)){if(e>this._opacity.keyframes[this._opacity.keyframes.length-1].time){this._opacity.currentValue=this._opacity.keyframes[this._opacity.keyframes.length-1].value;return}this._currentFrameIndex=-1;for(let t=this._opacity.currentKeyframeIndex;t<this._opacity.keyframes.length-1;t++)if(e>=this._opacity.keyframes[t].time&&e<this._opacity.keyframes[t+1].time){this._currentFrameIndex=t;break}this._currentFrameIndex!==-1&&(this._currentScalarKeyframe=this._opacity.keyframes[this._currentFrameIndex],this._nextScalarKeyframe=this._opacity.keyframes[this._currentFrameIndex+1],this._gradient=(e-this._currentScalarKeyframe.time)/(this._nextScalarKeyframe.time-this._currentScalarKeyframe.time),this._easeGradientFactor=this._currentScalarKeyframe.easeFunction.interpolate(this._gradient),this._opacity.currentValue=this._currentScalarKeyframe.value+this._easeGradientFactor*(this._nextScalarKeyframe.value-this._currentScalarKeyframe.value))}}}class zs extends Re{_inFrame;_outFrame;constructor(e,t,s,i,r,n,h,l){super(e,i,r,n,h,l),this._inFrame=t,this._outFrame=s}update(e){e>=this._inFrame&&e<=this._outFrame?(super.update(e),this.isVisible=!0):this.isVisible=!1}}class Ys{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,s,i,r){this._fromIndex=e,this._toIndex=t,this._loopAnimation=s,this._delay=i||1,this._animationStarted=!0,this._onBaseAnimationEnd=r,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}const Me={x:1,y:1};class $s extends Re{_sprite;_originalWidth;_originalHeight;constructor(e,t,s,i,r,n,h){super(e,s,i,r,n,h),this._sprite=t,this._originalWidth=t.width,this._originalHeight=t.height}update(e){super.update(e);const t=this.worldMatrix.decompose(Me,this._sprite.position);this._sprite.width=this._originalWidth*Me.x,this._sprite.height=this._originalHeight*Me.y,this._sprite.angle=t,this._sprite.color.a=this.opacity}}function js(a,e,t,s){switch(e){case 5120:{let i=a.getInt8(t);return s&&(i=Math.max(i/127,-1)),i}case 5121:{let i=a.getUint8(t);return s&&(i=i/255),i}case 5122:{let i=a.getInt16(t,!0);return s&&(i=Math.max(i/32767,-1)),i}case 5123:{let i=a.getUint16(t,!0);return s&&(i=i/65535),i}case 5124:return a.getInt32(t,!0);case 5125:return a.getUint32(t,!0);case 5126:return a.getFloat32(t,!0);default:throw new Error(`Invalid component type ${e}`)}}function qs(a,e,t,s,i){switch(e){case 5120:{s&&(i=Math.round(i*127)),a.setInt8(t,i);break}case 5121:{s&&(i=Math.round(i*255)),a.setUint8(t,i);break}case 5122:{s&&(i=Math.round(i*32767)),a.setInt16(t,i,!0);break}case 5123:{s&&(i=Math.round(i*65535)),a.setUint16(t,i,!0);break}case 5124:{a.setInt32(t,i,!0);break}case 5125:{a.setUint32(t,i,!0);break}case 5126:{a.setFloat32(t,i,!0);break}default:throw new Error(`Invalid component type ${e}`)}}function ie(a){switch(a){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${a}'`)}}function Ne(a,e,t,s,i,r,n,h){const l=new Array(s),o=new Array(s);if(a instanceof Array){let c=e/4;const u=t/4;for(let f=0;f<r;f+=s){for(let _=0;_<s;_++)l[_]=o[_]=a[c+_];h(o,f);for(let _=0;_<s;_++)l[_]!==o[_]&&(a[c+_]=o[_]);c+=u}}else{const c=ArrayBuffer.isView(a)?new DataView(a.buffer,a.byteOffset,a.byteLength):new DataView(a),u=ie(i);for(let f=0;f<r;f+=s){for(let _=0,g=e;_<s;_++,g+=u)l[_]=o[_]=js(c,i,g,n);h(o,f);for(let _=0,g=e;_<s;_++,g+=u)l[_]!==o[_]&&qs(c,i,g,n,o[_]);e+=t}}}function ht(a,e,t,s,i,r,n,h){const l=e*ie(t),o=n*e;if(t!==5126||i!==l){const c=new Float32Array(o);return Ne(a,s,i,e,t,o,r,(u,f)=>{for(let _=0;_<e;_++)c[f+_]=u[_]}),c}if(!(a instanceof Array||a instanceof Float32Array)||s!==0||a.length!==o)if(a instanceof Array){const c=s/4;return a.slice(c,c+o)}else{if(a instanceof ArrayBuffer)return new Float32Array(a,s,o);{const c=a.byteOffset+s;return(c&3)!==0&&(m.Warn("Float array must be aligned to 4-bytes border"),h=!0),h?new Float32Array(a.buffer.slice(c,c+o*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(a.buffer,c,o)}}return h?a.slice():a}class Ae{get isDisposed(){return this._isDisposed}constructor(e,t,s,i=0,r=!1,n=!1,h=!1,l,o){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=s,this._instanced=n,this._divisor=l||1,this._label=o,t instanceof de?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=h?i:i*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(e,t,s,i,r,n=!1,h){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,o=i?n?i:i*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new E(this._engine,this,e,this._updatable,!0,o,r===void 0?this._instanced:r,l,s,void 0,void 0,!0,this._divisor||h)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}m.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,s,i=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,i?t:t*Float32Array.BYTES_PER_ELEMENT,s?s*this.byteStride:void 0),t===0&&s===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class E{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,s,i,r,n,h,l,o,c,u=!1,f=!1,_=1,g=!1){this._isDisposed=!1;let T=!1;if(this.engine=e,typeof i=="object"&&i!==null?(T=i.updatable??!1,r=i.postponeInternalCreation,n=i.stride,h=i.instanced,l=i.offset,o=i.size,c=i.type,u=i.normalized??!1,f=i.useBytes??!1,_=i.divisor??1,g=i.takeBufferOwnership??!1,this._label=i.label):T=!!i,t instanceof Ae?(this._buffer=t,this._ownsBuffer=g):(this._buffer=new Ae(e,t,T,n,r,h,f,_,this._label),this._ownsBuffer=!0),this.uniqueId=E._Counter++,this._kind=s,c===void 0){const d=this.getData();this.type=d?E.GetDataType(d):E.FLOAT}else this.type=c;const b=ie(this.type);f?(this._size=o||(n?n/b:E.DeduceStride(s)),this.byteStride=n||this._buffer.byteStride||this._size*b,this.byteOffset=l||0):(this._size=o||n||E.DeduceStride(s),this.byteStride=n?n*b:this._buffer.byteStride||this._size*b,this.byteOffset=(l||0)*b),this.normalized=u,this._instanced=h!==void 0?h:!1,this._instanceDivisor=h?_:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const s=this.getData();return s?ht(s,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/ie(this.type)}getOffset(){return this.byteOffset/ie(this.type)}getSize(e=!1){return e?this._size*ie(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,s=!1){this._buffer.updateDirectly(e,t,void 0,s),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){Ne(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,(s,i)=>{for(let r=0;r<this._size;r++)t(s[r],i+r)})}_alignBuffer(){}static DeduceStride(e){switch(e){case E.UVKind:case E.UV2Kind:case E.UV3Kind:case E.UV4Kind:case E.UV5Kind:case E.UV6Kind:return 2;case E.NormalKind:case E.PositionKind:return 3;case E.ColorKind:case E.ColorInstanceKind:case E.MatricesIndicesKind:case E.MatricesIndicesExtraKind:case E.MatricesWeightsKind:case E.MatricesWeightsExtraKind:case E.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?E.BYTE:e instanceof Uint8Array?E.UNSIGNED_BYTE:e instanceof Int16Array?E.SHORT:e instanceof Uint16Array?E.UNSIGNED_SHORT:e instanceof Int32Array?E.INT:e instanceof Uint32Array?E.UNSIGNED_INT:E.FLOAT}static GetTypeByteLength(e){return ie(e)}static ForEach(e,t,s,i,r,n,h,l){Ne(e,t,s,i,r,n,h,(o,c)=>{for(let u=0;u<i;u++)l(o[u],c+u)})}static GetFloatData(e,t,s,i,r,n,h,l){return ht(e,t,s,i,r,n,h,l)}}E._Counter=0;E.BYTE=5120;E.UNSIGNED_BYTE=5121;E.SHORT=5122;E.UNSIGNED_SHORT=5123;E.INT=5124;E.UNSIGNED_INT=5125;E.FLOAT=5126;E.PositionKind="position";E.NormalKind="normal";E.TangentKind="tangent";E.UVKind="uv";E.UV2Kind="uv2";E.UV3Kind="uv3";E.UV4Kind="uv4";E.UV5Kind="uv5";E.UV6Kind="uv6";E.ColorKind="color";E.ColorInstanceKind="instanceColor";E.MatricesIndicesKind="matricesIndices";E.MatricesWeightsKind="matricesWeights";E.MatricesIndicesExtraKind="matricesIndicesExtra";E.MatricesWeightsExtraKind="matricesWeightsExtra";class lt{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,s=!0){this.effect=e,t!==void 0&&(this.defines=t),s&&this.drawContext?.reset()}dispose(e=!1){if(this.effect){const t=this.effect;e?t.dispose():vs.SetImmediate(()=>{t.getEngine().onEndFrameObservable.addOnce(()=>{t.dispose()})}),this.effect=null}this.drawContext?.dispose()}}function ze(a,e){const t=[];for(let s=0;s<a;++s)t.push(e());return t}function Ri(a,e){return ze(a,e)}function Zs(a,e,t){const s=a[e];if(typeof s!="function")return null;const i=function(){const r=a.length,n=i.previous.apply(a,arguments);return t(e,r),n};return s.next=i,i.previous=s,a[e]=i,()=>{const r=i.previous;if(!r)return;const n=i.next;n?(r.next=n,n.previous=r):(r.next=void 0,a[e]=r),i.next=void 0,i.previous=void 0}}const Qs=["push","splice","pop","shift","unshift"];function Ai(a,e){const t=Qs.map(s=>Zs(a,s,e));return()=>{for(const s of t)s?.()}}const Ct={};function Ft(a,e){Ct[a]=e}function Ci(a){return Ct[a]}const Js=1/2.2,ei=2.2,wt=.001;function re(a,e,t=1401298e-51){return Math.abs(a-e)<=t}function Fi(a,e){return a===e?a:Math.random()*(e-a)+a}function wi(a,e,t){return a+(e-a)*t}function ne(a,e=0,t=1){return Math.min(t,Math.max(e,a))}function vi(a){return a-=Math.PI*2*Math.floor((a+Math.PI)/(Math.PI*2)),a}function Y(a){const e=a.toString(16);return a<=15?("0"+e).toUpperCase():e.toUpperCase()}function Ii(a){if(Math.log2)return Math.floor(Math.log2(a));if(a<0)return NaN;if(a===0)return-1/0;let e=0;if(a<1){for(;a<1;)e++,a=a*2;e=-e}else if(a>1)for(;a>1;)e++,a=Math.floor(a/2);return e}function le(a){return Math.pow(a,ei)}function oe(a){return a<=.04045?.0773993808*a:Math.pow(.947867299*(a+.055),2.4)}function ce(a){return Math.pow(a,Js)}function ue(a){return a<=.0031308?12.92*a:1.055*Math.pow(a,.41666)-.055}class S{constructor(e=0,t=0,s=0){this.r=e,this.g=t,this.b=s}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return S.FromArrayToRef(e,t,this),this}toColor4(e=1){return new D(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new S(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,s){return new S(this.r*e,this.g*t,this.b*s)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,s){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(s,this.b),this}maximizeInPlaceFromFloats(e,t,s){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(s,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,s){return this.equalsToFloats(e,t,s)}equalsToFloats(e,t,s){return this.r===e&&this.g===t&&this.b===s}equalsWithEpsilon(e,t=wt){return re(this.r,e.r,t)&&re(this.g,e.g,t)&&re(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new S(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,s){return s.r=ne(this.r,e,t),s.g=ne(this.g,e,t),s.b=ne(this.b,e,t),s}add(e){return new S(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,s){return this.r+=e,this.g+=t,this.b+=s,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new S(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,s){return new S(this.r-e,this.g-t,this.b-s)}subtractFromFloatsToRef(e,t,s,i){return i.r=this.r-e,i.g=this.g-t,i.b=this.b-s,i}clone(){return new S(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,s){return this.r=e,this.g=t,this.b=s,this}set(e,t,s){return this.copyFromFloats(e,t,s)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),s=Math.round(this.b*255);return"#"+Y(e)+Y(t)+Y(s)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,this)}toHSV(){return this.toHSVToRef(new S)}toHSVToRef(e){const t=this.r,s=this.g,i=this.b,r=Math.max(t,s,i),n=Math.min(t,s,i);let h=0,l=0;const o=r,c=r-n;return r!==0&&(l=c/r),r!=n&&(r==t?(h=(s-i)/c,s<i&&(h+=6)):r==s?h=(i-t)/c+2:r==i&&(h=(t-s)/c+4),h*=60),e.r=h,e.g=l,e.b=o,e}toLinearSpace(e=!1){const t=new S;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=oe(this.r),e.g=oe(this.g),e.b=oe(this.b)):(e.r=le(this.r),e.g=le(this.g),e.b=le(this.b)),this}toGammaSpace(e=!1){const t=new S;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=ue(this.r),e.g=ue(this.g),e.b=ue(this.b)):(e.r=ce(this.r),e.g=ce(this.g),e.b=ce(this.b)),this}static HSVtoRGBToRef(e,t,s,i){const r=s*t,n=e/60,h=r*(1-Math.abs(n%2-1));let l=0,o=0,c=0;n>=0&&n<=1?(l=r,o=h):n>=1&&n<=2?(l=h,o=r):n>=2&&n<=3?(o=r,c=h):n>=3&&n<=4?(o=h,c=r):n>=4&&n<=5?(l=h,c=r):n>=5&&n<=6&&(l=r,c=h);const u=s-r;return i.r=l+u,i.g=o+u,i.b=c+u,i}static FromHSV(e,t,s){const i=new S(0,0,0);return S.HSVtoRGBToRef(e,t,s,i),i}static FromHexString(e){return new S(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new S(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,s){s.r=e[t],s.g=e[t+1],s.b=e[t+2]}static FromInts(e,t,s){return new S(e/255,t/255,s/255)}static Lerp(e,t,s){const i=new S(0,0,0);return S.LerpToRef(e,t,s,i),i}static LerpToRef(e,t,s,i){i.r=e.r+(t.r-e.r)*s,i.g=e.g+(t.g-e.g)*s,i.b=e.b+(t.b-e.b)*s}static Hermite(e,t,s,i,r){const n=r*r,h=r*n,l=2*h-3*n+1,o=-2*h+3*n,c=h-2*n+r,u=h-n,f=e.r*l+s.r*o+t.r*c+i.r*u,_=e.g*l+s.g*o+t.g*c+i.g*u,g=e.b*l+s.b*o+t.b*c+i.b*u;return new S(f,_,g)}static Hermite1stDerivative(e,t,s,i,r){const n=S.Black();return this.Hermite1stDerivativeToRef(e,t,s,i,r,n),n}static Hermite1stDerivativeToRef(e,t,s,i,r,n){const h=r*r;n.r=(h-r)*6*e.r+(3*h-4*r+1)*t.r+(-h+r)*6*s.r+(3*h-2*r)*i.r,n.g=(h-r)*6*e.g+(3*h-4*r+1)*t.g+(-h+r)*6*s.g+(3*h-2*r)*i.g,n.b=(h-r)*6*e.b+(3*h-4*r+1)*t.b+(-h+r)*6*s.b+(3*h-2*r)*i.b}static Red(){return new S(1,0,0)}static Green(){return new S(0,1,0)}static Blue(){return new S(0,0,1)}static Black(){return new S(0,0,0)}static get BlackReadOnly(){return S._BlackReadOnly}static White(){return new S(1,1,1)}static Purple(){return new S(.5,0,.5)}static Magenta(){return new S(1,0,1)}static Yellow(){return new S(1,1,0)}static Gray(){return new S(.5,.5,.5)}static Teal(){return new S(0,1,1)}static Random(){return new S(Math.random(),Math.random(),Math.random())}}S._V8PerformanceHack=new S(.5,.5,.5);S._BlackReadOnly=S.Black();Object.defineProperties(S.prototype,{dimension:{value:[3]},rank:{value:1}});class D{constructor(e=0,t=0,s=0,i=1){this.r=e,this.g=t,this.b=s,this.a=i}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new D(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,s,i){return this.r+=e,this.g+=t,this.b+=s,this.a+=i,this}subtract(e){return new D(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,s,i){return new D(this.r-e,this.g-t,this.b-s,this.a-i)}subtractFromFloatsToRef(e,t,s,i,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-s,r.a=this.a-i,r}scale(e){return new D(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,s){return s.r=ne(this.r,e,t),s.g=ne(this.g,e,t),s.b=ne(this.b,e,t),s.a=ne(this.a,e,t),s}multiply(e){return new D(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,s,i){return new D(this.r*e,this.g*t,this.b*s,this.a*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,s,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(s,this.b),this.a=Math.min(i,this.a),this}maximizeInPlaceFromFloats(e,t,s,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(s,this.b),this.a=Math.max(i,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=wt){return re(this.r,e.r,t)&&re(this.g,e.g,t)&&re(this.b,e.b,t)&&re(this.a,e.a,t)}equalsToFloats(e,t,s,i){return this.r===e&&this.g===t&&this.b===s&&this.a===i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new D().copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,s,i){return this.r=e,this.g=t,this.b=s,this.a=i,this}set(e,t,s,i){return this.copyFromFloats(e,t,s,i)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(this.r*255),s=Math.round(this.g*255),i=Math.round(this.b*255);if(e)return"#"+Y(t)+Y(s)+Y(i);const r=Math.round(this.a*255);return"#"+Y(t)+Y(s)+Y(i)+Y(r)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,e.length===9&&(this.a=parseInt(e.substring(7,9),16)/255),this)}toLinearSpace(e=!1){const t=new D;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=oe(this.r),e.g=oe(this.g),e.b=oe(this.b)):(e.r=le(this.r),e.g=le(this.g),e.b=le(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new D;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=ue(this.r),e.g=ue(this.g),e.b=ue(this.b)):(e.r=ce(this.r),e.g=ce(this.g),e.b=ce(this.b)),e.a=this.a,this}static FromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?new D(0,0,0,0):new D(0,0,0,1).fromHexString(e)}static Lerp(e,t,s){return D.LerpToRef(e,t,s,new D)}static LerpToRef(e,t,s,i){return i.r=e.r+(t.r-e.r)*s,i.g=e.g+(t.g-e.g)*s,i.b=e.b+(t.b-e.b)*s,i.a=e.a+(t.a-e.a)*s,i}static Hermite(e,t,s,i,r){const n=r*r,h=r*n,l=2*h-3*n+1,o=-2*h+3*n,c=h-2*n+r,u=h-n,f=e.r*l+s.r*o+t.r*c+i.r*u,_=e.g*l+s.g*o+t.g*c+i.g*u,g=e.b*l+s.b*o+t.b*c+i.b*u,T=e.a*l+s.a*o+t.a*c+i.a*u;return new D(f,_,g,T)}static Hermite1stDerivative(e,t,s,i,r){const n=new D;return this.Hermite1stDerivativeToRef(e,t,s,i,r,n),n}static Hermite1stDerivativeToRef(e,t,s,i,r,n){const h=r*r;n.r=(h-r)*6*e.r+(3*h-4*r+1)*t.r+(-h+r)*6*s.r+(3*h-2*r)*i.r,n.g=(h-r)*6*e.g+(3*h-4*r+1)*t.g+(-h+r)*6*s.g+(3*h-2*r)*i.g,n.b=(h-r)*6*e.b+(3*h-4*r+1)*t.b+(-h+r)*6*s.b+(3*h-2*r)*i.b,n.a=(h-r)*6*e.a+(3*h-4*r+1)*t.a+(-h+r)*6*s.a+(3*h-2*r)*i.a}static FromColor3(e,t=1){return new D(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new D(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,s){s.r=e[t],s.g=e[t+1],s.b=e[t+2],s.a=e[t+3]}static FromInts(e,t,s,i){return new D(e/255,t/255,s/255,i/255)}static CheckColors4(e,t){if(e.length===t*3){const s=[];for(let i=0;i<e.length;i+=3){const r=i/3*4;s[r]=e[i],s[r+1]=e[i+1],s[r+2]=e[i+2],s[r+3]=1}return s}return e}}D._V8PerformanceHack=new D(.5,.5,.5,.5);Object.defineProperties(D.prototype,{dimension:{value:[4]},rank:{value:1}});ze(3,S.Black);ze(3,()=>new D(0,0,0,0));Ft("BABYLON.Color3",S);Ft("BABYLON.Color4",D);class k{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}k.FALLOFF_DEFAULT=0;k.FALLOFF_PHYSICAL=1;k.FALLOFF_GLTF=2;k.FALLOFF_STANDARD=3;k.LIGHTMAP_DEFAULT=0;k.LIGHTMAP_SPECULAR=1;k.LIGHTMAP_SHADOWSONLY=2;k.INTENSITYMODE_AUTOMATIC=0;k.INTENSITYMODE_LUMINOUSPOWER=1;k.INTENSITYMODE_LUMINOUSINTENSITY=2;k.INTENSITYMODE_ILLUMINANCE=3;k.INTENSITYMODE_LUMINANCE=4;k.LIGHTTYPEID_POINTLIGHT=0;k.LIGHTTYPEID_DIRECTIONALLIGHT=1;k.LIGHTTYPEID_SPOTLIGHT=2;k.LIGHTTYPEID_HEMISPHERICLIGHT=3;k.LIGHTTYPEID_RECT_AREALIGHT=4;S.Black();function ti(a,e,t){if(!a||a.LOGARITHMICDEPTH||a.indexOf&&a.indexOf("LOGARITHMICDEPTH")>=0){const s=t.activeCamera;s.mode===1&&m.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(s.maxZ+1)/Math.LN2))}}class Ce{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&m.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,s=.01,i=null,r){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=r?.pixelPerfect??!1,this._capacity=t,this._epsilon=s,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=i,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new Ae(e,this._vertexData,!0,this._vertexBufferSize);const n=this._buffer.createVertexBuffer(E.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let l=6,o;if(this._useInstancing){const _=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new Ae(e,_,!1,2),o=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else o=this._buffer.createVertexBuffer("offsets",l,2,this._vertexBufferSize,this._useInstancing),l+=2;const c=this._buffer.createVertexBuffer("inverts",l,2,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer("cellInfo",l+2,4,this._vertexBufferSize,this._useInstancing),f=this._buffer.createVertexBuffer(E.ColorKind,l+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[E.PositionKind]=n,this._vertexBuffers.options=h,this._vertexBuffers.offsets=o,this._vertexBuffers.inverts=c,this._vertexBuffers.cellInfo=u,this._vertexBuffers[E.ColorKind]=f,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!Ce.ForceGLSL?(this._shaderLanguage=1,await Promise.all([import("./sprites.vertex-D8ws4ll5.js"),import("./sprites.fragment-BomvI92-.js")])):await Promise.all([Promise.resolve().then(function(){return ai}),Promise.resolve().then(function(){return _i})]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){if(this._isDisposed||!this._shadersLoaded)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new lt(this._engine),this._drawWrapperDepth=new lt(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+=`#define PIXEL_PERFECT
`),this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&this._fogEnabled&&(e+=`#define FOG
`),this._useLogarithmicDepth&&(e+=`#define LOGARITHMICDEPTH
`),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[E.PositionKind,"options","offsets","inverts","cellInfo",E.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperBase.effect._refCount++,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,s,i,r=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!e.length)return;const n=this._drawWrapperBase,h=this._drawWrapperDepth,l=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0,o=n.effect;if(!o.isReady())return;const c=this._engine,u=!!(this._scene&&this._scene.useRightHandedSystem),f=Math.min(this._capacity,e.length);let _=0,g=!0;for(let p=0;p<f;p++){const R=e[p];if(!R||!R.isVisible)continue;g=!1,R._animate(t);const x=this.texture.getBaseSize();this._appendSpriteVertex(_++,R,0,0,x,u,r),this._useInstancing||(this._appendSpriteVertex(_++,R,1,0,x,u,r),this._appendSpriteVertex(_++,R,1,1,x,u,r),this._appendSpriteVertex(_++,R,0,1,x,u,r))}if(g)return;this._buffer.update(this._vertexData);const T=!!c.depthCullingState.cull,b=c.depthCullingState.zOffset,d=c.depthCullingState.zOffsetUnits;if(c.setState(T,b,!1,!1,void 0,void 0,d),c.enableEffect(n),o.setTexture("diffuseSampler",this.texture),o.setMatrix("view",s),o.setMatrix("projection",i),l){const p=this._scene;o.setFloat4("vFogInfos",p.fogMode,p.fogStart,p.fogEnd,p.fogDensity),o.setColor3("vFogColor",p.fogColor)}this.useLogarithmicDepth&&this._scene&&ti(n.defines,o,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=c.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,o)),c.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):c.bindBuffers(this._vertexBuffers,this._indexBuffer,o),c.depthCullingState.depthFunc=c.useReverseDepthBuffer?518:515,this.disableDepthWrite||(o.setBool("alphaTest",!0),c.setColorWrite(!1),c.enableEffect(h),this._useInstancing?c.drawArraysType(7,0,4,_):c.drawElementsType(0,0,_/4*6),c.enableEffect(n),c.setColorWrite(!0),o.setBool("alphaTest",!1)),c.setAlphaMode(this.blendMode),this._useInstancing?c.drawArraysType(7,0,4,_):c.drawElementsType(0,0,_/4*6),this.autoResetAlpha&&c.setAlphaMode(0),u&&this._scene.getEngine().setState(T,b,!1,!0,void 0,void 0,d),c.unbindInstanceAttributes()}_appendSpriteVertex(e,t,s,i,r,n,h){let l=e*this._vertexBufferSize;if(s===0?s=this._epsilon:s===1&&(s=1-this._epsilon),i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),h)h(t,r);else{t.cellIndex||(t.cellIndex=0);const o=r.width/this.cellWidth,c=t.cellIndex/o>>0;t._xOffset=(t.cellIndex-c*o)*this.cellWidth/r.width,t._yOffset=c*this.cellHeight/r.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x,this._vertexData[l+1]=t.position.y,this._vertexData[l+2]=t.position.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=s,this._vertexData[l+7]=i),n?this._vertexData[l+8]=t.invertU?0:1:this._vertexData[l+8]=t.invertU?1:0,this._vertexData[l+9]=t.invertV?1:0,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/r.width,this._vertexData[l+13]=t._ySize/r.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let s=0;s<this._capacity;s++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}Ce.ForceGLSL=!1;I.prototype.updateDynamicIndexBuffer=function(a,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(a);let s;a.is32Bits?s=e instanceof Uint32Array?e:new Uint32Array(e):s=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};I.prototype.updateDynamicVertexBuffer=function(a,e,t,s){this.bindArrayBuffer(a),t===void 0&&(t=0);const i=e.byteLength||e.length;s===void 0||s>=i&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e).subarray(0,s/4)):(e instanceof ArrayBuffer?e=new Uint8Array(e,0,s):e=new Uint8Array(e.buffer,e.byteOffset,s),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e)),this._resetVertexBufferBinding()};const ot="fogVertexDeclaration",si=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;y.IncludesShadersStore[ot]||(y.IncludesShadersStore[ot]=si);const ct="logDepthDeclaration",ii=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;y.IncludesShadersStore[ct]||(y.IncludesShadersStore[ct]=ii);const ut="logDepthVertex",ri=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;y.IncludesShadersStore[ut]||(y.IncludesShadersStore[ut]=ri);const Ve="spritesVertexShader",vt=`attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;y.ShadersStore[Ve]||(y.ShadersStore[Ve]=vt);const ni={name:Ve,shader:vt};var ai=Object.freeze({__proto__:null,spritesVertexShader:ni});const _t="fogFragmentDeclaration",hi=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;y.IncludesShadersStore[_t]||(y.IncludesShadersStore[_t]=hi);const ft="logDepthFragment",li=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;y.IncludesShadersStore[ft]||(y.IncludesShadersStore[ft]=li);const dt="fogFragment",oi=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;y.IncludesShadersStore[dt]||(y.IncludesShadersStore[dt]=oi);const gt="imageProcessingCompatibility",ci=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;y.IncludesShadersStore[gt]||(y.IncludesShadersStore[gt]=ci);const He="spritesPixelShader",It=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
vec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}
#endif
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
vec2 uv=uvPixelPerfect(vUV);
#else
vec2 uv=vUV;
#endif
vec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95)
discard;}
color*=vColor;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;y.ShadersStore[He]||(y.ShadersStore[He]=It);const ui={name:He,shader:It};var _i=Object.freeze({__proto__:null,spritesPixelShader:ui});const fi=20;class di{_engine;_spritesRenderer;_spritesTexture;_sprites;constructor(e,t){this._engine=e,this._spritesTexture=t,this._sprites=[],this._spritesRenderer=new Ce(this._engine,fi),this._setupRenderer()}get isReady(){return!0}addSprite(e){this._sprites.push(e)}render(e,t){return this._spritesRenderer.render(this._sprites,0,e,t,this._customSpriteUpdate),!0}dispose(){this._sprites.length=0,this._spritesRenderer.texture=null,this._spritesRenderer.dispose()}_setupRenderer(){this._spritesRenderer.disableDepthWrite=!0,this._spritesRenderer.autoResetAlpha=!1,this._spritesRenderer.fogEnabled=!1,this._spritesRenderer.texture=this._spritesTexture}_customSpriteUpdate=()=>{}}const gi={x:1,y:1},pt={x:0,y:0};class pi{_packer;_unsupportedFeatures;_parentNodes;_rootNodes;_renderingManager;constructor(e,t){this._packer=e,this._renderingManager=t,this._unsupportedFeatures=[],this._parentNodes=new Map,this._rootNodes=[]}debug(){if(this._unsupportedFeatures.length===0)console.log("No unsupported features used for this animation.");else{console.log("List of unsupported features found:");for(let e=0;e<this._unsupportedFeatures.length;e++)console.log(this._unsupportedFeatures[e])}}loadFromFile(e){this._unsupportedFeatures.length=0;const t=JSON.parse(e);for(let s=0;s<t.layers.length;s++)this._parseLayer(t.layers[s]);return this._packer.updateAtlasTexture(),{startFrame:t.ip,endFrame:t.op,frameRate:t.fr,widthPx:t.w,heightPx:t.h,nodes:this._rootNodes}}_parseLayer(e){if(e.hd===!0)return;if(e.ty!==3&&e.ty!==4){this._unsupportedFeatures.push(`UnsupportedLayerType - Index: ${e.ind} Name: ${e.nm} Type: ${e.ty}`);return}if(e.ind===void 0||e.ip===void 0||e.op===void 0||e.st===void 0){this._unsupportedFeatures.push(`Layer without required values - Name: ${e.nm}`);return}let t;e.parent&&(t=this._parentNodes.get(e.parent),t===void 0&&this._unsupportedFeatures.push(`Parent node with index ${e.parent} not found for layer ${e.nm}`));const s=this._parseTransform(e.ks),i=new zs(t?`${t.id} - ${e.nm} - ControlNode (TRS)`:`${e.nm} - ControlNode (TRS)`,e.ip,e.op,s.position,s.rotation,s.scale,s.opacity,t);t||this._rootNodes.push(i);const r=new Re(t?`${t.id} - ${e.nm} - Node (Anchor)`:`${e.nm} - Node (Anchor)`,s.anchorPoint,void 0,void 0,void 0,i);if(this._parentNodes.set(e.ind,r),e.shapes&&e.shapes.length>0){const n={x:s.scale?.startValue.x??1,y:s.scale?.startValue.y??1};this._parseShapes(r,e.shapes,n)}}_parseShapes(e,t,s){for(const i of t)if(i.hd!==!0)if(i.ty==="gr")this._parseGroupShape(e,i,s);else{this._unsupportedFeatures.push(`Only group shapes are supported as children of layers - Name: ${i.nm} Type: ${i.ty}`);continue}}_parseGroupShape(e,t,s){if(!t.it||t.it.length===0)return;let i;for(const l of t.it)l.ty==="gr"?this._unsupportedFeatures.push(`Nested group shapes are not supported. - Group ${t.nm} - Nested Group ${l.nm}`):l.ty==="tr"?i=this._parseTransform(l):l.ty==="sh"?this._validatePathShape(l):l.ty==="rc"?this._validateRectangleShape(l):l.ty==="fl"?this._validateFillShape(l):l.ty==="gf"?this._validateGradientFillShape(l):this._unsupportedFeatures.push(`Unsupported shape type - Name: ${l.nm} Type: ${l.ty}`);if(i===void 0){this._unsupportedFeatures.push(`Group ${t.nm} does not have a transform which is not supported`);return}const r=new Re(`${e.id} - ${t.nm} - ControlNode (TRS)`,i.position,i.rotation,i.scale,i.opacity,e),n=this._packer.addLottieShape(t,s);console.log(`Sprite Info for ${t.nm}:`,{widthPx:n.widthPx,heightPx:n.heightPx,xOffset:n.xOffset,yOffset:n.yOffset,scalingFactor:s});const h=new Ys;h._xOffset=n.xOffset,h._yOffset=n.yOffset,h._xSize=n.widthPx,h._ySize=n.heightPx,h.width=n.widthPx,h.height=n.heightPx,h.invertV=!0,this._renderingManager.addSprite(h),new $s(`${e.id} - ${t.nm} - SpriteNode (Anchor)`,h,i.anchorPoint,void 0,void 0,void 0,r)}_parseTransform(e){return{opacity:this._fromLottieScalarToBabylonScalar(e.o,1),rotation:this._fromLottieScalarToBabylonScalar(e.r,0),scale:this._fromLottieVector2ToBabylonVector2(e.s,"Scale",gi),position:this._fromLottieVector2ToBabylonVector2(e.p,"Position",pt),anchorPoint:this._fromLottieVector2ToBabylonVector2(e.a,"AnchorPoint",pt)}}_fromLottieScalarToBabylonScalar(e,t){if(!e)return{startValue:t,currentValue:t,currentKeyframeIndex:0};if(e.a===0)return{startValue:e.k,currentValue:e.k,currentKeyframeIndex:0};const s=[],i=e.k;let r=0;for(r=0;r<i.length;r++){let n;i[r].o!==void 0&&i[r].i!==void 0&&(Array.isArray(i[r].o.x)?n=new he(i[r].o.x[0],i[r].o.y[0],i[r].i.x[0],i[r].i.y[0]):n=new he(i[r].o.x,i[r].o.y,i[r].i.x,i[r].i.y)),s.push({value:i[r].s[0],time:i[r].t,easeFunction:n})}return{startValue:i[0].s[0],currentValue:i[0].s[0],keyframes:s,currentKeyframeIndex:0}}_fromLottieVector2ToBabylonVector2(e,t,s){if(!e)return{startValue:s,currentValue:s,currentKeyframeIndex:0};if(e.l!==void 0&&e.l!==2)return this._unsupportedFeatures.push(`Invalid Vector2 Length - Length: ${e.l}`),{startValue:s,currentValue:s,currentKeyframeIndex:0};if(e.a===0){const l=e.k,o=this._calculateFinalVector(l[0],l[1],t);return{startValue:o,currentValue:o,currentKeyframeIndex:0}}const i=[],r=e.k;let n=0;for(n=0;n<r.length;n++){let l;r[n].o!==void 0&&r[n].i!==void 0&&(Array.isArray(r[n].o.x)?l=new he(r[n].o.x[0],r[n].o.y[0],r[n].i.x[0],r[n].i.y[0]):l=new he(r[n].o.x,r[n].o.y,r[n].i.x,r[n].i.y));let o;r[n].o!==void 0&&r[n].i!==void 0&&(Array.isArray(r[n].o.x)?o=new he(r[n].o.x[1],r[n].o.y[1],r[n].i.x[1],r[n].i.y[1]):o=new he(r[n].o.x,r[n].o.y,r[n].i.x,r[n].i.y)),i.push({value:this._calculateFinalVector(r[n].s[0],r[n].s[1],t),time:r[n].t,easeFunction1:l,easeFunction2:o})}const h=this._calculateFinalVector(r[0].s[0],r[0].s[1],t);return{startValue:h,currentValue:h,keyframes:i,currentKeyframeIndex:0}}_calculateFinalVector(e,t,s){const i={x:e,y:t};return s==="Position"?i.y=-i.y:s==="AnchorPoint"?i.x=-i.x:s==="Scale"&&(i.x=i.x/100,i.y=i.y/100),i}_validatePathShape(e){e.ks.a===1&&this._unsupportedFeatures.push(`Path ${e.nm} has animated properties which are not supported`)}_validateRectangleShape(e){e.p.a===1&&this._unsupportedFeatures.push(`Rectangle ${e.nm} has an position property that is animated which is not supported`),e.s.a===1&&this._unsupportedFeatures.push(`Rectangle ${e.nm} has a size property that is animated which is not supported`),e.r.a===1&&this._unsupportedFeatures.push(`Rectangle ${e.nm} has a rounded corners property that is animated which is not supported`)}_validateFillShape(e){e.o.a===1&&this._unsupportedFeatures.push(`Fill ${e.nm} has an opacity property that is animated which is not supported`),e.c.a===1&&this._unsupportedFeatures.push(`Fill ${e.nm} has a color property that is animated which is not supported`)}_validateGradientFillShape(e){e.o.a===1&&this._unsupportedFeatures.push(`Gradient fill ${e.nm} has an opacity property that is animated which is not supported`),e.s.a===1&&this._unsupportedFeatures.push(`Gradient fill ${e.nm} has a start point property that is animated which is not supported`),e.e.a===1&&this._unsupportedFeatures.push(`Gradient fill ${e.nm} has an end point property that is animated which is not supported`)}}const mi=2;function bi(a){return new Promise(e=>setTimeout(e,a))}class xi{_canvas;_isReady;_engine;_spritePacker;_parser;_animation;_viewport;_projectionMatrix;_worldMatrix;_frameDuration;_currentFrame;_isPlaying;_animationFrameId;_lastFrameTime;_deltaTime;_loop;_accumulatedTime;_framesToAdvance;_renderingManager;get view(){return this._engine.getRenderingCanvas()}constructor(e){this._canvas=e,this._canvas.id="babylon-canvas",this._isReady=!1,this._currentFrame=0,this._isPlaying=!1,this._animationFrameId=null,this._lastFrameTime=0,this._deltaTime=0,this._accumulatedTime=0,this._framesToAdvance=0,this._loop=!1,this._frameDuration=1e3/30;const t=!1;//!glInfo.renderer.toLowerCase().includes('intel');
this._engine=new I(this._canvas,t,{alpha:!0,stencil:!1,antialias:t,audioEngine:!1,depth:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0},!1),this._engine.getCaps().parallelShaderCompile=void 0,this._engine.depthCullingState.depthTest=!1,this._engine.stencilState.stencilTest=!1,this._engine.setAlphaMode(mi),this._spritePacker=new Ks(this._engine),this._renderingManager=new di(this._engine,this._spritePacker.texture),this._parser=new pi(this._spritePacker,this._renderingManager),this._projectionMatrix=new fe,this._worldMatrix=new fe,this._worldMatrix.identity(),this._viewport=new ye(0,0,1,1)}async initialize(e){for(this._isReady=!1,this._animation=this._parser.loadFromFile(e),this.setSize(this._animation.widthPx,this._animation.heightPx),this._frameDuration=1e3/this._animation.frameRate;!await this._waitUntilReady(););}playAnimation(e=!1){this._animation===void 0||!this._isReady||(this._currentFrame=0,this._accumulatedTime=0,this._framesToAdvance=0,this._isPlaying=!0,this._loop=e,this._lastFrameTime=0,this._startRenderLoop())}stopAnimation(){this._accumulatedTime=0,this._framesToAdvance=0,this._isPlaying=!1,this._animationFrameId!==null&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null)}setSize(e,t){const{_engine:s,_projectionMatrix:i,_worldMatrix:r}=this,n=1;s.setSize(e*n,t*n),this._canvas.width=e,this._canvas.height=t;const h=r.asArray();h[13]=s.getRenderHeight(),i.orthoOffCenterLH(0,s.getRenderWidth()/n,s.getRenderHeight()/n,0,-100,100)}dispose(){this.stopAnimation(),this._engine.getRenderingCanvas()?.remove(),this._engine.dispose()}_startRenderLoop(){this._isPlaying&&(this._animationFrameId=requestAnimationFrame(e=>{this._deltaTime=e-this._lastFrameTime,this._lastFrameTime=e,this._render(),this._lastFrameTime=performance.now(),this._isPlaying&&this._startRenderLoop()}))}async _waitUntilReady(){return this._isReady?!0:this._animation?(this._renderingManager.isReady?this._isReady=!0:await bi(100),this._isReady):!1}_render(){if(!(!this._animation||!this._isPlaying)&&(this._engine.setViewport(this._viewport),this._accumulatedTime+=this._deltaTime,this._framesToAdvance=Math.floor(this._accumulatedTime/this._frameDuration),!(this._framesToAdvance<=0)&&(this._accumulatedTime-=this._framesToAdvance*this._frameDuration,this._currentFrame+=this._framesToAdvance,!(this._currentFrame<this._animation.startFrame)))){if(this._currentFrame>this._animation.endFrame)if(this._loop){this._currentFrame=this._animation.startFrame%(this._animation.endFrame-this._animation.startFrame);for(let e=0;e<this._animation.nodes.length;e++)this._animation.nodes[e].reset()}else{this._isPlaying=!1;return}for(let e=0;e<this._animation.nodes.length;e++)this._animation.nodes[e].update(this._currentFrame);this._renderingManager.render(this._worldMatrix,this._projectionMatrix)}}}let be=null;onmessage=async function(a){if(a.data.canvas&&a.data.animation){const e=a.data.canvas,t=a.data.animation;be=new xi(e),await be.initialize(t),be.playAnimation(!0)}else a.data.width&&a.data.height&&be&&console.log(`Resize requested: ${a.data.width}x${a.data.height}`)};export{K as A,Ri as B,D as C,lt as D,G as E,yt as F,Ee as G,nt as H,ae as I,Kt as J,Us as K,wi as L,Si as M,ss as N,B as O,Ps as P,yi as Q,Ft as R,y as S,ei as T,E as V,Ze as W,Z as _,m as a,Xt as b,Ai as c,S as d,X as e,k as f,Ii as g,ne as h,L as i,ye as j,Ci as k,I as l,Ti as m,Ei as n,we as o,Gs as p,Is as q,Ke as r,vs as s,wt as t,re as u,vi as v,Fi as w,V as x,Le as y,Rs as z};
