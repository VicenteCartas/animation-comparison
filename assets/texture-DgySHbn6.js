import{C as q,d as H,_ as I,r as Z,O as z,E as Q,s as k,k as X,R as J}from"./worker-C-KDBD9A.js";import{V as S,M as p,Q as K,a as $,T}from"./math.vector-85WCOQKP.js";import{b as j,E as ee,I as te}from"./instantiationTools-Dje2H3Fn.js";class A{constructor(e,t,i,r){this.normal=new S(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new A(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=A._TmpMatrix;e.invertToRef(t);const i=t.m,r=this.normal.x,h=this.normal.y,s=this.normal.z,l=this.d,n=r*i[0]+h*i[1]+s*i[2]+l*i[3],a=r*i[4]+h*i[5]+s*i[6]+l*i[7],c=r*i[8]+h*i[9]+s*i[10]+l*i[11],f=r*i[12]+h*i[13]+s*i[14]+l*i[15];return new A(n,a,c,f)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const r=t.x-e.x,h=t.y-e.y,s=t.z-e.z,l=i.x-e.x,n=i.y-e.y,a=i.z-e.z,c=h*a-s*n,f=s*l-r*a,R=r*n-h*l,y=Math.sqrt(c*c+f*f+R*R);let M;return y!==0?M=1/y:M=0,this.normal.x=c*M,this.normal.y=f*M,this.normal.z=R*M,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return S.Dot(this.normal,e)<=t}signedDistanceTo(e){return S.Dot(e,this.normal)+this.d}static FromArray(e){return new A(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const r=new A(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){const i=new A(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return S.Dot(i,t)+r}}A._TmpMatrix=p.Identity();function d(u,e,t,i){var r=arguments.length,h=r<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")h=Reflect.decorate(u,e,t,i);else for(var l=u.length-1;l>=0;l--)(s=u[l])&&(h=(r<3?s(h):r>3?s(e,t,h):s(e,t))||h);return r>3&&h&&Object.defineProperty(e,t,h),h}const w={},N={};function ie(u){const e=u.getClassName();return N[e]||(N[e]={}),N[e]}function V(u){const e=u.getClassName();if(w[e])return w[e];w[e]={};const t=w[e];let i=u,r=e;for(;r;){const h=N[r];for(const n in h)t[n]=h[n];let s,l=!1;do{if(s=Object.getPrototypeOf(i),!s.getClassName){l=!0;break}if(s.getClassName()!==r)break;i=s}while(s);if(l)break;r=s.getClassName(),i=s}return t}function U(u,e){return(t,i)=>{const r=ie(t);r[i]||(r[i]={type:u,sourceName:e})}}function _(u){return U(0,u)}function re(u){return U(1,u)}function le(u){return U(7,u)}function ce(u){return U(8,u)}class C{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),C._HandleParenthesisContent(i,t))):e=C._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:C.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(h=>h==="true");let i;const r=e.split("||");for(const h in r)if(Object.prototype.hasOwnProperty.call(r,h)){let s=C._SimplifyNegation(r[h].trim());const l=s.split("&&");if(l.length>1)for(let n=0;n<l.length;++n){const a=C._SimplifyNegation(l[n].trim());if(a!=="true"&&a!=="false"?a[0]==="!"?i=!t(a.substring(1)):i=t(a):i=a==="true",!i){s="false";break}}if(i||s==="true"){i=!0;break}s!=="true"&&s!=="false"?s[0]==="!"?i=!t(s.substring(1)):i=t(s):i=s==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class g{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>g.HasTags(e),e.addTags=t=>g.AddTagsTo(e,t),e.removeTags=t=>g.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>g.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const r in e._tags)Object.prototype.hasOwnProperty.call(e._tags,r)&&e._tags[r]===!0&&i.push(r);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;const i=t.split(" ");for(const r of i)g._AddTagTo(e,r)}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(g.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!g.HasTags(e))return;const i=t.split(" ");for(const r in i)g._RemoveTagFrom(e,i[r])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?g.HasTags(e):C.Eval(t,i=>g.HasTags(e)&&e._tags[i])}}const W=function(u,e,t,i={}){const r=u();g&&g.HasTags(e)&&g.AddTagsTo(r,g.GetTags(e,!0));const h=V(r),s={};for(const l in h){const n=h[l],a=e[l],c=n.type;if(a!=null&&(l!=="uniqueId"||x.AllowLoadingUniqueId))switch(c){case 0:case 6:case 9:case 11:r[l]=a;break;case 1:i.cloneTexturesOnlyOnce&&s[a.uniqueId]?r[l]=s[a.uniqueId]:(r[l]=t||a.isRenderTarget?a:a.clone(),s[a.uniqueId]=r[l]);break;case 2:case 3:case 4:case 5:case 7:case 8:case 10:case 12:r[l]=t?a:a.clone();break}}return r};class x{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),g&&(t.tags=g.GetTags(e));const i=V(e);for(const r in i){const h=i[r],s=h.sourceName||r,l=h.type,n=e[r];if(n!=null&&(r!=="uniqueId"||x.AllowLoadingUniqueId))switch(l){case 0:t[s]=n;break;case 1:t[s]=n.serialize();break;case 2:t[s]=n.asArray();break;case 3:t[s]=n.serialize();break;case 4:t[s]=n.asArray();break;case 5:t[s]=n.asArray();break;case 6:t[s]=n.id;break;case 7:t[s]=n.serialize();break;case 8:t[s]=n.asArray();break;case 9:t[s]=n.serialize();break;case 10:t[s]=n.asArray();break;case 11:t[s]=n.id;break;case 12:t[s]=n.asArray();break}}return t}static ParseProperties(e,t,i,r){r||(r="");const h=V(t);for(const s in h){const l=h[s],n=e[l.sourceName||s],a=l.type;if(n!=null&&(s!=="uniqueId"||x.AllowLoadingUniqueId)){const c=t;switch(a){case 0:c[s]=n;break;case 1:i&&(c[s]=x._TextureParser(n,i,r));break;case 2:c[s]=H.FromArray(n);break;case 3:c[s]=x._FresnelParametersParser(n);break;case 4:c[s]=$.FromArray(n);break;case 5:c[s]=S.FromArray(n);break;case 6:i&&(c[s]=i.getLastMeshById(n));break;case 7:c[s]=x._ColorCurvesParser(n);break;case 8:c[s]=q.FromArray(n);break;case 9:c[s]=x._ImageProcessingConfigurationParser(n);break;case 10:c[s]=K.FromArray(n);break;case 11:i&&(c[s]=i.getCameraById(n));break;case 12:c[s]=p.FromArray(n);break}}}}static Parse(e,t,i,r=null){const h=e();return g&&g.AddTagsTo(h,t.tags),x.ParseProperties(t,h,i,r),h}static Clone(e,t,i={}){return W(e,t,!1,i)}static Instanciate(e,t){return W(e,t,!0)}}x.AllowLoadingUniqueId=!1;x._ImageProcessingConfigurationParser=u=>{throw I("ImageProcessingConfiguration")};x._FresnelParametersParser=u=>{throw I("FresnelParameters")};x._ColorCurvesParser=u=>{throw I("ColorCurves")};x._TextureParser=(u,e,t)=>{throw I("Texture")};class m extends Z{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this.getScene()?.markAllMaterialsAsDirty(1,t=>t.hasTexture(this))}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),this.getScene()?.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=j()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=m.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this._dominantDirection=null,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new z,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?m._IsScene(e)?this._scene=e:this._engine=e:this._scene=Q.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return p.IdentityReadOnly}getReflectionTextureMatrix(){return p.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,h,s){const l=this._getEngine();if(!l)return null;const n=l._getUseSRGBBuffer(!!h,t),a=l.getLoadedTexturesCache();for(let c=0;c<a.length;c++){const f=a[c];if((h===void 0||n===f._useSRGBBuffer)&&(r===void 0||r===f.invertY)&&f.url===e&&f.generateMipMaps===!t&&(!i||i===f.samplingMode)&&(s===void 0||s===f.isCube))return f.incrementReferences(),f}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,h=!1,s=0,l=0,n=Number.MAX_VALUE,a=Number.MAX_VALUE){if(!this._texture)return null;const c=this._getEngine();if(!c)return null;const f=this.getSize();let R=f.width,y=f.height;t!==0&&(R=R/Math.pow(2,t),y=y/Math.pow(2,t),R=Math.round(R),y=Math.round(y)),n=Math.min(R,n),a=Math.min(y,a);try{return this._texture.isCube?c._readTexturePixels(this._texture,n,a,e,t,i,r,h,s,l):c._readTexturePixels(this._texture,n,a,-1,t,i,r,h,s,l)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,h=!1){if(!this._texture)return null;const s=this.getSize();let l=s.width,n=s.height;const a=this._getEngine();if(!a)return null;t!=0&&(l=l/Math.pow(2,t),n=n/Math.pow(2,t),l=Math.round(l),n=Math.round(n));try{return this._texture.isCube?a._readTexturePixelsSync(this._texture,l,n,e,t,i,r,h):a._readTexturePixelsSync(this._texture,l,n,-1,t,i,r,h)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=x.Serialize(this);return x.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let r=0;r<e.length;r++){const h=e[r];if(h.isReady())--i===0&&t();else{const s=h.onLoadObservable;s?s.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}m.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;d([_()],m.prototype,"uniqueId",void 0);d([_()],m.prototype,"name",void 0);d([_()],m.prototype,"displayName",void 0);d([_()],m.prototype,"metadata",void 0);d([_("hasAlpha")],m.prototype,"_hasAlpha",void 0);d([_("getAlphaFromRGB")],m.prototype,"_getAlphaFromRGB",void 0);d([_()],m.prototype,"level",void 0);d([_("coordinatesIndex")],m.prototype,"_coordinatesIndex",void 0);d([_()],m.prototype,"optimizeUVAllocation",void 0);d([_("coordinatesMode")],m.prototype,"_coordinatesMode",void 0);d([_()],m.prototype,"wrapU",null);d([_()],m.prototype,"wrapV",null);d([_()],m.prototype,"wrapR",void 0);d([_()],m.prototype,"anisotropicFilteringLevel",void 0);d([_()],m.prototype,"isCube",null);d([_()],m.prototype,"is3D",null);d([_()],m.prototype,"is2DArray",null);d([_()],m.prototype,"gammaSpace",null);d([_()],m.prototype,"invertZ",void 0);d([_()],m.prototype,"lodLevelInAlpha",void 0);d([_()],m.prototype,"lodGenerationOffset",null);d([_()],m.prototype,"lodGenerationScale",null);d([_()],m.prototype,"linearSpecularLOD",null);d([re()],m.prototype,"irradianceTexture",null);d([_()],m.prototype,"isRenderTarget",void 0);function Y(u,e,t=!1){const i=e.width,r=e.height;if(u instanceof Float32Array){let a=u.byteLength/u.BYTES_PER_ELEMENT;const c=new Uint8Array(a);for(;--a>=0;){let f=u[a];f<0?f=0:f>1&&(f=1),c[a]=f*255}u=c}const h=document.createElement("canvas");h.width=i,h.height=r;const s=h.getContext("2d");if(!s)return null;const l=s.createImageData(i,r);if(l.data.set(u),s.putImageData(l,0,0),t){const a=document.createElement("canvas");a.width=i,a.height=r;const c=a.getContext("2d");return c?(c.translate(0,r),c.scale(1,-1),c.drawImage(h,0,0),a.toDataURL("image/png")):null}return h.toDataURL("image/png")}function se(u,e=0,t=0){const i=u.getInternalTexture();if(!i)return null;const r=u._readPixelsSync(e,t);return r?Y(r,u.getSize(),i.invertY):null}async function ne(u,e=0,t=0){const i=u.getInternalTexture();if(!i)return null;const r=await u.readPixels(e,t);return r?Y(r,u.getSize(),i.invertY):null}class o extends m{static _CreateVideoTexture(e,t,i,r=!1,h=!1,s=o.TRILINEAR_SAMPLINGMODE,l={},n,a=5){throw I("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,r,h=o.TRILINEAR_SAMPLINGMODE,s=null,l=null,n=null,a=!1,c,f,R,y,M){super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new z,this._isBlocking=!0,this.name=e||"",this.url=e;let v,O=!1,F=null,B=!0;typeof i=="object"&&i!==null?(v=i.noMipmap??!1,r=i.invertY??!0,h=i.samplingMode??o.TRILINEAR_SAMPLINGMODE,s=i.onLoad??null,l=i.onError??null,n=i.buffer??null,a=i.deleteBuffer??!1,c=i.format,f=i.mimeType,R=i.loaderOptions,y=i.creationFlags,O=i.useSRGBBuffer??!1,F=i.internalTexture??null,B=i.gammaSpace??B,M=i.forcedExtension??M):v=!!i,this._gammaSpace=B,this._noMipmap=v,this._invertY=r===void 0?!0:r,this._initialSamplingMode=h,this._buffer=n,this._deleteBuffer=a,this._mimeType=f,this._loaderOptions=R,this._creationFlags=y,this._useSRGBBuffer=O,this._forcedExtension=M,c!==void 0&&(this._format=c);const b=this.getScene(),G=this._getEngine();if(!G)return;G.onBeforeTextureInitObservable.notifyObservers(this);const L=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),s&&s(),!this.isBlocking&&b&&b.resetCachedMaterial()},P=(E,D)=>{this._loadingError=!0,this._errorObject={message:E,exception:D},l&&l(E,D),o.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!F){this._delayedOnLoad=L,this._delayedOnError=P;return}if(this._texture=F??this._getFromCache(this.url,v,h,this._invertY,O,this.isCube),this._texture)if(this._texture.isReady)k.SetImmediate(()=>L());else{const E=this._texture.onLoadedObservable.add(L);this._texture.onErrorObservable.add(D=>{P(D.message,D.exception),this._texture?.onLoadedObservable.remove(E)})}else if(!b||!b.useDelayedTextureLoading){try{this._texture=G.createTexture(this.url,v,this._invertY,b,h,L,P,this._buffer,void 0,this._format,this._forcedExtension,f,R,y,O)}catch(E){throw P("error loading",E),E}a&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=L,this._delayedOnError=P}updateURL(e,t=null,i,r){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,h=>h.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=r,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?k.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,r){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,S.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,r.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,r.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=p.Zero(),this._rowGenerationMatrix=new p,this._t0=S.Zero(),this._t1=S.Zero(),this._t2=S.Zero()),p.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(p.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,T.Matrix[0]),p.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,T.Matrix[1]),p.ScalingToRef(this._cachedUScale,this._cachedVScale,0,T.Matrix[2]),p.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,T.Matrix[3]),T.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(T.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(T.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(T.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),p.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();if(!t)return this._cachedTextureMatrix;const i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,r=>r.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===o.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=p.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=p.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case o.PLANAR_MODE:{p.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case o.PROJECTION_MODE:{p.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:p.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return x.Clone(()=>new o(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){const e=this.name;o.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const t=super.serialize(o._SerializeInternalTextureUniqueId);if(!t)return null;if(o.SerializeBuffers||o.ForceSerializeBuffers)if(typeof this._buffer=="string"&&this._buffer.startsWith("data:"))t.base64String=this._buffer,t.name=t.name.replace("data:","");else if(this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array){const i=this.mimeType||"image/png";t.base64String=`data:${i};base64,${ee(this._buffer)}`}else(o.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?se(this):ne(this));return t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,o._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=this._texture?.uniqueId),t.internalTextureLabel=this._texture?.label,t.noMipmap=this._noMipmap,this.name=e,t}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const a=te.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&a.updateSamplingMode&&a._samplingMode&&a._samplingMode!==e.samplingMode&&a.updateSamplingMode(e.samplingMode),a}if(e.isCube&&!e.isRenderTarget)return o._CubeTextureParser(e,t,i);const r=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!r)return null;let h;if(r){const n=t.getEngine().getLoadedTexturesCache();for(const a of n)if(a.uniqueId===e.internalTextureUniqueId){h=a;break}}const s=n=>{if(n&&n._texture&&(n._texture._cachedWrapU=null,n._texture._cachedWrapV=null,n._texture._cachedWrapR=null),e.samplingMode){const a=e.samplingMode;n&&n.samplingMode!==a&&n.updateSamplingMode(a)}if(n&&e.animations)for(let a=0;a<e.animations.length;a++){const c=e.animations[a],f=X("BABYLON.Animation");f&&n.animations.push(f.Parse(c))}n&&n._texture&&(r&&!h&&n._texture._setUniqueId(e.internalTextureUniqueId),n._texture.label=e.internalTextureLabel)};return x.Parse(()=>{let n=!0;if(e.noMipmap&&(n=!1),e.mirrorPlane){const a=o._CreateMirror(e.name,e.renderTargetSize,t,n);return a._waitingRenderList=e.renderList,a.mirrorPlane=A.FromArray(e.mirrorPlane),s(a),a}else if(e.isRenderTarget){let a=null;if(e.isCube){if(t.reflectionProbes)for(let c=0;c<t.reflectionProbes.length;c++){const f=t.reflectionProbes[c];if(f.name===e.name)return f.cubeTexture}}else a=o._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,n,e._creationFlags??0),a._waitingRenderList=e.renderList;return s(a),a}else if(e.isVideo){const a=o._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,n,e.invertY,e.samplingMode,e.settings||{});return s(a),a}else{let a;if(e.base64String&&!h)a=o.CreateFromBase64String(e.base64String,e.base64String,t,!n,e.invertY,e.samplingMode,()=>{s(a)},e._creationFlags??0,e._useSRGBBuffer??!1),a.name=e.name;else{let c;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?c=e.name:c=i+e.name,e.url&&(e.url.startsWith("data:")||o.UseSerializedUrlIfAny)&&(c=e.url);const f={noMipmap:!n,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{s(a)},internalTexture:h};a=new o(c,t,f)}return a}},e,t)}static CreateFromBase64String(e,t,i,r,h,s=o.TRILINEAR_SAMPLINGMODE,l=null,n=null,a=5,c,f){return new o("data:"+t,i,r,h,s,l,n,e,!1,a,void 0,void 0,c,f)}static LoadFromDataString(e,t,i,r=!1,h,s=!0,l=o.TRILINEAR_SAMPLINGMODE,n=null,a=null,c=5,f,R){return e.substring(0,5)!=="data:"&&(e="data:"+e),new o(e,i,h,s,l,n,a,t,r,c,void 0,void 0,f,R)}}o.SerializeBuffers=!0;o.ForceSerializeBuffers=!1;o.OnTextureLoadErrorObservable=new z;o._SerializeInternalTextureUniqueId=!1;o._CubeTextureParser=(u,e,t)=>{throw I("CubeTexture")};o._CreateMirror=(u,e,t,i)=>{throw I("MirrorTexture")};o._CreateRenderTargetTexture=(u,e,t,i,r)=>{throw I("RenderTargetTexture")};o.NEAREST_SAMPLINGMODE=1;o.NEAREST_NEAREST_MIPLINEAR=8;o.BILINEAR_SAMPLINGMODE=2;o.LINEAR_LINEAR_MIPNEAREST=11;o.TRILINEAR_SAMPLINGMODE=3;o.LINEAR_LINEAR_MIPLINEAR=3;o.NEAREST_NEAREST_MIPNEAREST=4;o.NEAREST_LINEAR_MIPNEAREST=5;o.NEAREST_LINEAR_MIPLINEAR=6;o.NEAREST_LINEAR=7;o.NEAREST_NEAREST=1;o.LINEAR_NEAREST_MIPNEAREST=9;o.LINEAR_NEAREST_MIPLINEAR=10;o.LINEAR_LINEAR=2;o.LINEAR_NEAREST=12;o.EXPLICIT_MODE=0;o.SPHERICAL_MODE=1;o.PLANAR_MODE=2;o.CUBIC_MODE=3;o.PROJECTION_MODE=4;o.SKYBOX_MODE=5;o.INVCUBIC_MODE=6;o.EQUIRECTANGULAR_MODE=7;o.FIXED_EQUIRECTANGULAR_MODE=8;o.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;o.CLAMP_ADDRESSMODE=0;o.WRAP_ADDRESSMODE=1;o.MIRROR_ADDRESSMODE=2;o.UseSerializedUrlIfAny=!1;d([_()],o.prototype,"url",void 0);d([_()],o.prototype,"uOffset",void 0);d([_()],o.prototype,"vOffset",void 0);d([_()],o.prototype,"uScale",void 0);d([_()],o.prototype,"vScale",void 0);d([_()],o.prototype,"uAng",void 0);d([_()],o.prototype,"vAng",void 0);d([_()],o.prototype,"wAng",void 0);d([_()],o.prototype,"uRotationCenter",void 0);d([_()],o.prototype,"vRotationCenter",void 0);d([_()],o.prototype,"wRotationCenter",void 0);d([_()],o.prototype,"homogeneousRotationInUVTransform",void 0);d([_()],o.prototype,"isBlocking",null);J("BABYLON.Texture",o);x._TextureParser=o.Parse;export{m as B,A as P,x as S,o as T,d as _,le as a,re as b,ce as c,g as d,_ as s};
