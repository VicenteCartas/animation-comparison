class Bt{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,i,s,r,n,h,l){const o=this.engine;if(o.supportsUniformBuffers)for(const _ in t)e.bindUniformBlock(_,t[_]);this.engine.getUniforms(this,i).forEach((_,f)=>{s[i[f]]=_}),this._uniforms=s;let c;for(c=0;c<r.length;c++)e.getUniform(r[c])==null&&(r.splice(c,1),c--);r.forEach((_,f)=>{n[_]=f});for(const _ of o.getAttributes(this,h))l.push(_)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s||s.length!==2)return s=[t,i],this._valueCache[e]=s,!0;let r=!1;return s[0]!==t&&(s[0]=t,r=!0),s[1]!==i&&(s[1]=i,r=!0),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r||r.length!==3)return r=[t,i,s],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),r[2]!==s&&(r[2]=s,n=!0),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n||n.length!==4)return n=[t,i,s,r],this._valueCache[e]=n,!0;let h=!1;return n[0]!==t&&(n[0]=t,h=!0),n[1]!==i&&(n[1]=i,h=!0),n[2]!==s&&(n[2]=s,h=!0),n[3]!==r&&(n[3]=r,h=!0),h}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setUInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}const He={};function $(a,e=!1){if(!(e&&He[a]))return He[a]=!0,`${a} needs to be imported before as it contains a side-effect required by your code.`}function H(){return typeof window<"u"}function Mt(){return typeof navigator<"u"}function Se(){return typeof document<"u"}function Lt(a){let e="",t=a.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const ve={};function ft(a,e,t=""){return t+(e?e+`
`:"")+a}function dt(a,e,t,i,s,r,n){const h=n||ve.loadFile;if(h)return h(a,e,t,i,s,r);throw $("FileTools")}function gt(a,e,t,i){if(a){e?a.IS_NDC_HALF_ZRANGE="":delete a.IS_NDC_HALF_ZRANGE,t?a.USE_REVERSE_DEPTHBUFFER="":delete a.USE_REVERSE_DEPTHBUFFER,i?a.USE_EXACT_SRGB_CONVERSIONS="":delete a.USE_EXACT_SRGB_CONVERSIONS;return}else{let s="";return e&&(s+="#define IS_NDC_HALF_ZRANGE"),t&&(s&&(s+=`
`),s+="#define USE_REVERSE_DEPTHBUFFER"),i&&(s&&(s+=`
`),s+="#define USE_EXACT_SRGB_CONVERSIONS"),s}}function us(a,e,t=!1,i){switch(a){case 3:return e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);case 0:return e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);case 4:return e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);case 5:case 8:case 9:case 10:case 2:return e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);case 6:return e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);case 7:case 11:case 12:case 13:case 14:case 15:return e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);case 1:return e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e)}return e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e)}const Ie=new WeakMap,Ot={_webGLVersion:2,cachedPipelines:{}};function U(a){let e=Ie.get(a);if(!e){if(!a)return Ot;e={_webGLVersion:a.TEXTURE_BINDING_3D?2:1,_context:a,parallelShaderCompile:a.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},Ie.set(a,e)}return e}function Re(a){Ie.delete(a)}function pt(a,e,t,i,s,r){const n=U(i);r||(r=n._createShaderProgramInjection??Ue);const h=De(e,"vertex",i,n._contextWasLost),l=De(t,"fragment",i,n._contextWasLost);return r(a,h,l,i,s,n.validateShaderPrograms)}function mt(a,e,t,i,s,r=null,n){const h=U(s);n||(n=h._createShaderProgramInjection??Ue);const l=h._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",o=We(e,"vertex",i,l,s,h._contextWasLost),u=We(t,"fragment",i,l,s,h._contextWasLost);return n(a,o,u,s,r,h.validateShaderPrograms)}function Ut(a,e){const t=new Bt,i=U(a);return i.parallelShaderCompile&&!i.disableParallelShaderCompile&&(t.isParallelCompiled=!0),t.context=i._context,t}function Ue(a,e,t,i,s=null,r){const n=i.createProgram();if(a.program=n,!n)throw new Error("Unable to create program");return i.attachShader(n,e),i.attachShader(n,t),i.linkProgram(n),a.context=i,a.vertexShader=e,a.fragmentShader=t,a.isParallelCompiled||Ge(a,i,r),n}function Gt(a,e,t){const i=a;if(i._isDisposed)return!1;const s=U(e);return s&&s.parallelShaderCompile&&s.parallelShaderCompile.COMPLETION_STATUS_KHR&&i.program&&e.getProgramParameter(i.program,s.parallelShaderCompile.COMPLETION_STATUS_KHR)?(Ge(i,e,t),!0):!1}function Ge(a,e,t){const i=a.context,s=a.vertexShader,r=a.fragmentShader,n=a.program;if(!i.getProgramParameter(n,i.LINK_STATUS)){if(!e.getShaderParameter(s,e.COMPILE_STATUS)){const o=e.getShaderInfoLog(s);if(o)throw a.vertexCompilationError=o,new Error("VERTEX SHADER "+o)}if(!e.getShaderParameter(r,e.COMPILE_STATUS)){const o=e.getShaderInfoLog(r);if(o)throw a.fragmentCompilationError=o,new Error("FRAGMENT SHADER "+o)}const l=i.getProgramInfoLog(n);if(l)throw a.programLinkError=l,new Error(l)}if(t&&(i.validateProgram(n),!i.getProgramParameter(n,i.VALIDATE_STATUS))){const o=i.getProgramInfoLog(n);if(o)throw a.programValidationError=o,new Error(o)}i.deleteShader(s),i.deleteShader(r),a.vertexShader=void 0,a.fragmentShader=void 0,a.onCompiled&&(a.onCompiled(),a.onCompiled=void 0)}function kt(a,e,t,i,s,r,n,h,l,o="",u,c,_){const f=U(a.context);c||(c=f.createRawShaderProgramInjection??pt),_||(_=f.createShaderProgramInjection??mt);const p=a;i?p.program=c(p,e,t,p.context,l):p.program=_(p,e,t,h,p.context,l),p.program.__SPECTOR_rebuildProgram=n,u()}function We(a,e,t,i,s,r){return De(ft(a,t,i),e,s,r)}function De(a,e,t,i){const s=t.createShader(e==="vertex"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(!s){let r=t.NO_ERROR,n=t.NO_ERROR;for(;(n=t.getError())!==t.NO_ERROR;)r=n;throw new Error(`Something went wrong while creating a gl ${e} shader object. gl error=${r}, gl isContextLost=${t.isContextLost()}, _contextWasLost=${i}`)}return t.shaderSource(s,a),t.compileShader(s),s}function Nt(a,e){e.useProgram(a)}function Vt(a,e){const t=a;if(!t.isParallelCompiled){e(a);return}const i=t.onCompiled;t.onCompiled=()=>{i?.(),e(a)}}function Ht(a){return a.getPipelineContext===void 0}class d{static _CheckLimit(e,t){let i=d._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},d._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){const i=d._LogLimitOutputs[e];if(!i||!d.MessageLimitReached)return;const s=this._Levels[t];i.current===i.limit&&d[s.name](d.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,s.name??""))}static _AddLogEntry(e){d._LogCache=e+d._LogCache,d.OnNewCacheEntry&&d.OnNewCacheEntry(e)}static _FormatMessage(e){const t=s=>s<10?"0"+s:""+s,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const s=Array.isArray(t)?t[0]:t;if(i!==void 0&&!d._CheckLimit(s,i))return;const r=d._FormatMessage(s),n=this._Levels[e],h=Array.isArray(t)?t.slice(1):[];n.logFunc&&n.logFunc("BJS - "+r,...h);const l=`<div style='color:${n.color}'>${r}</div><br>`;d._AddLogEntry(l),d._GenerateLimitMessage(s,e)}static get LogCache(){return d._LogCache}static ClearLogCache(){d._LogCache="",d._LogLimitOutputs={},d.errorsCount=0}static set LogLevels(e){d.Log=d._LogDisabled,d.Warn=d._LogDisabled,d.Error=d._LogDisabled;const t=[d.MessageLogLevel,d.WarningLogLevel,d.ErrorLogLevel];for(const i of t)if((e&i)===i){const s=this._Levels[i];d[s.name]=d._LogEnabled.bind(d,i)}}}d.NoneLogLevel=0;d.MessageLogLevel=1;d.WarningLogLevel=2;d.ErrorLogLevel=4;d.AllLogLevel=7;d.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";d._LogCache="";d._LogLimitOutputs={};d._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];d.errorsCount=0;d.Log=d._LogEnabled.bind(d,d.MessageLogLevel);d.Warn=d._LogEnabled.bind(d,d.WarningLogLevel);d.Error=d._LogEnabled.bind(d,d.ErrorLogLevel);class Wt{constructor(){this.shaderLanguage=0}postProcessor(e,t,i,s,r){if(r.drawBuffersExtensionDisabled){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}const Xt=/(flat\s)?\s*varying\s*.*/;class zt{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return Xt.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,r=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(r,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const n=e.search(/layout *\(location *= *0\) *out/g)!==-1,h=t.indexOf("#define DUAL_SOURCE_BLENDING")!==-1,l=h?`layout(location = 0, index = 0) out vec4 glFragColor;
layout(location = 0, index = 1) out vec4 glFragColor2;
`:`layout(location = 0) out vec4 glFragColor;
`;h&&(e=`#extension GL_EXT_blend_func_extended : require
`+e),e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(s||n?"":l)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class ue{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=ue._Counter++}}ue._Counter=0;class Xe extends ue{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}function cs(a){let e=1;do e*=2;while(e<a);return e===a}function _s(a,e,t){return a*(1-t)+e*t}function Yt(a){const e=bt(a),t=xt(a);return e-a>a-t?t:e}function bt(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}function xt(a){return a=a|a>>1,a=a|a>>2,a=a|a>>4,a=a|a>>8,a=a|a>>16,a-(a>>1)}function ge(a,e,t=2){let i;switch(t){case 1:i=xt(a);break;case 2:i=Yt(a);break;case 3:default:i=bt(a);break}return Math.min(i,e)}const Kt=typeof WeakRef<"u";class $t{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class jt{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(e=!1){this._remove&&this._remove(e)}}class v{static FromPromise(e,t){const i=new v;return e.then(s=>{i.notifyObservers(s)}).catch(s=>{if(t)t.notifyObservers(s);else throw s}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new $t(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,s=null,r=!1){if(!e)return null;const n=new jt(e,t,s);n.unregisterOnNextCall=r,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(n,this._lastNotifiedValue);const h=Kt?new WeakRef(this):{deref:()=>this};return n._remove=(l=!1)=>{const o=h.deref();o&&(l?o.remove(n):o._remove(n))},n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!s._willBeUnregistered&&s.callback===e&&(!t||t===s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,s,r){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=s,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=r;for(const h of this._observers)if(!h._willBeUnregistered&&(h.mask&t&&(h.unregisterOnNextCall&&this._deferUnregister(h),h.scope?n.lastReturnValue=h.callback.apply(h.scope,[e,n]):n.lastReturnValue=h.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new v;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class P{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}P.Instances=[];P.OnEnginesDisposedObservable=new v;P._LastCreatedScene=null;P.UseFallbackTexture=!0;P.FallbackTexture="";class R{static GetShadersRepository(e=0){return e===0?R.ShadersRepository:R.ShadersRepositoryWGSL}static GetShadersStore(e=0){return e===0?R.ShadersStore:R.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return e===0?R.IncludesShadersStore:R.IncludesShadersStoreWGSL}}R.ShadersRepository="src/Shaders/";R.ShadersStore={};R.IncludesShadersStore={};R.ShadersRepositoryWGSL="src/ShadersWGSL/";R.ShadersStoreWGSL={};R.IncludesShadersStoreWGSL={};const qt="attribute",Zt="varying";class ce{constructor(){this.children=[]}isValid(e){return!0}process(e,t,i){let s="";if(this.line){let r=this.line;const n=t.processor;if(n){n.lineProcessor&&(r=n.lineProcessor(r,t.isFragment,t.processingContext));const h=t.processor?.attributeKeywordName??qt,l=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:Zt;!t.isFragment&&n.attributeProcessor&&this.line.startsWith(h)?r=n.attributeProcessor(this.line,e,t.processingContext):n.varyingProcessor&&(n.varyingCheck?.(this.line,t.isFragment)||!n.varyingCheck&&this.line.startsWith(l))?r=n.varyingProcessor(this.line,t.isFragment,e,t.processingContext):n.uniformProcessor&&n.uniformRegexp&&n.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(r=n.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):n.uniformBufferProcessor&&n.uniformBufferRegexp&&n.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(r=n.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):n.textureProcessor&&n.textureRegexp&&n.textureRegexp.test(this.line)?r=n.textureProcessor(this.line,t.isFragment,e,t.processingContext):(n.uniformProcessor||n.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?n.uniformProcessor&&(r=n.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):n.uniformBufferProcessor&&(r=n.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,n.endOfUniformBufferProcessor&&(r=n.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}s+=r+`
`}for(const r of this.children)s+=r.process(e,t,i);return this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true",i[this.additionalDefineKey]=e[this.additionalDefineKey]),s}}class Qt{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}const i=t.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(t);continue}const s=i.indexOf(";");if(s===-1)this._lines.push(i);else if(s===i.length-1)i.length>1&&this._lines.push(i);else{const r=t.split(";");for(let n=0;n<r.length;n++){let h=r[n];h&&(h=h.trim(),h&&this._lines.push(h+(n!==r.length-1?";":"")))}}}}}class ye extends ce{process(e,t,i){for(let s=0;s<this.children.length;s++){const r=this.children[s];if(r.isValid(e))return r.process(e,t,i)}return""}}class Jt extends ce{isValid(e){return this.testExpression.isTrue(e)}}class y{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(y._OperatorPriority[i]===void 0)t.push(i);else{const s=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${i}${s})`)}return t[t.length-1]}static infixToPostfix(e){const t=y._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const i=[];let s=-1;const r=()=>{u=u.trim(),u!==""&&(i.push(u),u="")},n=c=>{s<y._Stack.length-1&&(y._Stack[++s]=c)},h=()=>y._Stack[s],l=()=>s===-1?"!!INVALID EXPRESSION!!":y._Stack[s--];let o=0,u="";for(;o<e.length;){const c=e.charAt(o),_=o<e.length-1?e.substring(o,2+o):"";if(c==="(")u="",n(c);else if(c===")"){for(r();s!==-1&&h()!=="(";)i.push(l());l()}else if(y._OperatorPriority[_]>1){for(r();s!==-1&&y._OperatorPriority[h()]>=y._OperatorPriority[_];)i.push(l());n(_),o++}else u+=c;o++}for(r();s!==-1;)h()==="("?l():i.push(l());return y._InfixToPostfixCache.size>=y.InfixToPostfixCacheLimitSize&&y.ClearCache(),y._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(y._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<y.InfixToPostfixCacheCleanupSize;t++)y._InfixToPostfixCache.delete(e[t][0])}}y.InfixToPostfixCacheLimitSize=5e4;y.InfixToPostfixCacheCleanupSize=25e3;y._InfixToPostfixCache=new Map;y._OperatorPriority={")":0,"(":1,"||":2,"&&":3};y._Stack=["","","","","","","","","","","","","","","","","","","",""];class pe extends y{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class ei extends y{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class ti extends y{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class ii extends y{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}toString(){return`${this.define} ${this.operand} ${this.testValue}`}isTrue(e){let t=!1;const i=parseInt(e[this.define]!=null?e[this.define]:this.define),s=parseInt(e[this.testValue]!=null?e[this.testValue]:this.testValue);if(isNaN(i)||isNaN(s))return!1;switch(this.operand){case">":t=i>s;break;case"<":t=i<s;break;case"<=":t=i<=s;break;case">=":t=i>=s;break;case"==":t=i===s;break;case"!=":t=i!==s;break}return t}}const si=/defined\s*?\((.+?)\)/g,Ae=/defined\s*?\[(.+?)\]/g,ri=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,ni=/__decl__/,ze=/light\{X\}.(\w*)/g,Ye=/\{X\}/g,_e=[],ai=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function hi(a){a.processor&&a.processor.initializeShaders&&a.processor.initializeShaders(a.processingContext)}function Ke(a,e,t,i){e.processor?.preProcessShaderCode&&(a=e.processor.preProcessShaderCode(a,e.isFragment)),Be(a,e,s=>{e.processCodeAfterIncludes&&(s=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",s,e.defines));const r=fi(s,e,i);t(r,s)})}function li(a,e,t){return!t.processor||!t.processor.finalizeShaders?{vertexCode:a,fragmentCode:e}:t.processor.finalizeShaders(a,e,t.processingContext)}function oi(a,e){if(e.processor?.noPrecision)return a;const t=e.shouldUseHighPrecisionShader;return a.indexOf("precision highp float")===-1?t?a=`precision highp float;
`+a:a=`precision mediump float;
`+a:t||(a=a.replace("precision highp float","precision mediump float")),a}function Ce(a){const t=/defined\((.+)\)/.exec(a);if(t&&t.length)return new pe(t[1].trim(),a[0]==="!");const i=["==","!=",">=","<=","<",">"];let s="",r=0;for(s of i)if(r=a.indexOf(s),r>-1)break;if(r===-1)return new pe(a);const n=a.substring(0,r).trim(),h=a.substring(r+s.length).trim();return new ii(n,s,h)}function ui(a){a=a.replace(si,"defined[$1]");const e=y.infixToPostfix(a),t=[];for(const s of e)if(s!=="||"&&s!=="&&")t.push(s);else if(t.length>=2){let r=t[t.length-1],n=t[t.length-2];t.length-=2;const h=s=="&&"?new ti:new ei;typeof r=="string"&&(r=r.replace(Ae,"defined($1)")),typeof n=="string"&&(n=n.replace(Ae,"defined($1)")),h.leftOperand=typeof n=="string"?Ce(n):n,h.rightOperand=typeof r=="string"?Ce(r):r,t.push(h)}let i=t[t.length-1];return typeof i=="string"&&(i=i.replace(Ae,"defined($1)")),typeof i=="string"?Ce(i):i}function de(a,e){const t=new Jt,i=a.substring(0,e);let s=a.substring(e);return s=s.substring(0,(s.indexOf("//")+1||s.length+1)-1).trim(),i==="#ifdef"?t.testExpression=new pe(s):i==="#ifndef"?t.testExpression=new pe(s,!0):t.testExpression=ui(s),t}function Fe(a,e,t,i){let s=a.currentLine;for(;Pe(a,t);){s=a.currentLine;const r=s.substring(0,5).toLowerCase();if(r==="#else"){const n=new ce;e.children.push(n),Pe(a,n);return}else if(r==="#elif"){const n=de(s,5);e.children.push(n),t=n}}}function Pe(a,e,t){for(;a.canRead;){a.lineIndex++;const i=a.currentLine;if(i.indexOf("#")>=0){const r=ai.exec(i);if(r&&r.length){switch(r[0]){case"#ifdef":{const h=new ye;e.children.push(h);const l=de(i,6);h.children.push(l),Fe(a,h,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const h=new ye;e.children.push(h);const l=de(i,7);h.children.push(l),Fe(a,h,l);break}case"#if":{const h=new ye,l=de(i,3);e.children.push(h),h.children.push(l),Fe(a,h,l);break}}continue}}const s=new ce;if(s.line=i,e.children.push(s),i[0]==="#"&&i[1]==="d"){const r=i.replace(";","").split(" ");s.additionalDefineKey=r[1],r.length===3&&(s.additionalDefineValue=r[2])}}return!1}function ci(a,e,t,i){const s=new ce,r=new Qt;return r.lineIndex=-1,r.lines=a.split(`
`),Pe(r,s),s.process(e,t,i)}function _i(a,e){const t=a.defines,i={};for(const s of t){const n=s.replace("#define","").replace(";","").trim().split(" ");i[n[0]]=n.length>1?n[1]:""}return a.processor?.shaderLanguage===0&&(i.GL_ES="true"),i.__VERSION__=a.version,i[a.platformName]="true",gt(i,e?.isNDCHalfZRange,e?.useReverseDepthBuffer,e?.useExactSrgbConversions),i}function fi(a,e,t){let i=oi(a,e);if(!e.processor||e.processor.shaderLanguage===0&&i.indexOf("#version 3")!==-1&&(i=i.replace("#version 300 es",""),!e.processor.parseGLES3))return i;const s=e.defines,r=_i(e,t);e.processor.preProcessor&&(i=e.processor.preProcessor(i,s,r,e.isFragment,e.processingContext));const n={};return i=ci(i,r,e,n),e.processor.postProcessor&&(i=e.processor.postProcessor(i,s,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{},r,n)),t?._features.needShaderCodeInlining&&(i=t.inlineShaderCode(i)),i}function Be(a,e,t){_e.length=0;let i;for(;(i=ri.exec(a))!==null;)_e.push(i);let s=String(a),r=[a],n=!1;for(const h of _e){let l=h[1];if(l.indexOf("__decl__")!==-1&&(l=l.replace(ni,""),e.supportsUniformBuffers&&(l=l.replace("Vertex","Ubo").replace("Fragment","Ubo")),l=l+"Declaration"),e.includesShadersStore[l]){let o=e.includesShadersStore[l];if(h[2]){const c=h[3].split(",");for(let _=0;_<c.length;_+=2){const f=new RegExp(c[_],"g"),p=c[_+1];o=o.replace(f,p)}}if(h[4]){const c=h[5];if(c.indexOf("..")!==-1){const _=c.split(".."),f=parseInt(_[0]);let p=parseInt(_[1]),T=o.slice(0);o="",isNaN(p)&&(p=e.indexParameters[_[1]]);for(let b=f;b<p;b++)e.supportsUniformBuffers||(T=T.replace(ze,(g,m)=>m+"{X}")),o+=T.replace(Ye,b.toString())+`
`}else e.supportsUniformBuffers||(o=o.replace(ze,(_,f)=>f+"{X}")),o=o.replace(Ye,c)}const u=[];for(const c of r){const _=c.split(h[0]);for(let f=0;f<_.length-1;f++)u.push(_[f]),u.push(o);u.push(_[_.length-1])}r=u,n=n||o.indexOf("#include<")>=0||o.indexOf("#include <")>=0}else{const o=e.shadersRepository+"ShadersInclude/"+l+".fx";di.loadFile(o,u=>{e.includesShadersStore[l]=u,Be(r.join(""),e,t)});return}}_e.length=0,s=r.join(""),n?Be(s.toString(),e,t):t(s)}const di={loadFile:(a,e,t,i,s,r)=>{throw $("FileTools")}};function gi(a,e){return U(e).cachedPipelines[a]}function Et(a){const e=a._name,t=a.context;if(e&&t){const i=U(t);i.cachedPipelines[e]?.dispose(),delete i.cachedPipelines[e]}}function pi(a,e,t,i,s,r,n){let h,l;const o=H()?r?.getHostDocument():null;typeof e=="string"?h=e:e.vertexSource?h="source:"+e.vertexSource:e.vertexElement?h=o?.getElementById(e.vertexElement)||e.vertexElement:h=e.vertex||e,typeof e=="string"?l=e:e.fragmentSource?l="source:"+e.fragmentSource:e.fragmentElement?l=o?.getElementById(e.fragmentElement)||e.fragmentElement:l=e.fragment||e;const u=[void 0,void 0],c=()=>{if(u[0]&&u[1]){a.isFragment=!0;const[_,f]=u;Ke(f,a,(p,T)=>{n&&(n._fragmentSourceCodeBeforeMigration=T),t&&(p=t("fragment",p));const b=li(_,p,a);a=null;const g=mi(b.vertexCode,b.fragmentCode,e,s);i?.(g.vertexSourceCode,g.fragmentSourceCode)},r)}};$e(h,"Vertex","",_=>{hi(a),Ke(_,a,(f,p)=>{n&&(n._rawVertexSourceCode=_,n._vertexSourceCodeBeforeMigration=p),t&&(f=t("vertex",f)),u[0]=f,c()},r)},s),$e(l,"Fragment","Pixel",_=>{n&&(n._rawFragmentSourceCode=_),u[1]=_,c()},s)}function $e(a,e,t,i,s,r){if(typeof HTMLElement<"u"&&a instanceof HTMLElement){const l=Lt(a);i(l);return}if(a.substring(0,7)==="source:"){i(a.substring(7));return}if(a.substring(0,7)==="base64:"){const l=window.atob(a.substring(7));i(l);return}const n=R.GetShadersStore(s);if(n[a+e+"Shader"]){i(n[a+e+"Shader"]);return}if(t&&n[a+t+"Shader"]){i(n[a+t+"Shader"]);return}let h;if(a[0]==="."||a[0]==="/"||a.indexOf("http")>-1?h=a:h=R.GetShadersRepository(s)+a,r=r||dt,!r)throw new Error("loadFileInjection is not defined");r(h+"."+e.toLowerCase()+".fx",i)}function mi(a,e,t,i){if(t){const s=t.vertexElement||t.vertex||t.spectorName||t,r=t.fragmentElement||t.fragment||t.spectorName||t;return{vertexSourceCode:(i===1?"//":"")+"#define SHADER_NAME vertex:"+s+`
`+a,fragmentSourceCode:(i===1?"//":"")+"#define SHADER_NAME fragment:"+r+`
`+e}}else return{vertexSourceCode:a,fragmentSourceCode:e}}const bi=(a,e,t,i)=>{try{const s=a.context?U(a.context):null;s&&(s.disableParallelShaderCompile=a.disableParallelCompilation);const r=a.existingPipelineContext||e(a.shaderProcessingContext);return r._name=a.name,a.name&&s&&(s.cachedPipelines[a.name]=r),t(r,a.vertex,a.fragment,!!a.createAsRaw,"","",a.rebuildRebind,a.defines,a.transformFeedbackVaryings,"",()=>{i(r,()=>{a.onRenderingStateCompiled?.(r)})}),r}catch(s){throw d.Error("Error compiling effect"),s}};let fe=[];class xi{static SetImmediate(e){fe.length===0&&setTimeout(()=>{const t=fe;fe=[];for(const i of t)i()},1),fe.push(e)}}function je(a,e,t){try{if(a())return e(),!0}catch(i){return t?.(i),!0}return!1}const Ei=(a,e,t,i=16,s=3e4,r=!0,n)=>{if(r&&je(a,e,t))return null;const h=setInterval(()=>{je(a,e,t)?clearInterval(h):(s-=i,s<0&&(clearInterval(h),t?.(new Error("Operation timed out after maximum retries. "+(n||"")),!0)))},i);return()=>clearInterval(h)};class I{static get ShadersRepository(){return R.ShadersRepository}static set ShadersRepository(e){R.ShadersRepository=e}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new v),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,s=null,r,n=null,h=null,l=null,o=null,u,c="",_=0,f){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new v,this.onErrorObservable=new v,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=!1,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=c;const p=this._key.replace(/\r/g,"").replace(/\n/g,"|");let T;if(t.attributes){const b=t;if(this._engine=i,this._attributesNames=b.attributes,this._uniformsNames=b.uniformsNames.concat(b.samplers),this._samplerList=b.samplers.slice(),this.defines=b.defines,this.onError=b.onError,this.onCompiled=b.onCompiled,this._fallbacks=b.fallbacks,this._indexParameters=b.indexParameters,this._transformFeedbackVaryings=b.transformFeedbackVaryings||null,this._multiTarget=!!b.multiTarget,this._shaderLanguage=b.shaderLanguage??0,this._disableParallelShaderCompilation=!!b.disableParallelShaderCompilation,b.uniformBuffersNames){this._uniformBuffersNamesList=b.uniformBuffersNames.slice();for(let g=0;g<b.uniformBuffersNames.length;g++)this._uniformBuffersNames[b.uniformBuffersNames[g]]=g}this._processFinalCode=b.processFinalCode??null,this._processCodeAfterIncludes=b.processCodeAfterIncludes??void 0,f=b.extraInitializationsAsync,T=b.existingPipelineContext}else this._engine=r,this.defines=n??"",this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=_,this.onError=o,this.onCompiled=l,this._indexParameters=u,this._fallbacks=h;this._engine.shaderPlatformName==="WEBGL2"&&(T=gi(p,this._engine._gl)??T),this._attributeLocationByName={},this.uniqueId=I._UniqueIdSeed++,T?(this._pipelineContext=T,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,f),this._engine.onReleaseEffectsObservable.addOnce(()=>{this.isDisposed||this.dispose(!0)})}async _processShaderCodeAsync(e=null,t=!1,i=null,s){s&&await s(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);const r={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:R.GetShadersRepository(this._shaderLanguage),includesShadersStore:R.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};pi(r,this.name,this._processFinalCode,(n,h)=>{this._vertexSourceCode=n,this._fragmentSourceCode=h,this._prepareEffect(t)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._engine.isDisposed||this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}async whenCompiledAsync(){return await new Promise(e=>{this.executeWhenCompiled(e)})}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&this._checkIsReady(null)}_checkIsReady(e){Ei(()=>this._isReadyInternal()||this._isDisposed,()=>{},t=>{this._processCompilationErrors(t,e)},16,12e4,!0,` - Effect: ${typeof this.name=="string"?this.name:this.key}`)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(r,n)=>{s&&s(n)},this.onCompiled=()=>{const r=this.getEngine().scenes;if(r)for(let n=0;n<r.length;n++)r[n].markAllMaterialsAsDirty(127);this._pipelineContext._handlesSpectorRebuildCallback?.(i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let t=0;t<this._attributesNames.length;t++){const i=this._attributesNames[t];this._attributeLocationByName[i]=this._attributes[t]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),I.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(e=!1){const t=this._pipelineContext;this._isReady=!1;try{const i=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),s=i?null:this.defines,r=i?this._vertexSourceCodeOverride:this._vertexSourceCode,n=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,h=this._engine;this._pipelineContext=bi({existingPipelineContext:e?t:null,vertex:r,fragment:n,context:h.shaderPlatformName==="WEBGL2"||h.shaderPlatformName==="WEBGL1"?h._gl:void 0,rebuildRebind:(l,o,u,c)=>this._rebuildProgram(l,o,u,c),defines:s,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:l=>{t&&!e&&this._engine._deletePipelineContext(t),l&&this._onRenderingStateCompiled(l)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContextAsync.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(s);if(n&&n.length===2){const h=parseInt(n[1]),l=e.split(`
`,-1);l.length>=h&&(r=`Offending line [${h}] in ${i?"fragment":"vertex"} code: ${l[h-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){this._compilationError=e.message;const i=this._attributesNames,s=this._fallbacks;if(d.Error("Unable to compile effect:"),d.Error(`Uniforms: ${this._uniformsNames.join(" ")}`),d.Error(`Attributes: ${i.join(" ")}`),d.Error(`Defines:
`+this.defines),I.LogShaderCodeOnCompilationError){let n=null,h=null,l=null;this._pipelineContext?._getVertexShaderCode()&&([l,n]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),l&&(d.Error("Vertex code:"),d.Error(l))),this._pipelineContext?._getFragmentShaderCode()&&([l,h]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),l&&(d.Error("Fragment code:"),d.Error(l))),n&&d.Error(n),h&&d.Error(h)}d.Error("Error: "+this._compilationError);const r=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError})};t&&(this._pipelineContext=t,this._isReady=!0,r()),s?(this._pipelineContext=null,s.hasMoreFallbacks?(this._allFallbacksProcessed=!1,d.Error("Trying next fallback."),this.defines=s.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,r(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||r())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const s=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const h=i+(n-1).toString();this._samplerList.splice(s+n,0,h)}let r=0;for(const n of this._samplerList)this._samplers[n]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||I._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(I._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,s){return this._pipelineContext.setInt3(e,t,i,s),this}setInt4(e,t,i,s,r){return this._pipelineContext.setInt4(e,t,i,s,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,s){return this._pipelineContext.setUInt3(e,t,i,s),this}setUInt4(e,t,i,s,r){return this._pipelineContext.setUInt4(e,t,i,s,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,s){return this._pipelineContext.setFloat3(e,t,i,s),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,s,r){return this._pipelineContext.setFloat4(e,t,i,s,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(e=!1){if(e)this._refCount=0;else{if(I.PersistentMode)return;this._refCount--}this._refCount>0||this._isDisposed||(this._pipelineContext&&Et(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(e,t,i,s=0){t&&(R.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(R.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){I._BaseCache={}}}I.LogShaderCodeOnCompilationError=!0;I.PersistentMode=!1;I.AutomaticallyClearCodeCache=!1;I._UniqueIdSeed=0;I._BaseCache={};I.ShadersStore=R.ShadersStore;I.IncludesShadersStore=R.IncludesShadersStore;class O{static SetMatrixPrecision(e){if(O.MatrixTrackPrecisionChange=!1,e&&!O.MatrixUse64Bits&&O.MatrixTrackedMatrices)for(let t=0;t<O.MatrixTrackedMatrices.length;++t){const i=O.MatrixTrackedMatrices[t],s=i._m;i._m=new Array(16);for(let r=0;r<16;++r)i._m[r]=s[r]}O.MatrixUse64Bits=e,O.MatrixCurrentType=O.MatrixUse64Bits?Array:Float32Array,O.MatrixTrackedMatrices=null}}O.MatrixUse64Bits=!1;O.MatrixTrackPrecisionChange=!0;O.MatrixCurrentType=Float32Array;O.MatrixTrackedMatrices=[];class Ti{static get Now(){return H()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class Si{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class Ri{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get backFunc(){return this._func}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._isStencilOpDirty=!0)}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._isStencilOpDirty=!0)}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){if(!e)return;const t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.backFunc=t?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backOpStencilFail=t?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=t?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=t?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFuncSeparate(e.FRONT,this.func,this.funcRef,this.funcMask),e.stencilFuncSeparate(e.BACK,this.backFunc,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOpSeparate(e.FRONT,this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),e.stencilOpSeparate(e.BACK,this.backOpStencilFail,this.backOpDepthFail,this.backOpStencilDepthPass),this._isStencilOpDirty=!1))}}class G{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.funcRef=1,this.funcMask=255,this.func=G.ALWAYS,this.opStencilFail=G.KEEP,this.opDepthFail=G.KEEP,this.opStencilDepthPass=G.REPLACE,this.backFunc=G.ALWAYS,this.backOpStencilFail=G.KEEP,this.backOpDepthFail=G.KEEP,this.backOpStencilDepthPass=G.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilBackFunc(){return this.backFunc}set stencilBackFunc(e){this.backFunc=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilBackOpStencilFail(){return this.backOpStencilFail}set stencilBackOpStencilFail(e){this.backOpStencilFail=e}get stencilBackOpDepthFail(){return this.backOpDepthFail}set stencilBackOpDepthFail(e){this.backOpDepthFail=e}get stencilBackOpStencilDepthPass(){return this.backOpStencilDepthPass}set stencilBackOpStencilDepthPass(e){this.backOpStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}G.ALWAYS=519;G.KEEP=7680;G.REPLACE=7681;class yi{constructor(){this._blendFunctionParameters=new Array(4*8),this._blendEquationParameters=new Array(2*8),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=Array(8).fill(!1),this._numTargetEnabled=0,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._numTargetEnabled>0}setAlphaBlend(e,t=0){this._alphaBlend[t]!==e&&(e?this._numTargetEnabled++:this._numTargetEnabled--,this._alphaBlend[t]=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s,r=0){const n=r*4;this._blendFunctionParameters[n+0]===e&&this._blendFunctionParameters[n+1]===t&&this._blendFunctionParameters[n+2]===i&&this._blendFunctionParameters[n+3]===s||(this._blendFunctionParameters[n+0]=e,this._blendFunctionParameters[n+1]=t,this._blendFunctionParameters[n+2]=i,this._blendFunctionParameters[n+3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t,i=0){const s=i*2;this._blendEquationParameters[s+0]===e&&this._blendEquationParameters[s+1]===t||(this._blendEquationParameters[s+0]=e,this._blendEquationParameters[s+1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend.fill(!1),this._numTargetEnabled=0,this._blendFunctionParameters.fill(null),this._blendEquationParameters.fill(null),this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e,t=1){if(this.isDirty){if(this._isAlphaBlendDirty){if(t===1)this._alphaBlend[0]?e.enable(e.BLEND):e.disable(e.BLEND);else{const i=e;for(let s=0;s<t;s++){const r=s<this._numTargetEnabled?s:0;this._alphaBlend[r]?i.enableIndexed(e.BLEND,s):i.disableIndexed(e.BLEND,s)}}this._isAlphaBlendDirty=!1}if(this._isBlendFunctionParametersDirty){if(t===1)e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]);else{const i=e;for(let s=0;s<t;s++){const r=s<this._numTargetEnabled?s*4:0;i.blendFuncSeparateIndexed(s,this._blendFunctionParameters[r+0],this._blendFunctionParameters[r+1],this._blendFunctionParameters[r+2],this._blendFunctionParameters[r+3])}}this._isBlendFunctionParametersDirty=!1}if(this._isBlendEquationParametersDirty){if(t===1)e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]);else{const i=e;for(let s=0;s<t;s++){const r=s<this._numTargetEnabled?s*2:0;i.blendEquationSeparateIndexed(s,this._blendEquationParameters[r+0],this._blendEquationParameters[r+1])}}this._isBlendEquationParametersDirty=!1}this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1)}}setAlphaMode(e,t){let i=32774;switch(e){case 0:break;case 7:this.setAlphaBlendFunctionParameters(1,771,1,1,t);break;case 8:this.setAlphaBlendFunctionParameters(1,771,1,771,t);break;case 2:this.setAlphaBlendFunctionParameters(770,771,1,1,t);break;case 6:this.setAlphaBlendFunctionParameters(1,1,0,1,t);break;case 1:this.setAlphaBlendFunctionParameters(770,1,0,1,t);break;case 3:this.setAlphaBlendFunctionParameters(0,769,1,1,t),i=32778;break;case 4:this.setAlphaBlendFunctionParameters(774,0,1,1,t);break;case 5:this.setAlphaBlendFunctionParameters(770,769,1,1,t);break;case 9:this.setAlphaBlendFunctionParameters(32769,32770,32771,32772,t);break;case 10:this.setAlphaBlendFunctionParameters(1,769,1,771,t);break;case 11:this.setAlphaBlendFunctionParameters(1,1,1,1,t);break;case 12:this.setAlphaBlendFunctionParameters(772,1,0,0,t);break;case 13:this.setAlphaBlendFunctionParameters(775,769,773,771,t);break;case 14:this.setAlphaBlendFunctionParameters(1,771,1,771,t);break;case 15:this.setAlphaBlendFunctionParameters(1,1,1,0,t);break;case 16:this.setAlphaBlendFunctionParameters(775,769,0,1,t);break;case 17:this.setAlphaBlendFunctionParameters(770,771,1,771,t);break;case 18:this.setAlphaBlendFunctionParameters(1,1,1,1,t),i=32775;break;case 19:this.setAlphaBlendFunctionParameters(1,1,1,1,t),i=32776;break;case 20:this.setAlphaBlendFunctionParameters(1,35065,0,1,t);break}this.setAlphaEquationParameters(i,i,t)}}class Ai{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,s=1,r=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var qe;(function(a){a[a.Unknown=0]="Unknown",a[a.Url=1]="Url",a[a.Temp=2]="Temp",a[a.Raw=3]="Raw",a[a.Dynamic=4]="Dynamic",a[a.RenderTarget=5]="RenderTarget",a[a.MultiRenderTarget=6]="MultiRenderTarget",a[a.Cube=7]="Cube",a[a.CubeRaw=8]="CubeRaw",a[a.CubePrefiltered=9]="CubePrefiltered",a[a.Raw3D=10]="Raw3D",a[a.Raw2DArray=11]="Raw2DArray",a[a.DepthStencil=12]="DepthStencil",a[a.CubeRawRGBD=13]="CubeRawRGBD",a[a.Depth=14]="Depth"})(qe||(qe={}));class te extends Ai{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new v,this.onErrorObservable=new v,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._autoMSAAManagement=!1,this._engine=e,this._source=t,this._uniqueId=te._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const t=this.onRebuildCallback(this),i=s=>{s._swapAndDie(this,!1),this.isReady=t.isReady};t.isAsync?t.proxy.then(i):i(t.proxy);return}let e;switch(this.source){case 2:break;case 1:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,t=>{t._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,t=>{t&&t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const i=this._engine.getLoadedTexturesCache();let s=i.indexOf(this);s!==-1&&i.splice(s,1),s=i.indexOf(e),s===-1&&i.push(e)}dispose(){this._references--,this._references===0&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}te._Counter=0;const me=new Map;function K(a,e){Ci(a)&&d.Warn(`Extension with the name '${a}' already exists`),me.set(a,e)}function Ci(a){return me.delete(a)}function Fi(a,e){(e==="image/ktx"||e==="image/ktx2")&&(a=".ktx"),me.has(a)||(a.endsWith(".ies")&&K(".ies",async()=>await import("./iesTextureLoader-_PMypseB.js").then(i=>new i._IESTextureLoader)),a.endsWith(".dds")&&K(".dds",async()=>await import("./ddsTextureLoader-CgDZ1wcr.js").then(i=>new i._DDSTextureLoader)),a.endsWith(".basis")&&K(".basis",async()=>await import("./basisTextureLoader-DuzMUfzE.js").then(i=>new i._BasisTextureLoader)),a.endsWith(".env")&&K(".env",async()=>await import("./envTextureLoader-CcAOwxji.js").then(i=>new i._ENVTextureLoader)),a.endsWith(".hdr")&&K(".hdr",async()=>await import("./hdrTextureLoader-D-VkY7vA.js").then(i=>new i._HDRTextureLoader)),(a.endsWith(".ktx")||a.endsWith(".ktx2"))&&(K(".ktx",async()=>await import("./ktxTextureLoader-DVZMISvV.js").then(i=>new i._KTXTextureLoader)),K(".ktx2",async()=>await import("./ktxTextureLoader-DVZMISvV.js").then(i=>new i._KTXTextureLoader))),a.endsWith(".tga")&&K(".tga",async()=>await import("./tgaTextureLoader-4bQawr3u.js").then(i=>new i._TGATextureLoader)),a.endsWith(".exr")&&K(".exr",async()=>await import("./exrTextureLoader-CZedxCrR.js").then(i=>new i._ExrTextureLoader)));const t=me.get(a);return t?Promise.resolve(t(e)):null}function Tt(a,e){if(H()){const{requestAnimationFrame:t}=e||window;if(typeof t=="function")return t(a)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(a);return setTimeout(a,16)}class W{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}_resetAlphaMode(){this._alphaMode.fill(-1),this._alphaEquation.fill(-1)}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}I.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){d.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout(()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,s=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=s,this._stencilState.stencilTest=r,this._flagContextRestored()},0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){const e=this._frameHandler;if(this._frameHandler=0,H()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if(typeof t=="function")return t(e)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}get maxFPS(){return this._maxFPS}set maxFPS(e){if(this._maxFPS=e,e!==void 0){if(e<=0){this._minFrameTime=Number.MAX_VALUE;return}this._minFrameTime=1e3/e}}_isOverFrameTime(e){if(!e||this._maxFPS===void 0)return!1;const t=e-this._lastFrameTime;return this._lastFrameTime=e,this._renderAccumulator+=t,this._renderAccumulator<this._minFrameTime?!0:(this._renderAccumulator-=this._minFrameTime,this._renderAccumulator>this._minFrameTime&&(this._renderAccumulator=this._minFrameTime),!1)}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),!this.skipFrameRender&&!this._renderViews()&&this._renderFrame(),this.endFrame())}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderViews(){return!1}_queueNewFrame(e,t){return Tt(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return H()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){const s=t||this.getRenderWidth(),r=i||this.getRenderHeight(),n=e.x||0,h=e.y||0;this._cachedViewport=e,this._viewport(n*s,h*r,s*e.width,r*e.height)}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,s,r=3,n=null,h=null,l,o,u=null,c=null,_=null,f=null,p,T,b){e=e||"";const g=e.substring(0,5)==="data:",m=e.substring(0,5)==="blob:",w=g&&e.indexOf(";base64,")!==-1,E=c||new te(this,1);E!==c&&(E.label=e.substring(0,60));const k=e;this._transformTextureUrl&&!w&&!c&&!u&&(e=this._transformTextureUrl(e)),k!==e&&(E._originalUrl=k);const M=e.lastIndexOf(".");let N=f||(M>-1?e.substring(M).toLowerCase():"");N.indexOf("?")>-1&&(N=N.split("?")[0]);const Y=Fi(N,p);s&&s.addPendingData(E),E.url=e,E.generateMipMaps=!t,E.samplingMode=r,E.invertY=i,E._useSRGBBuffer=this._getUseSRGBBuffer(!!b,t),this._doNotHandleContextLost||(E._buffer=u);let V=null;n&&!c&&(V=E.onLoadedObservable.add(n)),c||this._internalTexturesCache.push(E);const j=(D,L)=>{s&&s.removePendingData(E),e===k?(V&&E.onLoadedObservable.remove(V),P.UseFallbackTexture&&e!==P.FallbackTexture&&this._createTextureBase(P.FallbackTexture,t,E.invertY,s,r,null,h,l,o,u,E),D=(D||"Unknown error")+(P.UseFallbackTexture?" - Fallback texture was used":""),E.onErrorObservable.notifyObservers({message:D,exception:L}),h&&h(D,L)):(d.Warn(`Failed to load ${e}, falling back to ${k}`),this._createTextureBase(k,t,E.invertY,s,r,n,h,l,o,u,E,_,f,p,T,b))};if(Y){const D=async L=>{(await Y).loadData(L,E,(Ft,wt,vt,It,Dt,Pt)=>{Pt?j("TextureLoader failed to load data"):l(E,N,s,{width:Ft,height:wt},E.invertY,!vt,It,()=>(Dt(),!1),r)},T)};u?u instanceof ArrayBuffer?D(new Uint8Array(u)):ArrayBuffer.isView(u)?D(u):h&&h("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,L=>{D(new Uint8Array(L))},void 0,s?s.offlineProvider:void 0,!0,(L,Ve)=>{j("Unable to load "+(L&&L.responseURL,Ve))})}else{const D=L=>{m&&!this._doNotHandleContextLost&&(E._buffer=L),l(E,N,s,L,E.invertY,t,!1,o,r)};!g||w?u&&(typeof u.decoding=="string"||u.close)?D(u):W._FileToolsLoadImage(e||"",D,j,s?s.offlineProvider:null,p,E.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):typeof u=="string"||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?W._FileToolsLoadImage(u,D,j,s?s.offlineProvider:null,p,E.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):u&&D(u)}return E}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:Se()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@8.16.0"}static get Version(){return"8.16.0"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Si,this._stencilStateComposer=new Ri,this._stencilState=new G,this._alphaState=new yi,this._alphaMode=Array(8).fill(-1),this._alphaEquation=Array(8).fill(-1),this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new v,this.onCanvasFocusObservable=new v,this.onNewSceneAddedObservable=new v,this.onResizeObservable=new v,this.onCanvasPointerOutObservable=new v,this.onEffectErrorObservable=new v,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new v,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=n=>this._renderLoop(n),this._lastFrameTime=0,this._renderAccumulator=0,this.skipFrameRender=!1,this.onBeforeShaderCompilationObservable=new v,this.onAfterShaderCompilationObservable=new v,this.onBeginFrameObservable=new v,this.onEndFrameObservable=new v,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new v,this.onContextRestoredObservable=new v,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new v,this.onReleaseEffectsObservable=new v,P.Instances.push(this),this.startTime=Ti.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,O.SetMatrixPrecision(!!t.useHighPrecisionMatrix),Mt()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.stencil=t.stencil??!0,this._audioContext=t.audioEngineOptions?.audioContext??null,this._audioDestination=t.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;const s=H()&&window.devicePixelRatio||1,r=t.limitDeviceRatio||s;i=i||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(r,s):1,this._lastDevicePixelRatio=s,this._creationOptions=t}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const s=H()&&window.devicePixelRatio||1,r=this._lastDevicePixelRatio/s;this._lastDevicePixelRatio=s,this._hardwareScalingLevel*=r}if(H()&&Se())if(this._renderingCanvas){const s=this._renderingCanvas.getBoundingClientRect?.();t=this._renderingCanvas.clientWidth||s?.width||this._renderingCanvas.width*this._hardwareScalingLevel||100,i=this._renderingCanvas.clientHeight||s?.height||this._renderingCanvas.height*this._hardwareScalingLevel||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){if(!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t))return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let s=0;s<this.scenes.length;s++){const r=this.scenes[s];for(let n=0;n<r.cameras.length;n++){const h=r.cameras[n];h._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,i,s,r,n,h,l,o,u,c){throw $("engine.rawTexture")}createRawCubeTexture(e,t,i,s,r,n,h,l){throw $("engine.rawTexture")}createRawTexture3D(e,t,i,s,r,n,h,l,o,u,c){throw $("engine.rawTexture")}createRawTexture2DArray(e,t,i,s,r,n,h,l,o,u,c){throw $("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&Se()&&"ontouchend"in document},this._checkForMobile(),H()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return W._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,s,r,n,h){throw $("FileTools")}_loadFile(e,t,i,s,r,n){const h=dt(e,t,i,s,r,n);return this._activeRequests.push(h),h.onCompleteObservable.add(()=>{const l=this._activeRequests.indexOf(h);l!==-1&&this._activeRequests.splice(l,1)}),h}static _FileToolsLoadFile(e,t,i,s,r,n){if(ve.loadFile)return ve.loadFile(e,t,i,s,r,n);throw $("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),I.ResetCache();for(const t of this._activeRequests)t.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),H()&&window.removeEventListener("resize",this._checkForMobile);const e=P.Instances.indexOf(this);e>=0&&P.Instances.splice(e,1),P.Instances.length||(P.OnEnginesDisposedObservable.notifyObservers(this),P.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw $("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<P.Instances.length;i++){const s=P.Instances[i];for(let r=0;r<s.scenes.length;r++)s.scenes[r].markAllMaterialsAsDirty(e,t)}}}W._RenderPassIdCounter=0;W._RescalePostProcessFactory=null;W.CollisionsEpsilon=.001;W.QueueNewFrame=Tt;class wi{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}function Ze(a){return a===13||a===14||a===15||a===16||a===17||a===18||a===19}function Qe(a){return a===13||a===17||a===18||a===19}class vi{}class C extends W{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return I.ShadersRepository}static set ShadersRepository(e){I.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,i,s){if(i=i||{},super(t??i.antialias,i,s),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let r=null;if(e.getContext){if(r=e,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const l=navigator.userAgent;for(const o of C.ExceptionList){const u=o.key,c=o.targets;if(new RegExp(u).test(l)){if(o.capture&&o.captureConstraint){const f=o.capture,p=o.captureConstraint,b=new RegExp(f).exec(l);if(b&&b.length>0&&parseInt(b[b.length-1])>=p)continue}for(const f of c)switch(f){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{Re(this._gl)}:(this._onContextLost=l=>{l.preventDefault(),this._contextWasLost=!0,Re(this._gl),d.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},r.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),r.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=r.getContext("webgl2",i)||r.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!r)throw new Error("The provided canvas is null or undefined.");try{this._gl=r.getContext("webgl",i)||r.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,r=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const l=this._gl.getContextAttributes();l&&(i.stencil=l.stencil)}this._sharedInit(r),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let l=0;l<this._caps.maxVertexAttribs;l++)this._currentBufferPointers[l]=new vi;this._shaderProcessor=this.webGLVersion>1?new zt:new Wt;const n=`Babylon.js v${C.Version}`;d.Log(n+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",n);const h=U(this._gl);h.validateShaderPrograms=this.validateShaderPrograms,h.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16"),blendParametersPerTarget:!1,dualSourceBlending:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763);const t=this._gl.getExtension("OES_draw_buffers_indexed");if(this._caps.blendParametersPerTarget=!!t,t&&(this._gl.blendEquationSeparateIndexed=t.blendEquationSeparateiOES.bind(t),this._gl.blendEquationIndexed=t.blendEquationiOES.bind(t),this._gl.blendFuncSeparateIndexed=t.blendFuncSeparateiOES.bind(t),this._gl.blendFuncIndexed=t.blendFunciOES.bind(t),this._gl.colorMaskIndexed=t.colorMaskiOES.bind(t),this._gl.disableIndexed=t.disableiOES.bind(t),this._gl.enableIndexed=t.enableiOES.bind(t)),this._caps.dualSourceBlending=!!this._gl.getExtension("WEBGL_blend_func_extended"),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._caps.maxDrawBuffers=this._gl.getParameter(i.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let s=0;s<16;s++)this._gl["COLOR_ATTACHMENT"+s+"_WEBGL"]=i["COLOR_ATTACHMENT"+s+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),s=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);i&&s&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&s.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:i.SRGB_EXT,SRGB8:i.SRGB_ALPHA_EXT,SRGB8_ALPHA8:i.SRGB_ALPHA_EXT})}if(this._creationOptions){const i=this._creationOptions.forceSRGBBufferSupportState;i!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&i)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,s=!1){const r=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=r;let n=0;if(t&&e){let h=!0;if(this._currentRenderTarget){const l=this._currentRenderTarget.texture?.format;if(l===8||l===9||l===10||l===11){const o=this._currentRenderTarget.texture?.type;o===7||o===5?(C._TempClearColorUint32[0]=e.r*255,C._TempClearColorUint32[1]=e.g*255,C._TempClearColorUint32[2]=e.b*255,C._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,C._TempClearColorUint32),h=!1):(C._TempClearColorInt32[0]=e.r*255,C._TempClearColorInt32[1]=e.g*255,C._TempClearColorInt32[2]=e.b*255,C._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,C._TempClearColorInt32),h=!1)}}h&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),n|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,s){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||s!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,s,r,n=0,h=0){const l=e;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);const o=this._gl;e.isMulti||(e.is2DArray||e.is3D?(o.framebufferTextureLayer(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,n,h),l._currentLOD=n):e.isCube?o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,n):l._currentLOD!==n&&(o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,n),l._currentLOD=n));const u=e._depthStencilTexture;if(u){e.is3D&&(e.texture.width!==u.width||e.texture.height!==u.height||e.texture.depth!==u.depth)&&d.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");const c=e._depthStencilTextureWithStencil?o.DEPTH_STENCIL_ATTACHMENT:o.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?o.framebufferTextureLayer(o.FRAMEBUFFER,c,u._hardwareTexture?.underlyingResource,n,h):e.isCube?o.framebufferTexture2D(o.FRAMEBUFFER,c,o.TEXTURE_CUBE_MAP_POSITIVE_X+t,u._hardwareTexture?.underlyingResource,n):o.framebufferTexture2D(o.FRAMEBUFFER,c,o.TEXTURE_2D,u._hardwareTexture?.underlyingResource,n)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),s||(s=e.height,n&&(s=s/Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches()}setStateCullFaceType(e,t){const i=this.cullBackFaces??e??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,s=!1,r,n,h=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(r,i),this.setZOffset(t),this.setZOffsetUnits(h);const l=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=n}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){e.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t,i){const s=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),i&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),i()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this.generateMipmaps(e.texture)}resolveFramebuffer(e){const t=e,i=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let s=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;s|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,s|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0,i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s,i.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new Xe(i);return this.bindArrayBuffer(s),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),s.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),s.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),s.capacity=e),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const s=this._gl.createBuffer(),r=new Xe(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=n.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,r,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,s,r,n,h){const l=this._currentBufferPointers[t];if(!l)return;let o=!1;l.active?(l.buffer!==e&&(l.buffer=e,o=!0),l.size!==i&&(l.size=i,o=!0),l.type!==s&&(l.type=s,o=!0),l.normalized!==r&&(l.normalized=r,o=!0),l.stride!==n&&(l.stride=n,o=!0),l.offset!==h&&(l.offset=h,o=!0)):(o=!0,l.active=!0,l.index=t,l.size=i,l.type=s,l.normalized=r,l.stride=n,l.offset=h,l.buffer=e),(o||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,n,h):this._gl.vertexAttribPointer(t,i,s,r,n,h))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<s.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const h=s[r];let l=null;if(i&&(l=i[h]),l||(l=e[h]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const o=l.getBuffer();o&&(this._vertexAttribPointer(o,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))))}}}recordVertexArrayObject(e,t,i,s){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,s,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const n=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let h=0;for(let l=0;l<n;l++)if(l<i.length){const o=r.getAttributeLocation(l);o>=0&&(this._gl.enableVertexAttribArray(o),this._vertexAttribArraysEnabled[o]=!0,this._vertexAttribPointer(e,o,i[l],this._gl.FLOAT,!1,s,h)),h+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,s){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const s=this._currentInstanceBuffers[t];e!=s&&s.references&&(e=s,this.bindArrayBuffer(s));const r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let s=0;s<4;s++){const r=i[s];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,s*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let s=0;if(i)for(let r=0;r<t.length;r++){const n=t[r];s+=n.attributeSize*4}for(let r=0;r<t.length;r++){const n=t[r];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,s,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,s){this.drawElementsType(e?0:1,t,i,s)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,s){this.drawArraysType(e?0:1,t,i,s)}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,h=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(r,i,n,t*h,s):this._gl.drawElements(r,i,n,t*h)}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);s?this._gl.drawArraysInstanced(r,t,i,s):this._gl.drawArrays(r,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,Et(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)))}_getGlobalDefines(e){return gt(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,s,r,n,h,l,o,u=0,c){const _=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,f=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines(),T=t.attributes!==void 0;let b=r??t.defines??"";p&&(b+=p);const g=_+"+"+f+"@"+b;if(this._compiledEffects[g]){const w=this._compiledEffects[g];return h&&w.isReady()&&h(w),w._refCount++,w}this._gl&&U(this._gl);const m=new I(e,t,T?this:i,s,this,r,n,h,l,o,g,t.shaderLanguage??u,t.extraInitializationsAsync??c);return this._compiledEffects[g]=m,m}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,r=null){const n=U(this._gl);return n._contextWasLost=this._contextWasLost,n.validateShaderPrograms=this.validateShaderPrograms,pt(e,t,i,s||this._gl,r)}createShaderProgram(e,t,i,s,r,n=null){const h=U(this._gl);return h._contextWasLost=this._contextWasLost,h.validateShaderPrograms=this.validateShaderPrograms,mt(e,t,i,s,r||this._gl,n)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){const i=U(this._gl);i.parallelShaderCompile=this._caps.parallelShaderCompile}const t=Ut(this._gl);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return Ge(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,i,s,r,n,h,l,o,u,c){const _=U(this._gl);return _._contextWasLost=this._contextWasLost,_.validateShaderPrograms=this.validateShaderPrograms,_._createShaderProgramInjection=this._createShaderProgram.bind(this),_.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),_.createShaderProgramInjection=this.createShaderProgram.bind(this),_.loadFileInjection=this._loadFile.bind(this),kt(e,t,i,s,r,n,h,l,o,u,c)}_createShaderProgram(e,t,i,s,r=null){return Ue(e,t,i,s,r)}_isRenderingStateCompiled(e){return this._isDisposed?!1:Gt(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){Vt(e,t)}getUniforms(e,t){const i=new Array,s=e;for(let r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(s.program,t[r]));return i}getAttributes(e,t){const i=[],s=e;for(let r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(s.program,t[r]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&Ht(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,s){return e?(this._gl.uniform3i(e,t,i,s),!0):!1}setInt4(e,t,i,s,r){return e?(this._gl.uniform4i(e,t,i,s,r),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,s){return e?(this._gl.uniform3ui(e,t,i,s),!0):!1}setUInt4(e,t,i,s,r){return e?(this._gl.uniform4ui(e,t,i,s,r),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,s){return e?(this._gl.uniform3f(e,t,i,s),!0):!1}setFloat4(e,t,i,s,r){return e?(this._gl.uniform4f(e,t,i,s,r),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl,this._currentRenderTarget&&this._currentRenderTarget.textures?this._currentRenderTarget.textures.length:1),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,r=i.NEAREST,n=!1;switch(e){case 11:s=i.LINEAR,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 3:s=i.LINEAR,n=!0,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 8:n=!0,s=i.NEAREST,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 4:s=i.NEAREST,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 5:s=i.NEAREST,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 6:n=!0,s=i.NEAREST,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 7:s=i.NEAREST,r=i.LINEAR;break;case 1:s=i.NEAREST,r=i.NEAREST;break;case 9:s=i.LINEAR,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 10:n=!0,s=i.LINEAR,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 2:s=i.LINEAR,r=i.LINEAR;break;case 12:s=i.LINEAR,r=i.NEAREST;break}return{min:r,mag:s,hasMipMaps:n}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new wi(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,s=0){let r=!1,n=!1,h=0,l=3,o=5,u=!1,c=1,_,f=!1,p=0;t!==void 0&&typeof t=="object"?(r=!!t.generateMipMaps,n=!!t.createMipMaps,h=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,o=t.format===void 0?5:t.format,u=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,c=t.samples??1,_=t.label,f=!!t.createMSAATexture,p=t.comparisonFunction||0):r=!!t,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(h===1&&!this._caps.textureFloatLinearFiltering||h===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),h===1&&!this._caps.textureFloat&&(h=0,d.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const T=Ze(o),b=Qe(o),g=this._gl,m=new te(this,s),w=e.width||e,E=e.height||e,k=e.depth||0,M=e.layers||0,N=this._getSamplingParameters(l,(r||n)&&!T),A=M!==0?g.TEXTURE_2D_ARRAY:k!==0?g.TEXTURE_3D:g.TEXTURE_2D,Y=T?this._getInternalFormatFromDepthTextureFormat(o,!0,b):this._getRGBABufferInternalSizedFormat(h,o,u),V=T?b?g.DEPTH_STENCIL:g.DEPTH_COMPONENT:this._getInternalFormat(o),j=T?this._getWebGLTextureTypeFromDepthTextureFormat(o):this._getWebGLTextureType(h);if(this._bindTextureDirectly(A,m),M!==0?(m.is2DArray=!0,g.texImage3D(A,0,Y,w,E,M,0,V,j,null)):k!==0?(m.is3D=!0,g.texImage3D(A,0,Y,w,E,k,0,V,j,null)):g.texImage2D(A,0,Y,w,E,0,V,j,null),g.texParameteri(A,g.TEXTURE_MAG_FILTER,N.mag),g.texParameteri(A,g.TEXTURE_MIN_FILTER,N.min),g.texParameteri(A,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(A,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),T&&this.webGLVersion>1&&(p===0?(g.texParameteri(A,g.TEXTURE_COMPARE_FUNC,515),g.texParameteri(A,g.TEXTURE_COMPARE_MODE,g.NONE)):(g.texParameteri(A,g.TEXTURE_COMPARE_FUNC,p),g.texParameteri(A,g.TEXTURE_COMPARE_MODE,g.COMPARE_REF_TO_TEXTURE))),(r||n)&&this._gl.generateMipmap(A),this._bindTextureDirectly(A,null),m._useSRGBBuffer=u,m.baseWidth=w,m.baseHeight=E,m.width=w,m.height=E,m.depth=M||k,m.isReady=!0,m.samples=c,m.generateMipMaps=r,m.samplingMode=l,m.type=h,m.format=o,m.label=_,m.comparisonFunction=p,this._internalTexturesCache.push(m),f){let D=null;if(Ze(m.format)?D=this._setupFramebufferDepthAttachments(Qe(m.format),m.format!==19,m.width,m.height,c,m.format,!0):D=this._createRenderBuffer(m.width,m.height,c,-1,this._getRGBABufferInternalSizedFormat(m.type,m.format,m._useSRGBBuffer),-1),!D)throw new Error("Unable to create render buffer");m._autoMSAAManagement=!0;let L=m._hardwareTexture;L||(L=m._hardwareTexture=this._createHardwareTexture()),L.addMSAARenderBuffer(D)}return m}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,s,r=3,n=null,h=null,l=null,o=null,u=null,c=null,_,f,p,T){return this._createTextureBase(e,t,i,s,r,n,h,(...b)=>this._prepareWebGLTexture(...b,u),(b,g,m,w,E,k)=>{const M=this._gl,N=m.width===b&&m.height===g;E._creationFlags=p??0;const A=this._getTexImageParametersForCreateTexture(E.format,E._useSRGBBuffer);if(N)return M.texImage2D(M.TEXTURE_2D,0,A.internalFormat,A.format,A.type,m),!1;const Y=this._caps.maxTextureSize;if(m.width>Y||m.height>Y||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=b,this._workingCanvas.height=g,this._workingContext.drawImage(m,0,0,m.width,m.height,0,0,b,g),M.texImage2D(M.TEXTURE_2D,0,A.internalFormat,A.format,A.type,this._workingCanvas),E.width=b,E.height=g),!1;{const V=new te(this,2);this._bindTextureDirectly(M.TEXTURE_2D,V,!0),M.texImage2D(M.TEXTURE_2D,0,A.internalFormat,A.format,A.type,m),this._rescaleTexture(V,E,s,A.format,()=>{this._releaseTexture(V),this._bindTextureDirectly(M.TEXTURE_2D,E,!0),k()})}return!0},l,o,u,c,_,f,T)}_getTexImageParametersForCreateTexture(e,t){let i,s;return this.webGLVersion===1?(i=this._getInternalFormat(e,t),s=i):(i=this._getInternalFormat(e,!1),s=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:s,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,s,r){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const s=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,r.min),i&&r.hasMipMaps&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const r=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&s!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(r,null)}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,h=0){const l=this._gl;let o=l.TEXTURE_2D;if(e.isCube&&(o=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(o,h,t,i,s,0,r)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){const h=this._gl,l=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),u=r===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=h.TEXTURE_2D;e.isCube&&(c=h.TEXTURE_CUBE_MAP_POSITIVE_X+i);const _=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),p=n?e.width:Math.pow(2,Math.max(_-s,0)),T=n?e.height:Math.pow(2,Math.max(f-s,0));h.texImage2D(c,s,u,p,T,0,o,l,t)}updateTextureData(e,t,i,s,r,n,h=0,l=0,o=!1){const u=this._gl,c=this._getWebGLTextureType(e.type),_=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=u.TEXTURE_2D,p=u.TEXTURE_2D;e.isCube&&(p=u.TEXTURE_CUBE_MAP_POSITIVE_X+h,f=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),u.texSubImage2D(p,l,i,s,r,n,_,c,t),o&&this._gl.generateMipmap(p),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,s,r){const n=this._gl;if(!n)return;const h=this._getSamplingParameters(r,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,h.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,h.min),!i&&!s&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,s,r,n,h,l,o,u){const c=this.getCaps().maxTextureSize,_=Math.min(c,this.needPOTTextures?ge(s.width,c):s.width),f=Math.min(c,this.needPOTTextures?ge(s.height,c):s.height),p=this._gl;if(p){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(p.TEXTURE_2D,e,!0),this._unpackFlipY(r===void 0?!0:!!r),e.baseWidth=s.width,e.baseHeight=s.height,e.width=_,e.height=f,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:u??(t===".jpg"&&!e._useSRGBBuffer?4:5),!l(_,f,s,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,n,h,o)})&&this._prepareWebGLTextureContinuation(e,i,n,h,o)}}_getInternalFormatFromDepthTextureFormat(e,t,i){const s=this._gl;if(!t)return s.STENCIL_INDEX8;let n=i?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;return this.webGLVersion>1?e===15?n=s.DEPTH_COMPONENT16:e===16?n=s.DEPTH_COMPONENT24:e===17||e===13?n=i?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT24:e===14?n=s.DEPTH_COMPONENT32F:e===18&&(n=i?s.DEPTH32F_STENCIL8:s.DEPTH_COMPONENT32F):n=s.DEPTH_COMPONENT16,n}_getWebGLTextureTypeFromDepthTextureFormat(e){const t=this._gl;let i=t.UNSIGNED_INT;return e===15?i=t.UNSIGNED_SHORT:e===17||e===13?i=t.UNSIGNED_INT_24_8:e===14?i=t.FLOAT:e===18?i=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===19&&(i=t.UNSIGNED_BYTE),i}_setupFramebufferDepthAttachments(e,t,i,s,r=1,n,h=!1){const l=this._gl;n=n??(e?13:14);const o=this._getInternalFormatFromDepthTextureFormat(n,t,e);return e&&t?this._createRenderBuffer(i,s,r,l.DEPTH_STENCIL,o,h?-1:l.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,s,r,o,o,h?-1:l.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,s,r,o,o,h?-1:l.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,r,n,h=!0){const o=this._gl.createRenderbuffer();return this._updateRenderBuffer(o,e,t,i,s,r,n,h)}_updateRenderBuffer(e,t,i,s,r,n,h,l=!0){const o=this._gl;return o.bindRenderbuffer(o.RENDERBUFFER,e),s>1&&o.renderbufferStorageMultisample?o.renderbufferStorageMultisample(o.RENDERBUFFER,s,n,t,i):o.renderbufferStorage(o.RENDERBUFFER,r,t,i),h!==-1&&o.framebufferRenderbuffer(o.FRAMEBUFFER,h,o.RENDERBUFFER,e),l&&o.bindRenderbuffer(o.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&(Nt(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let s=0;s<i.length;s++){const r=e.getUniform(i[s]);r&&(this._boundUniforms[s]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,s=!1){let r=!1;const n=t&&t._associatedChannel>-1;if(i&&n&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw d.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(r=!0,this._activateCurrentTexture());return n&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),r}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,s){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,s=!1,r=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const o=t.getInternalTexture();o&&(o._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;s?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!i&&n&&(n._associatedChannel=e);let h=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),h=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(h&&this._bindTextureDirectly(l,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const o=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=o,t.wrapV=o}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,s){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let r=0;r<i.length;r++){const n=i[r].getInternalTexture();n?(this._textureUnits[r]=e+r,n._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let r=0;r<i.length;r++)this._setTexture(this._textureUnits[r],i[r],!0)}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){H()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),Re(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const h=t.RGBA,l=t.UNSIGNED_BYTE,o=new Uint8Array(4);t.readPixels(0,0,1,1,h,l,o),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:i=this._gl.RED;break;case 7:case 33324:case 36761:i=this._gl.RG;break;case 4:case 32852:case 36762:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,s,r=!0,n=!0,h=null){const l=r?4:3,o=r?this._gl.RGBA:this._gl.RGB,u=i*s*l;if(!h)h=new Uint8Array(u);else if(h.length<u)return d.Error(`Data buffer is too small to store the read pixels (${h.length} should be more than ${u})`),Promise.resolve(h);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,o,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=W._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=W._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}C._TempClearColorUint32=new Uint32Array(4);C._TempClearColorInt32=new Int32Array(4);C.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];C._ConcatenateShader=ft;C._IsSupported=null;C._HasMajorPerformanceCaveat=null;var fs=Object.freeze({__proto__:null,ThinEngine:C});C.prototype.setAlphaMode=function(a,e=!1,t=0){if(this._alphaMode[t]===a){if(!e){const s=a===0;this.depthCullingState.depthMask!==s&&(this.depthCullingState.depthMask=s)}return}const i=a===0;this._alphaState.setAlphaBlend(!i,t),this._alphaState.setAlphaMode(a,t),e||(this.depthCullingState.depthMask=i),this._alphaMode[t]=a};class be{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new be(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new be(this.x,this.y,this.width,this.height)}}class oe{static _updateFlagSeed=0;updateFlag=-1;_data;constructor(){this._data=new Float32Array(16)}setValues(e,t,i,s,r,n,h,l,o,u,c,_,f,p,T,b){const g=this._data;return g[0]=e,g[1]=t,g[2]=i,g[3]=s,g[4]=r,g[5]=n,g[6]=h,g[7]=l,g[8]=o,g[9]=u,g[10]=c,g[11]=_,g[12]=f,g[13]=p,g[14]=T,g[15]=b,this.updateFlag=oe._updateFlagSeed++,this}identity(){return this.setValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}orthoOffCenterLH(e,t,i,s,r,n){const h=r,l=n,o=2/(t-e),u=2/(s-i),c=2/(l-h),_=-(l+h)/(l-h),f=(e+t)/(e-t),p=(s+i)/(i-s);return this.setValues(o,0,0,0,0,u,0,0,0,0,c,0,f,p,_,1),this}compose(e,t,i){const s=t*.5,r=Math.sin(s),n=Math.cos(s),h=r+r,l=r*h,o=n*h,u=e.x,c=e.y,_=this._data;return _[0]=(1-l)*u,_[1]=o*u,_[4]=-o*c,_[5]=(1-l)*c,_[12]=i.x,_[13]=i.y,this}multiplyToRef(e,t){const i=this._data,s=e._data,r=i[0],n=i[1],h=i[4],l=i[5],o=i[12],u=i[13],c=s[0],_=s[1],f=s[4],p=s[5],T=s[12],b=s[13];return t._data[0]=r*c+n*f,t._data[1]=r*_+n*p,t._data[4]=h*c+l*f,t._data[5]=h*_+l*p,t._data[12]=o*c+u*f+T,t._data[13]=o*_+u*p+b,this}asArray(){return this._data}decompose(e,t){const i=this._data[0],s=this._data[1],r=this._data[4],n=this._data[5];e.x=Math.hypot(i,r),e.y=Math.hypot(s,n);const h=Math.atan2(r,i);return t.x=this._data[12],t.y=this._data[13],h}}class X{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new X(this.width*e,this.height*t)}clone(){return new X(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new X(0,0)}add(e){return new X(this.width+e.width,this.height+e.height)}subtract(e){return new X(this.width-e.width,this.height-e.height)}scale(e){return new X(this.width*e,this.height*e)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,r=e.height+(t.height-e.height)*i;return new X(s,r)}}class ke{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return e?.shareDepth!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=X.Zero(),this._cachedBaseSize=X.Zero(),this._initialSamplingMode=2,this._texture=ke._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine(),this.wrapU=this._texture._cachedWrapU??this.wrapU,this.wrapV=this._texture._cachedWrapV??this.wrapV,this.wrapR=this._texture._cachedWrapR??this.wrapR)}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture,this._texture.generateMipMaps)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}C.prototype.createDynamicTexture=function(a,e,t,i){const s=new te(this,4);return s.baseWidth=a,s.baseHeight=e,t&&(a=this.needPOTTextures?ge(a,this._caps.maxTextureSize):a,e=this.needPOTTextures?ge(e,this._caps.maxTextureSize):e),s.width=a,s.height=e,s.isReady=!1,s.generateMipMaps=t,s.samplingMode=i,this.updateTextureSamplingMode(i,s),this._internalTexturesCache.push(s),s};C.prototype.updateDynamicTexture=function(a,e,t,i=!1,s,r=!1,n=!1){if(!a)return;const h=this._gl,l=h.TEXTURE_2D,o=this._bindTextureDirectly(l,a,!0,r);this._unpackFlipY(t===void 0?a.invertY:t),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const u=this._getWebGLTextureType(a.type),c=this._getInternalFormat(s||a.format),_=this._getRGBABufferInternalSizedFormat(a.type,c);h.texImage2D(l,0,_,c,u,e),a.generateMipMaps&&h.generateMipmap(l),o||this._bindTextureDirectly(l,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),s&&(a.format=s),a._dynamicTextureSource=e,a._premulAlpha=i,a.invertY=t||!1,a.isReady=!0};function Ii(a){const e={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(a.it!==void 0)for(let t=0;t<a.it.length;t++)a.it[t].ty==="rc"?Di(e,a.it[t]):a.it[t].ty==="sh"&&Pi(e,a.it[t]);return{width:Math.ceil(e.maxX-e.minX),height:Math.ceil(e.maxY-e.minY),centerX:Math.ceil((e.maxX+e.minX)/2),centerY:Math.ceil((e.maxY+e.minY)/2)}}function Di(a,e){const t=e.s.k,i=e.p.k;re(a,i[0]-t[0]/2,i[1]-t[1]/2),re(a,i[0]+t[0]/2,i[1]-t[1]/2),re(a,i[0]+t[0]/2,i[1]+t[1]/2),re(a,i[0]-t[0]/2,i[1]+t[1]/2)}function Pi(a,e){const t=e.ks.k,i=t.v,s=t.i,r=t.o;for(let n=0;n<i.length;n++)re(a,i[n][0],i[n][1]);for(let n=0;n<i.length;n++){if(!t.c&&n===i.length-1)continue;const h=i[n],l=n===i.length-1?i[0]:i[n+1],o=r[n],u=n===i.length-1?s[0]:s[n+1];Bi(a,h[0],h[1],l[0],l[1],h[0]+o[0],h[1]+o[1],l[0]+u[0],l[1]+u[1])}}function Bi(a,e,t,i,s,r,n,h,l){const o=3*(i-3*h+3*r-e),u=6*(h-2*r+e),c=3*(r-e),_=3*(s-3*l+3*n-t),f=6*(l-2*n+t),p=3*(n-t),T=Je(o,u,c),b=Je(_,f,p),g=new Set(T.concat(b));for(const m of g)if(m>=0&&m<=1){const w=et(m,e,r,h,i),E=et(m,t,n,l,s);re(a,w,E)}}function Je(a,e,t){const i=[];if(Math.abs(a)<1e-10){if(Math.abs(e)>1e-10){const r=-t/e;i.push(r)}return i}const s=e*e-4*a*t;if(s<0)return i;if(Math.abs(s)<1e-10){const r=-e/(2*a);i.push(r)}else{const r=Math.sqrt(s),n=(-e+r)/(2*a),h=(-e-r)/(2*a);i.push(n),i.push(h)}return i}function et(a,e,t,i,s){const r=1-a;return r*r*r*e+3*r*r*a*t+3*r*a*a*i+a*a*a*s}function re(a,e,t){e<a.minX&&(a.minX=e),e>a.maxX&&(a.maxX=e),t<a.minY&&(a.minY=t),t>a.maxY&&(a.maxY=t)}const Z=2048,tt=5,Mi=64,Li={r:1,g:1,b:1,a:0},it=5,ie=1,Oi=4;class Ui{_engine;_spritesCanvas;_spritesCanvasContext;_spritesInternalTexture;_spritesTexture;_isDirty;_currentX;_currentY;_maxRowHeight;_spriteAtlasInfo;get texture(){return this._spritesTexture}constructor(e){this._engine=e,this._isDirty=!1,this._currentX=0,this._currentY=0,this._maxRowHeight=0,this._spritesCanvas=new OffscreenCanvas(Z,Z),this._spritesCanvasContext=this._spritesCanvas.getContext("2d"),this._spritesInternalTexture=this._engine.createDynamicTexture(Z,Z,!1,2),this._engine.updateDynamicTexture(this._spritesInternalTexture,this._spritesCanvas,!1),this._spritesTexture=new ke(this._spritesInternalTexture),this._spritesTexture.wrapU=0,this._spritesTexture.wrapV=0,this._spriteAtlasInfo={uOffset:0,vOffset:0,cellWidth:0,cellHeight:0,widthPx:0,heightPx:0,centerX:0,centerY:0}}addLottieShape(e,t){const i=Ii(e);return this._spriteAtlasInfo.cellWidth=i.width*t.x,this._spriteAtlasInfo.cellHeight=i.height*t.y,this._spriteAtlasInfo.centerX=i.centerX,this._spriteAtlasInfo.centerY=i.centerY,this._currentX+this._spriteAtlasInfo.cellWidth>Z&&(this._currentX=0,this._currentY+=this._maxRowHeight+tt,this._maxRowHeight=0),this._spriteAtlasInfo.uOffset=this._currentX/Z,this._spriteAtlasInfo.vOffset=this._currentY/Z,this._drawVectorShape(e,i,t),this._currentX+=this._spriteAtlasInfo.cellWidth+tt,this._maxRowHeight=Math.max(this._maxRowHeight,this._spriteAtlasInfo.cellHeight),this._spriteAtlasInfo.widthPx=i.width,this._spriteAtlasInfo.heightPx=i.height,this._isDirty=!0,this._spriteAtlasInfo}updateAtlasTexture(){this._isDirty&&(this._engine.updateDynamicTexture(this._spritesInternalTexture,this._spritesCanvas,!1),this._isDirty=!1)}releaseCanvas(){this._spritesCanvasContext=void 0,this._spritesCanvas=void 0}_drawVectorShape(e,t,i){if(this._spritesCanvasContext.save(),this._spritesCanvasContext.translate(this._currentX,this._currentY),this._spritesCanvasContext.scale(i.x,i.y),this._spritesCanvasContext.beginPath(),e.it)for(let s=0;s<e.it.length;s++){const r=e.it[s];switch(r.ty){case"rc":this._drawRectangle(r);break;case"sh":this._drawPath(r,t);break;case"fl":this._drawFill(r);break;case"gf":this._drawGradientFill(r,t);break}}this._spritesCanvasContext.restore()}_drawRectangle(e){const t=e.s.k,i=e.r.k;i<=0?this._spritesCanvasContext.rect(0,0,t[0],t[1]):this._spritesCanvasContext.roundRect(0,0,t[0],t[1],i)}_drawPath(e,t){const i=e.ks.k,s=t.width/2-t.centerX,r=t.height/2-t.centerY,n=i.v,h=i.i,l=i.o;if(n.length>0){this._spritesCanvasContext.moveTo(n[0][0]+s,n[0][1]+r);for(let o=0;o<n.length-1;o++){const u=n[o],c=n[o+1],_=l[o],f=h[o+1];this._spritesCanvasContext.bezierCurveTo(u[0]+s+_[0],u[1]+r+_[1],c[0]+s+f[0],c[1]+r+f[1],c[0]+s,c[1]+r)}if(i.c){const o=n[n.length-1],u=n[0],c=l[n.length-1],_=h[0];this._spritesCanvasContext.bezierCurveTo(o[0]+s+c[0],o[1]+r+c[1],u[0]+s+_[0],u[1]+r+_[1],u[0]+s,u[1]+r),this._spritesCanvasContext.closePath()}}}_drawFill(e){const t=this._lottieColorToCSSColor(e.c.k,e.o.k/100);this._spritesCanvasContext.fillStyle=t,this._spritesCanvasContext.fill()}_drawGradientFill(e,t){switch(e.t){case 1:{this._drawLinearGradientFill(e,t);break}case 2:{this._drawRadialGradientFill(e,t);break}}}_drawLinearGradientFill(e,t){const i=t.width/2-t.centerX,s=t.height/2-t.centerY,r=e.s.k,n=e.e.k,h=this._spritesCanvasContext.createLinearGradient(r[0]+i,r[1]+s,n[0]+i,n[1]+s);this._addColorStops(h,e),this._spritesCanvasContext.fillStyle=h,this._spritesCanvasContext.fill()}_drawRadialGradientFill(e,t){const i=t.width/2-t.centerX,s=t.height/2-t.centerY,r=e.s.k,n=e.e.k,h=this._spritesCanvasContext.createRadialGradient(r[0]+i,r[1]+s,0,n[0]+i,n[1]+s,Math.hypot(n[0]-r[0],n[1]-r[1]));this._addColorStops(h,e),this._spritesCanvasContext.fillStyle=h,this._spritesCanvasContext.fill()}_addColorStops(e,t){const i=t.g.p,s=t.g.k.k;let r;if(s.length/i===4)r=this._gradientColorsToCssColor(s,i,!1);else if(s.length/i===6)r=this._gradientColorsToCssColor(s,i,!0);else return;for(let n=0;n<i;n++)e.addColorStop(r[n].offset,r[n].color)}_gradientColorsToCssColor(e,t,i){const s=i?0:1,r=[];for(let n=0;n<t;n++){const h=n*4;r.push({offset:e[h],color:this._lottieColorToCSSColor(e.slice(h+s,h+4),1)})}return r}_lottieColorToCSSColor(e,t){if(e.length!==3&&e.length!==4)return"rgba(0, 0, 0, 1)";const i=Math.round(e[0]*255),s=Math.round(e[1]*255),r=Math.round(e[2]*255),n=(e[3]||1)*t;return`rgba(${i}, ${s}, ${r}, ${n})`}}class se{x1;y1;x2;y2;_f0;_f1;_f2;constructor(e=0,t=0,i=1,s=1){this.x1=e,this.y1=t,this.x2=i,this.y2=s,this._f0=1-3*this.x2+3*this.x1,this._f1=3*this.x2-6*this.x1,this._f2=3*this.x1}interpolate(e){if(e===0)return 0;if(e===1)return 1;let t=e;for(let i=0;i<Oi;i++){const s=t*t,r=s*t,n=this._f0*r+this._f1*s+this._f2*t,h=1/(3*this._f0*s+2*this._f1*t+this._f2);t-=(n-e)*h,t=Math.min(1,Math.max(0,t))}return 3*(1-t)*(1-t)*t*this.y1+3*(1-t)*t*t*this.y2+t*t*t}}class xe{_id;_position;_rotation;_scale;_worldMatrix;_localMatrix;_globalMatrix;_opacity;_parent;_children;_isVisible=!1;_isAnimated=!1;_animationsFunctions=[];_isControl=!1;_isShape=!1;get children(){return this._children}get isShape(){return this._isShape}get id(){return this._id}get worldMatrix(){return this._worldMatrix}get isAnimated(){return this._isAnimated}get opacity(){return this._isVisible?this._opacity.currentValue/100:0}get startScale(){return this._scale.startValue}constructor(e,t,i,s,r,n){this._isVisible=!1,this._id=e,this._position=t||{startValue:{x:0,y:0},currentValue:{x:0,y:0},currentKeyframeIndex:0},this._rotation=i||{startValue:0,currentValue:0,currentKeyframeIndex:0},this._scale=s||{startValue:{x:1,y:1},currentValue:{x:1,y:1},currentKeyframeIndex:0},this._localMatrix=new oe,this._globalMatrix=new oe,this._localMatrix.compose(this._scale.currentValue,this._rotation.currentValue,this._position.currentValue),this._opacity=r||{startValue:100,currentValue:100,currentKeyframeIndex:0},this._position.keyframes!==void 0&&this._position.keyframes.length>0&&(this._isAnimated=!0,this._animationsFunctions.push(h=>this._updatePosition(h))),this._rotation.keyframes!==void 0&&this._rotation.keyframes.length>0&&(this._isAnimated=!0,this._animationsFunctions.push(h=>this._updateRotation(h))),this._scale.keyframes!==void 0&&this._scale.keyframes.length>0&&(this._isAnimated=!0,this._animationsFunctions.push(h=>this._updateScale(h))),this._children=[],n?(this._worldMatrix=this._globalMatrix,n.isAnimated||!n.parent||this.isAnimated||n._isControl?(this._parent=n,n._children.push(this),this._localMatrix.multiplyToRef(n._worldMatrix,this._globalMatrix)):(this._localMatrix.multiplyToRef(n._localMatrix,this._localMatrix),this._parent=n.parent,this._localMatrix.multiplyToRef(this._parent._worldMatrix,this._globalMatrix),n.parent._children.push(this))):this._worldMatrix=this._localMatrix}get parent(){return this._parent}set isVisible(e){if(this._isVisible!==e){this._isVisible=e;for(let t=0;t<this._children.length;t++)this._children[t].isVisible=e}}reset(){this._position.currentValue={x:this._position.startValue.x,y:this._position.startValue.y},this._position.keyframes&&(this._position.currentKeyframeIndex=0),this._rotation.currentValue=this._rotation.startValue,this._rotation.keyframes&&(this._rotation.currentKeyframeIndex=0),this._scale.currentValue={x:this._scale.startValue.x,y:this._scale.startValue.y},this._scale.keyframes&&(this._scale.currentKeyframeIndex=0),this._opacity.currentValue=this._opacity.startValue,this._opacity.keyframes&&(this._opacity.currentKeyframeIndex=0);for(let e=0;e<this._children.length;e++)this._children[e].reset();this._parent===void 0&&this.update(0,!1,!0),this._isVisible=!1}update(e,t=!1,i=!1){let s=i;if(this.isAnimated){for(var r=0;r<this._animationsFunctions.length;r++)s=this._animationsFunctions[r](e)||s;s&&this._localMatrix.compose(this._scale.currentValue,this._rotation.currentValue,this._position.currentValue)}this._parent&&(t||s)&&this._localMatrix.multiplyToRef(this._parent._worldMatrix,this._globalMatrix);for(let n=0;n<this._children.length;n++)this._children[n].update(e,s||t);return s||t}_updatePosition(e){const t=this._position.keyframes;if(e<t[0].time)return!1;if(e>t[t.length-1].time)return this._position.currentValue=t[t.length-1].value,!0;let i=-1;for(let o=this._position.currentKeyframeIndex;o<t.length-1;o++)if(e>=t[o].time&&e<t[o+1].time){i=o,this._position.currentKeyframeIndex=i;break}if(i===-1)return!1;let s=t[i],r=t[i+1],n=(e-s.time)/(r.time-s.time),h=s.easeFunction1.interpolate(n);this._position.currentValue.x=s.value.x+h*(r.value.x-s.value.x);let l=s.easeFunction2.interpolate(n);return this._position.currentValue.y=s.value.y+l*(r.value.y-s.value.y),!0}_updateRotation(e){const t=this._rotation.keyframes;if(e<t[0].time)return!1;if(e>t[t.length-1].time)return this._rotation.currentValue=t[t.length-1].value,!0;let i=-1;for(let l=this._rotation.currentKeyframeIndex;l<t.length-1;l++)if(e>=t[l].time&&e<t[l+1].time){i=l,this._rotation.currentKeyframeIndex=i;break}if(i===-1)return!1;let s=t[i],r=t[i+1],n=(e-s.time)/(r.time-s.time),h=s.easeFunction.interpolate(n);return this._rotation.currentValue=-(s.value+h*(r.value-s.value)),!0}_updateScale(e){const t=this._scale.keyframes;if(e<t[0].time)return!1;if(e>t[t.length-1].time)return this._scale.currentValue=t[t.length-1].value,!0;let i=-1;for(let o=this._scale.currentKeyframeIndex;o<t.length-1;o++)if(e>=t[o].time&&e<t[o+1].time){i=o,this._scale.currentKeyframeIndex=i;break}if(i===-1)return!1;let s=t[i],r=t[i+1],n=(e-s.time)/(r.time-s.time),h=s.easeFunction1.interpolate(n);this._scale.currentValue.x=s.value.x+h*(r.value.x-s.value.x);let l=s.easeFunction2.interpolate(n);return this._scale.currentValue.y=s.value.y+l*(r.value.y-s.value.y),!0}_updateOpacity(e){if(this._opacity.keyframes===void 0||this._opacity.keyframes.length===0||e<this._opacity.keyframes[0].time)return!1;if(e>this._opacity.keyframes[this._opacity.keyframes.length-1].time)return this._opacity.currentValue=this._opacity.keyframes[this._opacity.keyframes.length-1].value,!0;let t=-1;for(let h=this._opacity.currentKeyframeIndex;h<this._opacity.keyframes.length-1;h++)if(e>=this._opacity.keyframes[h].time&&e<this._opacity.keyframes[h+1].time){t=h,this._opacity.currentKeyframeIndex=t;break}if(t===-1)return!1;let i=this._opacity.keyframes[t],s=this._opacity.keyframes[t+1],r=(e-i.time)/(s.time-i.time),n=i.easeFunction.interpolate(r);return this._opacity.currentValue=i.value+n*(s.value-i.value),!0}}class Gi extends xe{_inFrame;_outFrame;constructor(e,t,i,s,r,n,h,l){super(e,s,r,n,h,l),this._inFrame=t,this._outFrame=i,this._isControl=!0}update(e,t=!1,i=!1){return this.isVisible=e>=this._inFrame&&e<=this._outFrame-1,super.update(e,t,i)}}class ki{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,s,r){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=s||1,this._animationStarted=!0,this._onBaseAnimationEnd=r,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}const we={x:1,y:1};class Ni extends xe{_sprite;_originalWidth;_originalHeight;_firstTime=!0;constructor(e,t,i,s,r,n,h){super(e,i,s,r,n,h),this._sprite=t,this._originalWidth=t.width,this._originalHeight=t.height,this._isShape=!0}update(e,t=!1){const i=super.update(e,t)||this._firstTime;if(this._firstTime=!1,i){const s=this.worldMatrix.decompose(we,this._sprite.position);this._sprite.width=this._originalWidth*we.x,this._sprite.height=this._originalHeight*we.y,this._sprite.angle=s}return this._sprite.color.a=this.opacity,i}}function Vi(a,e,t,i){switch(e){case 5120:{let s=a.getInt8(t);return i&&(s=Math.max(s/127,-1)),s}case 5121:{let s=a.getUint8(t);return i&&(s=s/255),s}case 5122:{let s=a.getInt16(t,!0);return i&&(s=Math.max(s/32767,-1)),s}case 5123:{let s=a.getUint16(t,!0);return i&&(s=s/65535),s}case 5124:return a.getInt32(t,!0);case 5125:return a.getUint32(t,!0);case 5126:return a.getFloat32(t,!0);default:throw new Error(`Invalid component type ${e}`)}}function Hi(a,e,t,i,s){switch(e){case 5120:{i&&(s=Math.round(s*127)),a.setInt8(t,s);break}case 5121:{i&&(s=Math.round(s*255)),a.setUint8(t,s);break}case 5122:{i&&(s=Math.round(s*32767)),a.setInt16(t,s,!0);break}case 5123:{i&&(s=Math.round(s*65535)),a.setUint16(t,s,!0);break}case 5124:{a.setInt32(t,s,!0);break}case 5125:{a.setUint32(t,s,!0);break}case 5126:{a.setFloat32(t,s,!0);break}default:throw new Error(`Invalid component type ${e}`)}}function Q(a){switch(a){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${a}'`)}}function Me(a,e,t,i,s,r,n,h){const l=new Array(i),o=new Array(i);if(a instanceof Array){let u=e/4;const c=t/4;for(let _=0;_<r;_+=i){for(let f=0;f<i;f++)l[f]=o[f]=a[u+f];h(o,_);for(let f=0;f<i;f++)l[f]!==o[f]&&(a[u+f]=o[f]);u+=c}}else{const u=ArrayBuffer.isView(a)?new DataView(a.buffer,a.byteOffset,a.byteLength):new DataView(a),c=Q(s);for(let _=0;_<r;_+=i){for(let f=0,p=e;f<i;f++,p+=c)l[f]=o[f]=Vi(u,s,p,n);h(o,_);for(let f=0,p=e;f<i;f++,p+=c)l[f]!==o[f]&&Hi(u,s,p,n,o[f]);e+=t}}}function st(a,e,t,i,s,r,n,h){const l=e*Q(t),o=n*e;if(t!==5126||s!==l){const u=new Float32Array(o);return Me(a,i,s,e,t,o,r,(c,_)=>{for(let f=0;f<e;f++)u[_+f]=c[f]}),u}if(!(a instanceof Array||a instanceof Float32Array)||i!==0||a.length!==o)if(a instanceof Array){const u=i/4;return a.slice(u,u+o)}else{if(a instanceof ArrayBuffer)return new Float32Array(a,i,o);{const u=a.byteOffset+i;return(u&3)!==0&&(d.Warn("Float array must be aligned to 4-bytes border"),h=!0),h?new Float32Array(a.buffer.slice(u,u+o*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(a.buffer,u,o)}}return h?a.slice():a}class Ee{get isDisposed(){return this._isDisposed}constructor(e,t,i,s=0,r=!1,n=!1,h=!1,l,o){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=l||1,this._label=o,t instanceof ue?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=h?s:s*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(e,t,i,s,r,n=!1,h){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,o=s?n?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new x(this._engine,this,e,this._updatable,!0,o,r===void 0?this._instanced:r,l,i,void 0,void 0,!0,this._divisor||h)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}d.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class x{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,s,r,n,h,l,o,u,c=!1,_=!1,f=1,p=!1){this._isDisposed=!1;let T=!1;if(this.engine=e,typeof s=="object"&&s!==null?(T=s.updatable??!1,r=s.postponeInternalCreation,n=s.stride,h=s.instanced,l=s.offset,o=s.size,u=s.type,c=s.normalized??!1,_=s.useBytes??!1,f=s.divisor??1,p=s.takeBufferOwnership??!1,this._label=s.label):T=!!s,t instanceof Ee?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new Ee(e,t,T,n,r,h,_,f,this._label),this._ownsBuffer=!0),this.uniqueId=x._Counter++,this._kind=i,u===void 0){const g=this.getData();this.type=g?x.GetDataType(g):x.FLOAT}else this.type=u;const b=Q(this.type);_?(this._size=o||(n?n/b:x.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*b,this.byteOffset=l||0):(this._size=o||n||x.DeduceStride(i),this.byteStride=n?n*b:this._buffer.byteStride||this._size*b,this.byteOffset=(l||0)*b),this.normalized=c,this._instanced=h!==void 0?h:!1,this._instanceDivisor=h?f:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?st(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Q(this.type)}getOffset(){return this.byteOffset/Q(this.type)}getSize(e=!1){return e?this._size*Q(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){Me(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,(i,s)=>{for(let r=0;r<this._size;r++)t(i[r],s+r)})}_alignBuffer(){}static DeduceStride(e){switch(e){case x.UVKind:case x.UV2Kind:case x.UV3Kind:case x.UV4Kind:case x.UV5Kind:case x.UV6Kind:return 2;case x.NormalKind:case x.PositionKind:return 3;case x.ColorKind:case x.ColorInstanceKind:case x.MatricesIndicesKind:case x.MatricesIndicesExtraKind:case x.MatricesWeightsKind:case x.MatricesWeightsExtraKind:case x.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?x.BYTE:e instanceof Uint8Array?x.UNSIGNED_BYTE:e instanceof Int16Array?x.SHORT:e instanceof Uint16Array?x.UNSIGNED_SHORT:e instanceof Int32Array?x.INT:e instanceof Uint32Array?x.UNSIGNED_INT:x.FLOAT}static GetTypeByteLength(e){return Q(e)}static ForEach(e,t,i,s,r,n,h,l){Me(e,t,i,s,r,n,h,(o,u)=>{for(let c=0;c<s;c++)l(o[c],u+c)})}static GetFloatData(e,t,i,s,r,n,h,l){return st(e,t,i,s,r,n,h,l)}}x._Counter=0;x.BYTE=5120;x.UNSIGNED_BYTE=5121;x.SHORT=5122;x.UNSIGNED_SHORT=5123;x.INT=5124;x.UNSIGNED_INT=5125;x.FLOAT=5126;x.PositionKind="position";x.NormalKind="normal";x.TangentKind="tangent";x.UVKind="uv";x.UV2Kind="uv2";x.UV3Kind="uv3";x.UV4Kind="uv4";x.UV5Kind="uv5";x.UV6Kind="uv6";x.ColorKind="color";x.ColorInstanceKind="instanceColor";x.MatricesIndicesKind="matricesIndices";x.MatricesWeightsKind="matricesWeights";x.MatricesIndicesExtraKind="matricesIndicesExtra";x.MatricesWeightsExtraKind="matricesWeightsExtra";class rt{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){this.effect=e,t!==void 0&&(this.defines=t),i&&this.drawContext?.reset()}dispose(e=!1){if(this.effect){const t=this.effect;e?t.dispose():xi.SetImmediate(()=>{t.getEngine().onEndFrameObservable.addOnce(()=>{t.dispose()})}),this.effect=null}this.drawContext?.dispose()}}function Ne(a,e){const t=[];for(let i=0;i<a;++i)t.push(e());return t}function ds(a,e){return Ne(a,e)}function Wi(a,e,t){const i=a[e];if(typeof i!="function")return null;const s=function(){const r=a.length,n=s.previous.apply(a,arguments);return t(e,r),n};return i.next=s,s.previous=i,a[e]=s,()=>{const r=s.previous;if(!r)return;const n=s.next;n?(r.next=n,n.previous=r):(r.next=void 0,a[e]=r),s.next=void 0,s.previous=void 0}}const Xi=["push","splice","pop","shift","unshift"];function gs(a,e){const t=Xi.map(i=>Wi(a,i,e));return()=>{for(const i of t)i?.()}}const St={};function Rt(a,e){St[a]=e}function ps(a){return St[a]}const zi=1/2.2,Yi=2.2,yt=.001;function J(a,e,t=1401298e-51){return Math.abs(a-e)<=t}function ms(a,e){return a===e?a:Math.random()*(e-a)+a}function bs(a,e,t){return a+(e-a)*t}function ee(a,e=0,t=1){return Math.min(t,Math.max(e,a))}function xs(a){return a-=Math.PI*2*Math.floor((a+Math.PI)/(Math.PI*2)),a}function z(a){const e=a.toString(16);return a<=15?("0"+e).toUpperCase():e.toUpperCase()}function Es(a){if(Math.log2)return Math.floor(Math.log2(a));if(a<0)return NaN;if(a===0)return-1/0;let e=0;if(a<1){for(;a<1;)e++,a=a*2;e=-e}else if(a>1)for(;a>1;)e++,a=Math.floor(a/2);return e}function ne(a){return Math.pow(a,Yi)}function ae(a){return a<=.04045?.0773993808*a:Math.pow(.947867299*(a+.055),2.4)}function he(a){return Math.pow(a,zi)}function le(a){return a<=.0031308?12.92*a:1.055*Math.pow(a,.41666)-.055}class S{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return S.FromArrayToRef(e,t,this),this}toColor4(e=1){return new F(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new S(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new S(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=yt){return J(this.r,e.r,t)&&J(this.g,e.g,t)&&J(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new S(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=ee(this.r,e,t),i.g=ee(this.g,e,t),i.b=ee(this.b,e,t),i}add(e){return new S(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new S(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new S(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,s){return s.r=this.r-e,s.g=this.g-t,s.b=this.b-i,s}clone(){return new S(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+z(e)+z(t)+z(i)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,this)}toHSV(){return this.toHSVToRef(new S)}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,r=Math.max(t,i,s),n=Math.min(t,i,s);let h=0,l=0;const o=r,u=r-n;return r!==0&&(l=u/r),r!=n&&(r==t?(h=(i-s)/u,i<s&&(h+=6)):r==i?h=(s-t)/u+2:r==s&&(h=(t-i)/u+4),h*=60),e.r=h,e.g=l,e.b=o,e}toLinearSpace(e=!1){const t=new S;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=ae(this.r),e.g=ae(this.g),e.b=ae(this.b)):(e.r=ne(this.r),e.g=ne(this.g),e.b=ne(this.b)),this}toGammaSpace(e=!1){const t=new S;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=le(this.r),e.g=le(this.g),e.b=le(this.b)):(e.r=he(this.r),e.g=he(this.g),e.b=he(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const r=i*t,n=e/60,h=r*(1-Math.abs(n%2-1));let l=0,o=0,u=0;n>=0&&n<=1?(l=r,o=h):n>=1&&n<=2?(l=h,o=r):n>=2&&n<=3?(o=r,u=h):n>=3&&n<=4?(o=h,u=r):n>=4&&n<=5?(l=h,u=r):n>=5&&n<=6&&(l=r,u=h);const c=i-r;return s.r=l+c,s.g=o+c,s.b=u+c,s}static FromHSV(e,t,i){const s=new S(0,0,0);return S.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){return new S(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new S(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new S(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new S(0,0,0);return S.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,r){const n=r*r,h=r*n,l=2*h-3*n+1,o=-2*h+3*n,u=h-2*n+r,c=h-n,_=e.r*l+i.r*o+t.r*u+s.r*c,f=e.g*l+i.g*o+t.g*u+s.g*c,p=e.b*l+i.b*o+t.b*u+s.b*c;return new S(_,f,p)}static Hermite1stDerivative(e,t,i,s,r){const n=S.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const h=r*r;n.r=(h-r)*6*e.r+(3*h-4*r+1)*t.r+(-h+r)*6*i.r+(3*h-2*r)*s.r,n.g=(h-r)*6*e.g+(3*h-4*r+1)*t.g+(-h+r)*6*i.g+(3*h-2*r)*s.g,n.b=(h-r)*6*e.b+(3*h-4*r+1)*t.b+(-h+r)*6*i.b+(3*h-2*r)*s.b}static Red(){return new S(1,0,0)}static Green(){return new S(0,1,0)}static Blue(){return new S(0,0,1)}static Black(){return new S(0,0,0)}static get BlackReadOnly(){return S._BlackReadOnly}static White(){return new S(1,1,1)}static Purple(){return new S(.5,0,.5)}static Magenta(){return new S(1,0,1)}static Yellow(){return new S(1,1,0)}static Gray(){return new S(.5,.5,.5)}static Teal(){return new S(0,1,1)}static Random(){return new S(Math.random(),Math.random(),Math.random())}}S._V8PerformanceHack=new S(.5,.5,.5);S._BlackReadOnly=S.Black();Object.defineProperties(S.prototype,{dimension:{value:[3]},rank:{value:1}});class F{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new F(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,s){return this.r+=e,this.g+=t,this.b+=i,this.a+=s,this}subtract(e){return new F(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,s){return new F(this.r-e,this.g-t,this.b-i,this.a-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r.a=this.a-s,r}scale(e){return new F(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=ee(this.r,e,t),i.g=ee(this.g,e,t),i.b=ee(this.b,e,t),i.a=ee(this.a,e,t),i}multiply(e){return new F(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,s){return new F(this.r*e,this.g*t,this.b*i,this.a*s)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,s){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(s,this.a),this}maximizeInPlaceFromFloats(e,t,i,s){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(s,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=yt){return J(this.r,e.r,t)&&J(this.g,e.g,t)&&J(this.b,e.b,t)&&J(this.a,e.a,t)}equalsToFloats(e,t,i,s){return this.r===e&&this.g===t&&this.b===i&&this.a===s}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new F().copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),s=Math.round(this.b*255);if(e)return"#"+z(t)+z(i)+z(s);const r=Math.round(this.a*255);return"#"+z(t)+z(i)+z(s)+z(r)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,e.length===9&&(this.a=parseInt(e.substring(7,9),16)/255),this)}toLinearSpace(e=!1){const t=new F;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=ae(this.r),e.g=ae(this.g),e.b=ae(this.b)):(e.r=ne(this.r),e.g=ne(this.g),e.b=ne(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new F;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=le(this.r),e.g=le(this.g),e.b=le(this.b)):(e.r=he(this.r),e.g=he(this.g),e.b=he(this.b)),e.a=this.a,this}static FromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?new F(0,0,0,0):new F(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return F.LerpToRef(e,t,i,new F)}static LerpToRef(e,t,i,s){return s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i,s}static Hermite(e,t,i,s,r){const n=r*r,h=r*n,l=2*h-3*n+1,o=-2*h+3*n,u=h-2*n+r,c=h-n,_=e.r*l+i.r*o+t.r*u+s.r*c,f=e.g*l+i.g*o+t.g*u+s.g*c,p=e.b*l+i.b*o+t.b*u+s.b*c,T=e.a*l+i.a*o+t.a*u+s.a*c;return new F(_,f,p,T)}static Hermite1stDerivative(e,t,i,s,r){const n=new F;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const h=r*r;n.r=(h-r)*6*e.r+(3*h-4*r+1)*t.r+(-h+r)*6*i.r+(3*h-2*r)*s.r,n.g=(h-r)*6*e.g+(3*h-4*r+1)*t.g+(-h+r)*6*i.g+(3*h-2*r)*s.g,n.b=(h-r)*6*e.b+(3*h-4*r+1)*t.b+(-h+r)*6*i.b+(3*h-2*r)*s.b,n.a=(h-r)*6*e.a+(3*h-4*r+1)*t.a+(-h+r)*6*i.a+(3*h-2*r)*s.a}static FromColor3(e,t=1){return new F(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new F(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new F(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let s=0;s<e.length;s+=3){const r=s/3*4;i[r]=e[s],i[r+1]=e[s+1],i[r+2]=e[s+2],i[r+3]=1}return i}return e}}F._V8PerformanceHack=new F(.5,.5,.5,.5);Object.defineProperties(F.prototype,{dimension:{value:[4]},rank:{value:1}});Ne(3,S.Black);Ne(3,()=>new F(0,0,0,0));Rt("BABYLON.Color3",S);Rt("BABYLON.Color4",F);class B{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}B.FALLOFF_DEFAULT=0;B.FALLOFF_PHYSICAL=1;B.FALLOFF_GLTF=2;B.FALLOFF_STANDARD=3;B.LIGHTMAP_DEFAULT=0;B.LIGHTMAP_SPECULAR=1;B.LIGHTMAP_SHADOWSONLY=2;B.INTENSITYMODE_AUTOMATIC=0;B.INTENSITYMODE_LUMINOUSPOWER=1;B.INTENSITYMODE_LUMINOUSINTENSITY=2;B.INTENSITYMODE_ILLUMINANCE=3;B.INTENSITYMODE_LUMINANCE=4;B.LIGHTTYPEID_POINTLIGHT=0;B.LIGHTTYPEID_DIRECTIONALLIGHT=1;B.LIGHTTYPEID_SPOTLIGHT=2;B.LIGHTTYPEID_HEMISPHERICLIGHT=3;B.LIGHTTYPEID_RECT_AREALIGHT=4;S.Black();function Ki(a,e,t){if(!a||a.LOGARITHMICDEPTH||a.indexOf&&a.indexOf("LOGARITHMICDEPTH")>=0){const i=t.activeCamera;i.mode===1&&d.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(i.maxZ+1)/Math.LN2))}}class Te{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&d.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,s=null,r){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=r?.pixelPerfect??!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=s,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new Ee(e,this._vertexData,!0,this._vertexBufferSize);const n=this._buffer.createVertexBuffer(x.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let l=6,o;if(this._useInstancing){const f=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new Ee(e,f,!1,2),o=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else o=this._buffer.createVertexBuffer("offsets",l,2,this._vertexBufferSize,this._useInstancing),l+=2;const u=this._buffer.createVertexBuffer("inverts",l,2,this._vertexBufferSize,this._useInstancing),c=this._buffer.createVertexBuffer("cellInfo",l+2,4,this._vertexBufferSize,this._useInstancing),_=this._buffer.createVertexBuffer(x.ColorKind,l+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[x.PositionKind]=n,this._vertexBuffers.options=h,this._vertexBuffers.offsets=o,this._vertexBuffers.inverts=u,this._vertexBuffers.cellInfo=c,this._vertexBuffers[x.ColorKind]=_,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!Te.ForceGLSL?(this._shaderLanguage=1,await Promise.all([import("./sprites.vertex-iVyBfGc5.js"),import("./sprites.fragment-CPD-TDyz.js")])):await Promise.all([Promise.resolve().then(function(){return Qi}),Promise.resolve().then(function(){return rs})]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){if(this._isDisposed||!this._shadersLoaded)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new rt(this._engine),this._drawWrapperDepth=new rt(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+=`#define PIXEL_PERFECT
`),this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&this._fogEnabled&&(e+=`#define FOG
`),this._useLogarithmicDepth&&(e+=`#define LOGARITHMICDEPTH
`),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[x.PositionKind,"options","offsets","inverts","cellInfo",x.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperBase.effect._refCount++,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,s,r=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!e.length)return;const n=this._drawWrapperBase,h=this._drawWrapperDepth,l=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0,o=n.effect;if(!o.isReady())return;const u=this._engine,c=!!(this._scene&&this._scene.useRightHandedSystem),_=Math.min(this._capacity,e.length);let f=0,p=!0;for(let m=0;m<_;m++){const w=e[m];if(!w||!w.isVisible)continue;p=!1,w._animate(t);const E=this.texture.getBaseSize();this._appendSpriteVertex(f++,w,0,0,E,c,r),this._useInstancing||(this._appendSpriteVertex(f++,w,1,0,E,c,r),this._appendSpriteVertex(f++,w,1,1,E,c,r),this._appendSpriteVertex(f++,w,0,1,E,c,r))}if(p)return;this._buffer.update(this._vertexData);const T=!!u.depthCullingState.cull,b=u.depthCullingState.zOffset,g=u.depthCullingState.zOffsetUnits;if(u.setState(T,b,!1,!1,void 0,void 0,g),u.enableEffect(n),o.setTexture("diffuseSampler",this.texture),o.setMatrix("view",i),o.setMatrix("projection",s),l){const m=this._scene;o.setFloat4("vFogInfos",m.fogMode,m.fogStart,m.fogEnd,m.fogDensity),o.setColor3("vFogColor",m.fogColor)}this.useLogarithmicDepth&&this._scene&&Ki(n.defines,o,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=u.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,o)),u.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):u.bindBuffers(this._vertexBuffers,this._indexBuffer,o),u.depthCullingState.depthFunc=u.useReverseDepthBuffer?518:515,this.disableDepthWrite||(o.setBool("alphaTest",!0),u.setColorWrite(!1),u.enableEffect(h),this._useInstancing?u.drawArraysType(7,0,4,f):u.drawElementsType(0,0,f/4*6),u.enableEffect(n),u.setColorWrite(!0),o.setBool("alphaTest",!1)),u.setAlphaMode(this.blendMode),this._useInstancing?u.drawArraysType(7,0,4,f):u.drawElementsType(0,0,f/4*6),this.autoResetAlpha&&u.setAlphaMode(0),c&&this._scene.getEngine().setState(T,b,!1,!0,void 0,void 0,g),u.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,s,r,n,h){let l=e*this._vertexBufferSize;if(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),s===0?s=this._epsilon:s===1&&(s=1-this._epsilon),h)h(t,r);else{t.cellIndex||(t.cellIndex=0);const o=r.width/this.cellWidth,u=t.cellIndex/o>>0;t._xOffset=(t.cellIndex-u*o)*this.cellWidth/r.width,t._yOffset=u*this.cellHeight/r.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x,this._vertexData[l+1]=t.position.y,this._vertexData[l+2]=t.position.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=i,this._vertexData[l+7]=s),n?this._vertexData[l+8]=t.invertU?0:1:this._vertexData[l+8]=t.invertU?1:0,this._vertexData[l+9]=t.invertV?1:0,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/r.width,this._vertexData[l+13]=t._ySize/r.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}Te.ForceGLSL=!1;C.prototype.updateDynamicIndexBuffer=function(a,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(a);let i;a.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};C.prototype.updateDynamicVertexBuffer=function(a,e,t,i){this.bindArrayBuffer(a),t===void 0&&(t=0);const s=e.byteLength||e.length;i===void 0||i>=s&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e).subarray(0,i/4)):(e instanceof ArrayBuffer?e=new Uint8Array(e,0,i):e=new Uint8Array(e.buffer,e.byteOffset,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e)),this._resetVertexBufferBinding()};const nt="fogVertexDeclaration",$i=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;R.IncludesShadersStore[nt]||(R.IncludesShadersStore[nt]=$i);const at="logDepthDeclaration",ji=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;R.IncludesShadersStore[at]||(R.IncludesShadersStore[at]=ji);const ht="logDepthVertex",qi=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;R.IncludesShadersStore[ht]||(R.IncludesShadersStore[ht]=qi);const Le="spritesVertexShader",At=`attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;R.ShadersStore[Le]||(R.ShadersStore[Le]=At);const Zi={name:Le,shader:At};var Qi=Object.freeze({__proto__:null,spritesVertexShader:Zi});const lt="fogFragmentDeclaration",Ji=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;R.IncludesShadersStore[lt]||(R.IncludesShadersStore[lt]=Ji);const ot="logDepthFragment",es=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;R.IncludesShadersStore[ot]||(R.IncludesShadersStore[ot]=es);const ut="fogFragment",ts=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;R.IncludesShadersStore[ut]||(R.IncludesShadersStore[ut]=ts);const ct="imageProcessingCompatibility",is=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;R.IncludesShadersStore[ct]||(R.IncludesShadersStore[ct]=is);const Oe="spritesPixelShader",Ct=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
vec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}
#endif
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
vec2 uv=uvPixelPerfect(vUV);
#else
vec2 uv=vUV;
#endif
vec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95)
discard;}
color*=vColor;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;R.ShadersStore[Oe]||(R.ShadersStore[Oe]=Ct);const ss={name:Oe,shader:Ct};var rs=Object.freeze({__proto__:null,spritesPixelShader:ss});class ns{_engine;_spritesRenderer;_spritesTexture;_sprites;constructor(e,t){this._engine=e,this._spritesTexture=t,this._sprites=[],this._spritesRenderer=new Te(this._engine,Mi,0),this._spritesRenderer.disableDepthWrite=!0,this._spritesRenderer.autoResetAlpha=!1,this._spritesRenderer.fogEnabled=!1,this._spritesRenderer.texture=this._spritesTexture}addSprite(e){this._sprites.push(e)}ready(){this._sprites=this._sprites.reverse()}render(e,t){this._engine.clear(Li,!0,!1,!1),this._spritesRenderer.render(this._sprites,0,e,t,this._customSpriteUpdate)}dispose(){this._sprites.length=0,this._spritesRenderer.texture=null,this._spritesRenderer.dispose()}_customSpriteUpdate=()=>{}}const as={x:1,y:1},_t={x:0,y:0};class hs{_packer;_unsupportedFeatures;_parentNodes;_rootNodes;_renderingManager;_shape=void 0;constructor(e,t){this._packer=e,this._renderingManager=t,this._unsupportedFeatures=[],this._parentNodes=new Map,this._rootNodes=[]}debug(){if(this._unsupportedFeatures.length===0)console.log("No unsupported features or errors found for this animation.");else{console.log("List of unsupported features or errors found:");for(let e=0;e<this._unsupportedFeatures.length;e++)console.log(this._unsupportedFeatures[e])}}loadFromFile(e){this._unsupportedFeatures.length=0;const t=JSON.parse(e);for(let i=0;i<t.layers.length;i++)this._parseLayer(t.layers[i]);return this._packer.updateAtlasTexture(),this._renderingManager.ready(),this._packer.releaseCanvas(),this._packer=void 0,{startFrame:t.ip,endFrame:t.op,frameRate:t.fr,widthPx:t.w,heightPx:t.h,nodes:this._rootNodes}}_parseLayer(e){if(e.hd===!0)return;if(e.ty!==3&&e.ty!==4){this._unsupportedFeatures.push(`UnsupportedLayerType - Index: ${e.ind} Name: ${e.nm} Type: ${e.ty}`);return}if(e.ind===void 0||e.ip===void 0||e.op===void 0||e.st===void 0){this._unsupportedFeatures.push(`Layer without required values - Name: ${e.nm}`);return}let t;e.parent&&(t=this._parentNodes.get(e.parent),t===void 0&&this._unsupportedFeatures.push(`Parent node with index ${e.parent} not found for layer ${e.nm}`));const i=this._parseTransform(e.ks),s=new Gi(t?`${t.id} - ${e.nm} - ControlNode (TRS)`:`${e.nm} - ControlNode (TRS)`,e.ip,e.op,i.position,i.rotation,i.scale,i.opacity,t);t||this._rootNodes.push(s);const r=new xe(t?`${t.id} - ${e.nm} - Node (Anchor)`:`${e.nm} - Node (Anchor)`,i.anchorPoint,void 0,void 0,void 0,s);if(this._parentNodes.set(e.ind,r),e.shapes&&e.shapes.length>0){const n=this._getScaleFactor(r);this._parseShapes(r,e.shapes,n)}}_parseShapes(e,t,i){for(let s=0;s<t.length;s++)if(t[s].hd!==!0)if(t[s].ty==="gr")this._parseGroupShape(e,t[s],i);else{this._unsupportedFeatures.push(`Only group shapes are supported as children of layers - Name: ${t[s].nm} Type: ${t[s].ty}`);continue}}_parseGroupShape(e,t,i){if(!t.it||t.it.length===0)return;let s;for(let l=0;l<t.it.length;l++)this._shape=t.it[l],this._shape.ty==="gr"?this._unsupportedFeatures.push(`Nested group shapes are not supported. - Group ${t.nm} - Nested Group ${this._shape.nm}`):this._shape.ty==="tr"?s=this._parseTransform(this._shape):this._shape.ty==="sh"?this._validatePathShape(this._shape):this._shape.ty==="rc"?this._validateRectangleShape(this._shape):this._shape.ty==="fl"?this._validateFillShape(this._shape):this._shape.ty==="gf"?this._validateGradientFillShape(this._shape):this._unsupportedFeatures.push(`Unsupported shape type - Name: ${this._shape.nm} Type: ${this._shape.ty}`);if(s===void 0){this._unsupportedFeatures.push(`Group ${t.nm} does not have a transform which is not supported`);return}const r=new xe(`${e.id} - ${t.nm} - ControlNode (TRS)`,s.position,s.rotation,s.scale,s.opacity,e),n=this._packer.addLottieShape(t,i),h=new ki;h._xOffset=n.uOffset,h._yOffset=n.vOffset,h._xSize=n.cellWidth,h._ySize=n.cellHeight,h.width=n.widthPx,h.height=n.heightPx,h.invertV=!0,this._renderingManager.addSprite(h),s.anchorPoint.startValue.x+=n.centerX||0,s.anchorPoint.startValue.y-=n.centerY||0,new Ni(`${e.id} - ${t.nm} - SpriteNode (Anchor)`,h,s.anchorPoint,void 0,void 0,void 0,r)}_parseTransform(e){return{opacity:this._fromLottieScalarToBabylonScalar(e.o,"Opacity",1),rotation:this._fromLottieScalarToBabylonScalar(e.r,"Rotation",0),scale:this._fromLottieVector2ToBabylonVector2(e.s,"Scale",as),position:this._fromLottieVector2ToBabylonVector2(e.p,"Position",_t),anchorPoint:this._fromLottieVector2ToBabylonVector2(e.a,"AnchorPoint",_t)}}_fromLottieScalarToBabylonScalar(e,t,i){if(!e)return{startValue:i,currentValue:i,currentKeyframeIndex:0};if(e.a===0)return{startValue:e.k,currentValue:e.k,currentKeyframeIndex:0};const s=[],r=e.k;let n=0;for(n=0;n<r.length;n++){let l;r[n].o!==void 0&&r[n].i!==void 0&&(Array.isArray(r[n].o.x)?l=new se(r[n].o.x[0],r[n].o.y[0],r[n].i.x[0],r[n].i.y[0]):l=new se(r[n].o.x,r[n].o.y,r[n].i.x,r[n].i.y));let o=r[n].s[0];t==="Rotation"&&(o=o*Math.PI/180),s.push({value:o,time:r[n].t,easeFunction:l})}let h=r[0].s[0];return t==="Rotation"&&(h=h*Math.PI/180),{startValue:h,currentValue:h,keyframes:s,currentKeyframeIndex:0}}_fromLottieVector2ToBabylonVector2(e,t,i){if(!e)return{startValue:i,currentValue:i,currentKeyframeIndex:0};if(e.l!==void 0&&e.l!==2)return this._unsupportedFeatures.push(`Invalid Vector2 Length - Length: ${e.l}`),{startValue:i,currentValue:i,currentKeyframeIndex:0};if(e.a===0){const l=e.k,o=this._calculateFinalVector(l[0],l[1],t);return{startValue:o,currentValue:o,currentKeyframeIndex:0}}const s=[],r=e.k;let n=0;for(n=0;n<r.length;n++){let l;r[n].o!==void 0&&r[n].i!==void 0&&(Array.isArray(r[n].o.x)?l=new se(r[n].o.x[0],r[n].o.y[0],r[n].i.x[0],r[n].i.y[0]):l=new se(r[n].o.x,r[n].o.y,r[n].i.x,r[n].i.y));let o;r[n].o!==void 0&&r[n].i!==void 0&&(Array.isArray(r[n].o.x)?o=new se(r[n].o.x[1],r[n].o.y[1],r[n].i.x[1],r[n].i.y[1]):o=new se(r[n].o.x,r[n].o.y,r[n].i.x,r[n].i.y)),s.push({value:this._calculateFinalVector(r[n].s[0],r[n].s[1],t),time:r[n].t,easeFunction1:l,easeFunction2:o})}const h=this._calculateFinalVector(r[0].s[0],r[0].s[1],t);return{startValue:h,currentValue:{x:h.x,y:h.y},keyframes:s,currentKeyframeIndex:0}}_calculateFinalVector(e,t,i){const s={x:e,y:t};return i==="Position"?s.y=-s.y:i==="AnchorPoint"?s.x=-s.x:i==="Scale"&&(s.x=s.x/100,s.y=s.y/100),s}_getScaleFactor(e){const t={x:e.startScale.x,y:e.startScale.y};for(;e.parent;)e=e.parent,t.x*=e.startScale.x,t.y*=e.startScale.y;return t.x=t.x*it,t.y=t.y*it,t}_validatePathShape(e){e.ks.a===1&&this._unsupportedFeatures.push(`Path ${e.nm} has animated properties which are not supported`)}_validateRectangleShape(e){e.p.a===1&&this._unsupportedFeatures.push(`Rectangle ${e.nm} has an position property that is animated which is not supported`),e.s.a===1&&this._unsupportedFeatures.push(`Rectangle ${e.nm} has a size property that is animated which is not supported`),e.r.a===1&&this._unsupportedFeatures.push(`Rectangle ${e.nm} has a rounded corners property that is animated which is not supported`)}_validateFillShape(e){e.o.a===1&&this._unsupportedFeatures.push(`Fill ${e.nm} has an opacity property that is animated which is not supported`),e.c.a===1&&this._unsupportedFeatures.push(`Fill ${e.nm} has a color property that is animated which is not supported`)}_validateGradientFillShape(e){e.o.a===1&&this._unsupportedFeatures.push(`Gradient fill ${e.nm} has an opacity property that is animated which is not supported`),e.s.a===1&&this._unsupportedFeatures.push(`Gradient fill ${e.nm} has a start point property that is animated which is not supported`),e.e.a===1&&this._unsupportedFeatures.push(`Gradient fill ${e.nm} has an end point property that is animated which is not supported`)}}const ls=2;class os{_canvas;_isReady;_engine;_spritePacker;_parser;_animation;_viewport;_projectionMatrix;_worldMatrix;_frameDuration;_currentFrame;_isPlaying;_animationFrameId;_lastFrameTime;_deltaTime;_loop;_accumulatedTime;_framesToAdvance;_renderingManager;get view(){return this._engine.getRenderingCanvas()}get animationHeight(){return this._animation?this._animation.heightPx:0}get animationWidth(){return this._animation?this._animation.widthPx:0}constructor(e){this._isReady=!1,this._canvas=e,this._currentFrame=0,this._isPlaying=!1,this._animationFrameId=null,this._lastFrameTime=0,this._deltaTime=0,this._accumulatedTime=0,this._framesToAdvance=0,this._loop=!1,this._frameDuration=1e3/30,this._engine=new C(this._canvas,!1,{alpha:!0,stencil:!1,antialias:!1,audioEngine:!1,depth:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,doNotHandleContextLost:!0},!1),this._engine.getCaps().parallelShaderCompile=void 0,this._engine.depthCullingState.depthTest=!1,this._engine.stencilState.stencilTest=!1,this._engine.setAlphaMode(ls),this._spritePacker=new Ui(this._engine),this._renderingManager=new ns(this._engine,this._spritePacker.texture),this._parser=new hs(this._spritePacker,this._renderingManager),this._projectionMatrix=new oe,this._worldMatrix=new oe,this._worldMatrix.identity(),this._viewport=new be(0,0,1,1)}initialize(e){this._animation=this._parser.loadFromFile(e),this._parser=void 0,this.setSize(this._animation.widthPx,this._animation.heightPx),this._frameDuration=1e3/this._animation.frameRate,this._cleanTree(this._animation.nodes),this._isReady=!0}_cleanTree(e){for(let t=0;t<e.length;t++){const i=e[t];if(i.children.length===0&&!i.isShape){e.splice(t,1),t--;continue}this._cleanTree(i.children)}}playAnimation(e=!1){this._animation===void 0||!this._isReady||(this._currentFrame=0,this._accumulatedTime=0,this._framesToAdvance=0,this._isPlaying=!0,this._loop=e,this._lastFrameTime=0,this._startRenderLoop())}stopAnimation(){this._accumulatedTime=0,this._framesToAdvance=0,this._isPlaying=!1,this._animationFrameId!==null&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null)}setSize(e,t){const{_engine:i,_projectionMatrix:s,_worldMatrix:r}=this;i.setSize(e*ie,t*ie),this._canvas.width=e*ie,this._canvas.height=t*ie;const n=r.asArray();n[5]=-1,s.orthoOffCenterLH(0,i.getRenderWidth()/ie,i.getRenderHeight()/ie,0,-100,100)}dispose(){this.stopAnimation(),this._engine.getRenderingCanvas()?.remove(),this._engine.dispose(),this._renderingManager.dispose(),this._spritePacker.texture.dispose()}_startRenderLoop(){this._isPlaying&&(this._animationFrameId=requestAnimationFrame(e=>{this._deltaTime=e-this._lastFrameTime,this._lastFrameTime=e,this._render(),this._lastFrameTime=performance.now(),this._isPlaying&&this._startRenderLoop()}))}_render(){if(!(!this._animation||!this._isPlaying)&&(this._engine.setViewport(this._viewport),this._accumulatedTime+=this._deltaTime,this._framesToAdvance=Math.floor(this._accumulatedTime/this._frameDuration),!(this._framesToAdvance<=0)&&(this._accumulatedTime-=this._framesToAdvance*this._frameDuration,this._currentFrame+=this._framesToAdvance,!(this._currentFrame<this._animation.startFrame)))){if(this._currentFrame>this._animation.endFrame)if(this._loop){this._currentFrame=this._currentFrame%(this._animation.endFrame-this._animation.startFrame)+this._animation.startFrame;for(let e=0;e<this._animation.nodes.length;e++)this._animation.nodes[e].reset()}else{this._isPlaying=!1;return}for(let e=0;e<this._animation.nodes.length;e++)this._animation.nodes[e].update(this._currentFrame);this._renderingManager.render(this._worldMatrix,this._projectionMatrix)}}}let q=null;onmessage=async function(a){if(a.data.canvas){const e=a.data.canvas,t=await(await fetch("/animation-comparison/a1-fre.json")).text();q=new os(e),await q.initialize(t),postMessage({animationWidth:q.animationWidth,animationHeight:q.animationHeight}),q.playAnimation(!0)}else a.data.width&&a.data.height&&q&&q&&q.setSize(a.data.width,a.data.height)};export{W as A,ds as B,F as C,rt as D,P as E,xt as F,ge as G,Qe as H,te as I,Lt as J,Fi as K,bs as L,_s as M,Yt as N,v as O,Ti as P,fs as Q,Rt as R,R as S,Yi as T,x as V,Xe as W,$ as _,d as a,Mt as b,gs as c,S as d,H as e,B as f,Es as g,ee as h,I as i,be as j,ps as k,C as l,cs as m,us as n,Se as o,wi as p,Ei as q,ke as r,xi as s,yt as t,J as u,xs as v,ms as w,O as x,ve as y,di as z};
